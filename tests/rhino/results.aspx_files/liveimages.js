function StateManager(){var m_currentState={};var m_historyPoints={};var m_currentHistoryPoint=null;var m_historyListener=null;var c_listenerInterval=100;this.initialize=function initialize(){m_currentState=this.readStateFromUrl();if(MMUtil.isMozilla()){m_currentHistoryPoint=StateManager.getHash();m_historyListener=setInterval(checkHistoryPoint,100);}else{var date=new Date();m_currentHistoryPoint=date.getTime();m_historyPoints[m_currentHistoryPoint]=m_currentState;}};this.dispose=function dispose(){if(m_historyListener)clearInterval(m_historyListener);m_historyListener=null;};function checkHistoryPoint(){var stateString=StateManager.getHash();if(stateString!=m_currentHistoryPoint)MMUtil.restoreState(stateString);}function setHash(val){var hIndex=location.href.indexOf("#");if(hIndex!=-1)location.href=location.href.substring(0,hIndex+1)+val;else{if(val)location.href=location.href+"#"+val;}}this.getState=function getState(){return m_currentState;};this.readStateFromUrl=function readStateFromUrl(){var hash=StateManager.getHash();var state=StateManager.deserializeParameters(hash);var qParms={};var query=StateManager.getQueryParameters();if(query!=null)qParms=StateManager.deserializeParameters(query);for(var parm in qParms){if(parm=="q"&&state[parm]==null){var q=qParms[parm];var qt=q.split(/ +/);for(var t=0;t<qt.length;t++){if(qt[t].indexOf("imagesize:")==0){var imagesize=qt[t].slice(10);if(imagesize.indexOf("DIM_W_")==0){if(imagesize.slice(6)==screen.width)imagesize="desktop";else imagesize="custom";}else{if(imagesize.indexOf("DIM_H_")==0){if(imagesize.slice(6)==screen.height)imagesize="desktop";else imagesize="custom";}}state["imagesize"]=imagesize;delete qt[t];}}state[parm]=qt.join(" ").replace(/ +$/,"");}if(parm=="imagesize"&&state[parm]==null)state[parm]=qParms[parm];if(parm=="size"&&state["imagesize"]==null){if(qParms[parm]=="1t50")state["imagesize"]="small";else{if(qParms[parm]=="50t400")state["imagesize"]="medium";else{if(qParms[parm]=="400p")state["imagesize"]="large";}}}if(parm=="adlt"&&state[parm]==null)state[parm]=qParms[parm];if(parm=="fed"&&state[parm]==null)state[parm]=qParms[parm];}return state;};this.readStateFromIFrame=function readStateFromIFrame(){var historyDocument=getHistoryDocument();if(historyDocument&&historyDocument.body&&historyDocument.body.innerHTML!="")return StateManager.deserializeParameters(decodeURIComponent(historyDocument.body.innerHTML));else return null;};function getHistoryDocument(){var historyFrame=document.getElementById("historyFrame");if(!historyFrame)return null;var historyDocument=historyFrame.contentWindow.document;if(!historyDocument)return null;return historyDocument;}this.updateState=function updateState(){if(MMUtil.isMozilla())m_currentHistoryPoint=StateManager.serializeParameters(m_currentState);else{var historyDocument=getHistoryDocument();if(historyDocument&&historyDocument.body)historyDocument.body.innerHTML=encodeURIComponent(StateManager.serializeParameters(m_currentState));}setHash(StateManager.serializeParameters(m_currentState));};this.commitState=function commitState(){var nextState={};for(parm in m_currentState){nextState[parm]=m_currentState[parm];}m_currentState=nextState;};this.storeState=function storeState(){this.updateState();var historyDocument;if(MMUtil.isIE()){historyDocument=getHistoryDocument();if(!historyDocument||!historyDocument.body)return;var date=new Date();m_currentHistoryPoint=date.getTime();m_currentState._timestamp=m_currentHistoryPoint;}m_historyPoints[m_currentHistoryPoint]=m_currentState;if(MMUtil.isMozilla())return;var stateString=StateManager.serializeParameters(m_currentState,true);historyDocument.open();historyDocument.write("<html><body onload='if (!window.parent.MMUtil) return;window.parent.MMUtil.restoreState (document.body.innerText);'>"+stateString+"</body></html>");historyDocument.close();};this.restoreState=function restoreState(stateString){var state;if(MMUtil.isMozilla()){state=this.readStateFromUrl();if(m_currentHistoryPoint==stateString)return false;m_currentHistoryPoint=stateString;}else{state=StateManager.deserializeParameters(stateString);if(m_currentHistoryPoint==state._timestamp)return false;m_currentHistoryPoint=state._timestamp;}if(m_historyPoints[m_currentHistoryPoint])m_currentState=m_historyPoints[m_currentHistoryPoint];else m_currentState=state;if(!MMUtil.isMozilla())setHash(StateManager.serializeParameters(m_currentState));return true;};}StateManager.getHash=function getHash(){var hIndex=location.href.indexOf("#");if(hIndex!=-1)return location.href.substring(hIndex+1);else return null;};StateManager.getQueryParameters=function getQueryParameters(url){if(!url)url=location.href;var qIndex=url.indexOf("?");var hIndex=url.indexOf("#");if(qIndex!=-1){if(hIndex!=-1)return url.substring(qIndex+1,hIndex);else return url.substring(qIndex+1);}else return null;};StateManager.deserializeParameters=function deserializeParameters(val){if(val==null)return {};var params={};var input=val.replace(/\+/g,"%20");var pairs=input.split("&");for(var p=0;p<pairs.length;p++){var pair=pairs[p].split("=");try{var key_encoded=pair[0];var value_encoded=pair[1];var key=decodeURIComponent(key_encoded);var value=decodeURIComponent(value_encoded);if(key=="q"||MMUtil.isGoodString(key_encoded)&&MMUtil.isGoodString(value_encoded)&&MMUtil.isGoodString(key)&&MMUtil.isGoodString(value))params[key]=value;}catch(URIError){continue;}}return params;};StateManager.serializeParameters=function serializeParameters(obj,includeHidden){var str="";for(key in obj){if(!includeHidden&&key.charAt(0)=="_")continue;if(!includeHidden&&key=="q")continue;if(key=="fi"&&obj[key]!="true")continue;if(obj[key]==null)continue;if(str!="")str+="&";str+=encodeURIComponent(key)+"="+encodeURIComponent(obj[key]);}return str;};AdultMarkDialog=function(){var me=this;var m_visible=false;var m_murl=null;var m_purl=null;var m_domain=null;var m_hash=null;var m_turl=null;var m_element=null;var m_img=null;var m_container=null;var m_form=null;var m_murlCheckLink=null;var m_purlCheckLink=null;var m_domainCheckLink=null;var m_purlCheckBox=null;var m_murlCheckBox=null;var m_domainCheckBox=null;var m_thumbnail=null;this.initialize=function(){m_element=MMUtil.createElement("adult_mark_element",null,"div");m_img=MMUtil.createElement("submit_img",m_element,"img");m_img.style.visibility="hidden";m_container=MMUtil.createElement("adult_mark_dialog",m_element);m_container.className="dialog";var title=MMUtil.createElement("adult_title",m_container);title.innerHTML="<b>"+L_AdultMSInternal_Text+"</b>";var message=MMUtil.createElement("adult_message",m_container);var span=MMUtil.createElement("adult_message_dialog",message,"span");MMUtil.setText(span,L_AdultMSInternalExplanation_Text);span.style.marginRight="3px";function disable(e){me.hide();if(e&&e.preventDefault)e.preventDefault();MMUtil.writePreference("adultmark","off");MMUtil.adultMarkHost=null;return false;}var disableLink=MMUtil.createElement("adult_disable_link",message,"a");disableLink.href="#";MMUtil.setText(disableLink,L_AdultClickHere_Text);MMUtil.addListener(disableLink,"click",disable);span=MMUtil.createElement("adult_message_disable",message,"span");MMUtil.setText(span,L_AdultReenableMessage_Text);m_thumbnail=MMUtil.createElement("adult_mark_thumbnail",m_container,"img");m_form=MMUtil.createElement("adult_mark_form",m_container,"form");var imageCheckDiv=MMUtil.createElement("mark_adult_img_div",m_form,"div");m_murlCheckBox=document.createElement("input");m_murlCheckBox.type="checkbox";m_murlCheckBox.name="image";imageCheckDiv.appendChild(m_murlCheckBox);span=MMUtil.createElement("murl_check_mark",imageCheckDiv,"span");MMUtil.setText(span,L_AdultMarkButton_Text);span.style.marginRight="3px";m_murlCheckLink=MMUtil.createElement("murl_check_link",imageCheckDiv,"a");m_murlCheckLink.target="_blank";m_murlCheckLink.href="#";MMUtil.setText(m_murlCheckLink,L_AdultMurlCheckImage_Text);span=MMUtil.createElement("murl_check_adult",imageCheckDiv,"span");MMUtil.setText(span,L_AdultAsAdult_Text);span.style.marginLeft="3px";var pageCheckDiv=MMUtil.createElement("mark_adult_page_div",m_form,"div");m_purlCheckBox=document.createElement("input");m_purlCheckBox.type="checkbox";m_purlCheckBox.name="page";pageCheckDiv.appendChild(m_purlCheckBox);span=MMUtil.createElement("page_check_mark",pageCheckDiv,"span");MMUtil.setText(span,L_AdultMarkButton_Text);span.style.marginRight="3px";m_pageCheckLink=MMUtil.createElement("page_check_link",pageCheckDiv,"a");m_pageCheckLink.target="_blank";m_pageCheckLink.href="#";MMUtil.setText(m_pageCheckLink,L_AdultMurlCheckPage_Text);span=MMUtil.createElement("page_check_adult",pageCheckDiv,"span");MMUtil.setText(span,L_AdultAsAdult_Text);span.style.marginLeft="3px";var domainCheckDiv=MMUtil.createElement("mark_adult_domain_div",m_form,"div");m_domainCheckBox=document.createElement("input");m_domainCheckBox.type="checkbox";m_domainCheckBox.name="domain";domainCheckDiv.appendChild(m_domainCheckBox);span=MMUtil.createElement("domain_check_mark",domainCheckDiv,"span");MMUtil.setText(span,L_AdultMarkButton_Text);span.style.marginRight="3px";m_domainCheckLink=MMUtil.createElement("domain_check_link",domainCheckDiv,"a");m_domainCheckLink.target="_blank";m_domainCheckLink.href="#";MMUtil.setText(m_domainCheckLink,L_AdultMurlCheckDomain_Text);span=MMUtil.createElement("domain_check_adult",domainCheckDiv,"span");MMUtil.setText(span,L_AdultAsAdult_Text);span.style.marginLeft="3px";var commentsDiv=MMUtil.createElement("mark_adult_comments_div",m_form,"div");commentsDiv.innerHTML="<div>comments (optional):</div><div><textarea name='comments' rows='3' cols='40' style='overflow:auto;'></textarea></div>";var buttonsDiv=MMUtil.createElement("mark_adult_buttons",m_form,"div");buttonsDiv.innerHTML="<input type='button' name='submit' value='submit'><input type='button' name='cancel' value='cancel'>";function submit(e){m_img.src=MMUtil.adultMarkHost+"?query="+MMUtil.query.parameters.getFullQueryString()+"&murl="+encodeURIComponent(m_murl)+"&mia="+m_murlCheckBox.status+"&purl="+encodeURIComponent(m_purl)+"&pia="+m_purlCheckBox.status+"&domain="+encodeURIComponent(m_domain)+"&dia="+m_domainCheckBox.status+"&comments="+encodeURIComponent(m_form.comments.value)+"&hash="+encodeURIComponent(m_hash)+"&thumburl="+encodeURIComponent(m_turl);me.hide();if(e&&e.preventDefault)e.preventDefault();return false;}MMUtil.addListener(m_form.submit,"click",submit);function cancel(e){me.hide();if(e&&e.preventDefault)e.preventDefault();return false;}MMUtil.addListener(m_form.cancel,"click",cancel);};this.dispose=function dispose(){m_element=m_img=m_container=m_form=m_murlCheckLink=m_purlCheckLink=null;m_domainCheckLink=m_purlCheckBox=m_murlCheckBox=m_domainCheckBox=m_thumbnail=null;};this.display=function display(murl,purl,thumbnail,hash){m_hash=hash;m_murl=murl;m_purl=purl;m_turl=thumbnail;m_pageCheckLink.href=m_purl;m_pageCheckLink.title=m_purl;m_thumbnail.src=thumbnail;m_murlCheckLink.href=m_murl;m_murlCheckLink.title=m_murl;var index=purl.indexOf("//");if(index!=-1)index=purl.indexOf("/",index+2);if(index!=-1)m_domain=purl.substr(0,index);else m_domain="";m_domainCheckLink.href=m_domain;m_domainCheckLink.title=m_domain;if(!m_visible){m_element.style.display="block";m_visible=true;}m_murlCheckBox.status=true;m_purlCheckBox.status=false;m_domainCheckBox.status=false;m_form.comments.value="";m_form.submit.focus();};this.hide=function(){if(m_visible){m_element.style.display="none";m_visible=false;m_thumbnail.src="";}};this.getElement=function(){return m_element;};};LiveMM={};LiveMM.extend=function extend(subClass,baseClass){function inheritance(){}inheritance.prototype=baseClass.prototype;subClass.prototype=new inheritance();subClass.prototype.constructor=subClass;subClass.baseConstructor=baseClass;subClass.parentClass=baseClass.prototype;};var adultStaticSettingMarkets=new Array("de-de","en-id","en-in","en-my","en-sg","en-xa","ko-kr","zh-cn");MultimediaUtilities=function(p_mmSearch,element){var me=this;var m_multimediaSearch=p_mmSearch;var m_stateManager=null;this.listeners=[];this.resultItems=[];this.element=element;this.hostPath="";this.query=null;this.focusedItem=null;var m_logWindow=null;var m_logWindowLoaded=false;var m_logBuffer=new Array();var m_logFlushTimer=null;var m_logWindowUrl="";var m_mediaPlayerObject=null;var m_playStateChangeCallback=null;var m_browserName="";var m_browserVerison="";var m_browserSupportsInnerText=false;var m_preferences=null;var m_searchForm=null;var m_bodyMinWidth=720;this.m_liveInitialized=false;this.xmlFormatString="results.aspx?q=%query%&first=%first%&count=%count%&format=xml&schema=1.1&type=images";this.xmlIntlFormatString="results-intl.aspx?q=%query%&first=%first%&count=%count%&format=xml&schema=1.1&type=images";this.htmlFormatString="/images/results.aspx?q=%query%&FORM=%form%";this.scratchpad;this.names=[];this.scope="";var c_cookieExpiration=30;var c_cookiePath="/images";var c_maxQueryLength=200;var c_persistentKeys={"fi":1,"log":1,"proxy":1,"hostPath":1,"imagesize":1,"_timestamp":1,"kb":1,"hc":1,"hcs":1,"adlt":1,"fed":1};var m_logLevel=null;this.market=null;this.isLiveMarket=false;this.enableScratchpad=false;this.lang=null;this.isAdultStaticSettingMarket=false;this.m_adultDialog=null;this.initialize=function initialize(){readBrowserName();if(!document.getElementsByTagName("body")[0].innerText)m_browserSupportsInnerText=false;else m_browserSupportsInnerText=true;m_stateManager=new StateManager();m_stateManager.initialize();m_logLevel=this.getState().log;m_preferences=new Object();this.log("debug","Initializing MMUtil for "+this.scope+" scope");m_searchForm=document.getElementById("searchform");if(m_searchForm!=null){m_searchForm.action="";m_searchForm.onsubmit=MMUtil.onSubmit;}this.market="en-us";if(MMFEXParams&&MMFEXParams.market)this.market=MMFEXParams.market.toLowerCase();this.lang="en-us";if(MMFEXParams&&MMFEXParams.lang)this.lang=MMFEXParams.lang.toLowerCase();if(MMFEXParams&&MMFEXParams.hostPath)this.hostPath=MMFEXParams.hostPath;if(this.getState().hostPath){this.hostPath=decodeURIComponent(this.getState().hostPath);c_cookiePath="/";}if(this.market.match(/de-ch/)||this.market.match(/fr-ch/))this.thousandsSeparator="'";else{if(this.market.match(/nl-nl/)||this.market.match(/nl-be/)||this.market.match(/de-de/)||this.market.match(/de-at/)||this.market.match(/fr-be/)||this.market.match(/pt-br/)||this.market.match(/pt-pt/)||this.market.match(/it-it/)||this.market.match(/tr-tr/)||this.market.match(/da-dk/)||this.market.match(/es-es/)||this.market.match(/es-ar/)||this.market.match(/es-cl/)||this.market.match(/sr-/)||this.market.match(/is-is/)||this.market.match(/gl-es/)||this.market.match(/hr-/)||this.market.match(/el-gr/)||this.market.match(/eu-es/)||this.market.match(/lt-lt/)||this.market.match(/ro-ro/))this.thousandsSeparator=".";else{if(this.market.match(/fr-ca/)||this.market.match(/fr-fr/)||this.market.match(/fi-fi/)||this.market.match(/sv-se/)||this.market.match(/nb-no/)||this.market.match(/et-ee/)||this.market.match(/pl-pl/)||this.market.match(/uk-ua/)||this.market.match(/hu-hu/)||this.market.match(/nn-no/)||this.market.match(/bg-bg/)||this.market.match(/ru-ru/)||this.market.match(/cs-cz/)||this.market.match(/nb-no/))this.thousandsSeparator=" ";else this.thousandsSeparator=",";}}this.isLiveMarket=MMFEXParams.isLiveMarket;this.enableScratchpad=MMUtil.isLiveMarket&&MMFEXParams.enableScratchpad;for(var i in adultStaticSettingMarkets){if(adultStaticSettingMarkets[i]==this.market){this.isAdultStaticSettingMarket=true;break;}}this.readAdultMarkSettings();this.setFeedbackUrl();function bodyLoad(){MMUtil.setFeedbackUrl();MMUtil.initializeLive();var qb=document.getElementById("q");qb.value=qb.value.replace(/imagesize:\w+/,"");window.onload=null;}window.onload=bodyLoad;window.MMUtil=this;};this.dispose=function dispose(){if(this.m_adultDialog)this.m_adultDialog.dispose();m_stateManager.dispose();MMUtil.removeAllListeners();while(MMUtil.resultItems.length){MMUtil.resultItems.pop().dispose();}if(this.query)this.query.dispose();this.query=null;MMUtil.getState=null;MMUtil.commitState=null;MMUtil.storeState=null;MMUtil.updateState=null;MMUtil.record=null;if(m_logFlushTimer)clearInterval(m_logFlushTimer);p_mmSearch=element=m_logFlushTimer=m_logWindow=null;if(m_searchForm!=null)m_searchForm.onsubmit=null;};this.redirectOldPermalink=function redirectOldPermalink(){var url=location.href;if(url.match(/#.*q=/)&&!url.match(/redirected=true/)){var path=url.replace(/[#\?].*/,"");var appendage=url.replace(path,"");url.search(/#.*(&?q=[^&]*)/);var query=RegExp.lastParen;appendage=appendage.replace(query,"");query=query.replace(/q=/,"");appendage=appendage.replace(/&?q=[^#&]*/,"");appendage=appendage.replace(/&?scope=images/,"");appendage=appendage.replace(/^\?/,"&");appendage=appendage.replace(/#+&*/,"#");appendage=appendage.replace(/&+/,"&");if(appendage.match(/#/)&&!appendage.match(/[#&]$/))appendage+="&";else{if(!appendage.match(/#$/))appendage+="#";}appendage+="redirected=true";MMUtil.issueQuery(query,appendage);}};this.isGoodString=function isGoodString(string){if(string.indexOf("'")!=-1||string.indexOf("\"")!=-1||string.indexOf("<")!=-1||string.indexOf(">")!=-1)return false;return true;};this.createElement=function createElement(id,parentElement,type,className){if(id){var el=document.getElementById(id);if(el)return el;}if(!type)type="div";var el=document.createElement(type);if(id)el.id=id;if(className)el.className=className;if(parentElement)parentElement.appendChild(el);if(type=="a")el.href="#";return el;};this.pageElements=[];this.createPageElement=function createPageElement(id,parentElement,type,className){var el=this.createElement(id,parentElement,type,className);this.pageElements.push(el);return el;};this.stealFocus=function stealFocus(){if(MMUtil.windowFocused)element.focus();};this.getMMSearchInstance=function getMMSearchInstance(){return m_multimediaSearch;};this.truncateQuery=function truncateQuery(query){if(query.length>c_maxQueryLength){query=MMUtil.getState().q.substr(0,c_maxQueryLength);var lastSpace=query.lastIndexOf(" ");if(lastSpace>0)query=query.substring(0,lastSpace);}return query;};this.onSubmit=function onSubmit(e){var query=MMUtil.truncateQuery(m_searchForm!=null?m_searchForm.q.value:"");me.issueQuery(query,null,"QB");return false;};this.getQueryUrl=function getQueryUrl(format,query,imageSize,first,count,formCode){var str=format;if(MMUtil.isLiveMarket){if(imageSize){if(imageSize=="desktop"||imageSize.indexOf("x")!=-1){var width;var height;if(imageSize=="desktop"){width=screen.width;height=screen.height;}else{var dimensions=imageSize.split("x");width=dimensions[0];height=dimensions[1];}query+=" imagesize:DIM_W_"+width;query+=" imagesize:DIM_H_"+height;}else{if(imageSize!="all")query+=" imagesize:"+imageSize;}}if(MMUtil.getState().hc!=null)str+="&hc="+MMUtil.getState().hc;if(MMUtil.getState().hcs!=null)str+="&hcs="+MMUtil.getState().hcs;if(MMUtil.getState().fed!=null)str+="&fed="+MMUtil.getState().fed;}else{if(imageSize=="small")str+="&size=1t50";else{if(imageSize=="medium")str+="&size=50t400";else{if(imageSize=="large")str+="&size=400p";}}}str=str.replace(/%query%/,encodeURIComponent(query));str=str.replace(/%first%/,first);str=str.replace(/%count%/,count);str=str.replace(/%form%/,formCode);str=MMUtil.hostPath+str;if(MMUtil.appendage)str+=MMUtil.appendage;return str;};this.getXMLUrl=function getXMLUrl(query,imageSize,first,count,adlt){var formatString=this.xmlFormatString;if(!MMUtil.isLiveMarket)formatString=this.xmlIntlFormatString;var str=this.getQueryUrl(formatString,query,imageSize,first,count);if(adlt)str+="&adlt="+adlt;else{if(MMUtil.getAdultPreference()=="strict")str+="&adlt=demote";else str+="&adlt="+MMUtil.getAdultPreference();}str+="&mkt="+MMUtil.market;if(MMUtil.getState().proxy)str=MMUtil.proxyName+encodeURIComponent(url);return str;};this.getHTMLUrl=function getHTMLUrl(query,imageSize,formCodePrefix){var formCode=formCodePrefix;if(MMUtil.getState()._page=="noresults")formCode+="IX";else formCode+="IR";var str=this.getQueryUrl(this.htmlFormatString,query,imageSize,null,null,formCode);if(!MMUtil.isLiveMarket)str+="&mkt="+MMUtil.market;if(MMUtil.getState().proxy)str=MMUtil.proxyName+encodeURIComponent(url);return str;};this.issueQuery=function issueQuery(query,appendage,formCode){MMUtil.navigateToUrl(MMUtil.getHTMLUrl(query,"",formCode));};this.navigateToUrl=function navigateToUrl(url){window.location=url;};this.getState=function getState(){return m_stateManager.getState();};this.clearState=function clearState(){var state=this.getState();for(var p in state){if(!c_persistentKeys[p])delete state[p];}};this.restoreState=function restoreState(stateString){if(!m_stateManager)return;if(!m_stateManager.restoreState(stateString))return;m_multimediaSearch.onStateChange();};this.storeState=function storeState(id,parms){m_stateManager.storeState();};this.commitState=function commitState(){var state=m_stateManager.readStateFromIFrame();if(!state){m_stateManager.commitState();m_stateManager.storeState();}m_stateManager.commitState();};this.updateState=function updateState(addFFHistoryPoint){m_stateManager.updateState(addFFHistoryPoint);};this.serializeArray=function serializeArray(array){var string="";for(var p in array){string+=encodeURIComponent(p)+"="+encodeURIComponent(array[p])+"&";}return string;};this.deserializeArray=function deserializeArray(string){var properties={};var props=string.split("&");for(var i=0;i<props.length;i++){var prop=props[i].split("=");var name=decodeURIComponent(prop[0]);var value=decodeURIComponent(prop[1]);properties[name]=value;}return properties;};this.writePreference=function writePreference(name,value){var date=new Date();date.setTime(date.getTime()+c_cookieExpiration*24*60*60*1000);var expires="; expires="+date.toGMTString();var path="; path="+c_cookiePath;document.cookie=name+"="+value+expires+path;};this.readPreference=function readPreference(name){var nameEQ=name+"=";var cookiesplit=document.cookie.split(";");var val=null;for(var i=0;i<cookiesplit.length;i++){var cookie=cookiesplit[i];while(cookie.charAt(0)==" "){cookie=cookie.substring(1,cookie.length);}if(cookie.indexOf(nameEQ)==0)val=cookie.substring(nameEQ.length,cookie.length);}return val;};this.setPreference=function setPreference(key,value){if(m_preferences[key]==value)return;m_preferences[key]=value;this.writePreference(key,value);};this.getPreference=function getPreference(key){return m_preferences[key];};this.initializePreferences=function initializePreferences(defaults){if(!defaults)return;for(var p in defaults){m_preferences[p]=this.readPreference(p);if(!m_preferences[p]){m_preferences[p]=defaults[p];this.writePreference(p,m_preferences[p]);}}if(MMUtil.getState().proxy)MMUtil.proxyName="results.aspx?";};this.record=function record(category,action,parameters){return;};this.setClass=function setClass(element,appendage){element.className=element.id+"_"+appendage;};this.addListener=function addListener(el,evt,method,noStore){if(el.addEventListener)el.addEventListener(evt,method,false);else{if(el.attachEvent)el.attachEvent("on"+evt,method);}if(!noStore)MMUtil.listeners.push({"el":el,"evt":evt,"method":method});};this.removeListener=function removeListener(el,evt,method){if(el.removeEventListener)el.removeEventListener(evt,method,false);else{if(el.detachEvent)el.detachEvent("on"+evt,method);}};this.removeAllListeners=function removeAllListeners(){while(this.listeners.length>0){var l=this.listeners.pop();MMUtil.removeListener(l.el,l.evt,l.method);}};this.setText=function setText(el,string){if(!(el&&string))return;if(m_browserSupportsInnerText)el.innerText=string;else el.textContent=string;};this.getText=function getText(el,string){if(!el)return;if(m_browserSupportsInnerText)return el.innerText;else return el.textContent;};this.setAlt=function setText(el,string){if(!(el&&string))return;if(el.tagName.toLowerCase()=="img")el.alt=string;el.title=string;};this.validateMouseOut=function validateMouseOut(layer,e){var target=MMUtil.getSrcElement(e);var rel=e.relatedTarget?e.relatedTarget:e.toElement;if(!rel)return true;while(rel&&rel!=layer&&rel.nodeName&&rel.nodeName!="BODY"){rel=MMUtil.getParentElement(rel);}return rel!=layer;};this.getKey=function getKey(e){if(e.charCode)return e.charCode;else{if(e.keyCode)return e.keyCode;}return null;};this.isRightClick=function isRightClick(e){if(MMUtil.isMozilla()){if(e.which==3)return true;}else{if(e.button==2)return true;}return false;};this.getSrcElement=function getSrcElement(e){if(!e)e=window.event;if(e.srcElement)return e.srcElement;else{if(e.target)return e.target;}return null;};this.getXMLNodeText=function getXMLNodeText(node){if(MMUtil.isIE())return node.text;else return node.textContent;return null;};this.getParentElement=function getParentElement(el){if(el.parentElement)return el.parentElement;else{if(el.parentNode)return el.parentNode;}return null;};this.getGlobalOffset=function getGlobalOffset(element,type){if(!element||element.nodeName=="BODY")return 0;else return element[type]+MMUtil.getGlobalOffset(MMUtil.getParentElement(element),type);};this.getMousePosition=function getMousePosition(e){var coords={};if(MMUtil.isMozilla()){coords.x=e.pageX;coords.y=e.pageY;}else{coords.x=e.clientX+document.body.scrollLeft;coords.y=e.clientY+document.body.scrollTop;}return coords;};this.getWindowHeight=function getWindowHeight(){if(MMUtil.isIE())return document.documentElement.clientHeight;else return window.innerHeight;};this.getWindowWidth=function getWindowWidth(){if(MMUtil.isIE())return document.documentElement.clientWidth;else return window.innerWidth;};this.getAppHeight=function getAppHeight(){var footerHeight=21;var footer=document.getElementById("footer");if(footer==null)footer=document.getElementById("sw_foot");if(footer!=null)footerHeight=footer.offsetHeight+2;var height=MMUtil.getWindowHeight()-element.offsetTop-footerHeight;MMUtil.appHeight=height<200?200:height;return MMUtil.appHeight;};this.getAppWidth=function getAppWidth(){var width=MMUtil.getWindowWidth();if(width<=m_bodyMinWidth){MMUtil.appWidth=m_bodyMinWidth;document.body.style.width=m_bodyMinWidth+"px";}else{if(MMUtil.appWidth==m_bodyMinWidth)document.body.style.width="auto";MMUtil.appWidth=width;}return MMUtil.appWidth;};this.getDateWithMsec=function getDateWithMsec(){var now=new Date();var mins=now.getMinutes();if(mins<10)mins="0"+mins;var secs=now.getSeconds();if(secs<10)secs="0"+secs;var msecs=now.getMilliseconds();if(msecs<10)msecs="00"+msecs;else{if(msecs<100)msecs="0"+msecs;}return now.getMonth()+1+"/"+now.getDate()+"/"+now.getYear()+" "+now.getHours()+":"+mins+":"+secs+"."+msecs;};this.flushLog=function flushLog(){if(!m_logWindow||!m_logWindowLoaded||m_logWindow.closed)return false;if(m_logBuffer.length<=0){clearInterval(m_logFlushTimer);m_logFlushTimer=null;return false;}m_logWindow.document.write(m_logBuffer.join("<br>"));m_logBuffer=[];return true;};this.log=function log(type,message,flush){if(!m_logLevel)return;var types=type.split(",");var printlog=false;if(m_logLevel=="all")printlog=true;else for(var i=0;i<types.length;i++){if(m_logLevel.indexOf(types[i])!=-1)printlog=true;}if(!printlog)return;if(!m_logWindow||m_logWindow.closed){m_logWindowLoaded=false;m_logWindow=window.open(m_logWindowUrl,"logwindow","width=800,height=600,menubar=0,toolbar=0,status=0,resizable=1,scrollbars=1");var logWindowLoadTimer=setTimeout(function(){m_logWindowLoaded=true;MMUtil.flushLog();},1000);}m_logBuffer.push(this.getDateWithMsec()+" <"+type+"> "+message);if(flush)this.flushLog();if(m_logFlushTimer==null)m_logFlushTimer=setInterval(this.flushLog,1000);};this.doGPing=function doGPing(url){if(url==null||url=="")return;_img=new Image();_img.src=url;return;};this.setAction=function setAction(action,control){var state=MMUtil.getState();if(state._currentAction==action&&state._control==control)return;if(state._currentAction)state._lastAction=state._currentAction;state._currentAction=action;if(control)state._control=control;else delete state._control;};this.setOpacity=function setOpacity(element,val){if(MMUtil.isIE())element.style.filter="alpha(opacity="+val+")";else element.style.opacity=val/100;};function readBrowserName(){var agent=navigator.userAgent.toLowerCase();var agentSplit;m_browserName="MSIE";m_browserVersion="6.0";if(agent.match(/msie/)){m_browserName="MSIE";agentSplit=agent.split(";");m_browserVersion=agentSplit[1].slice(6);}else{if(agent.match(/firefox/)){m_browserName="Firefox";agentSplit=agent.lastIndexOf("firefox");m_browserVersion=agent.slice(agentSplit+8);}else{if(agent.match(/netscape/)){m_browserName="Netscape";agentSplit=agent.lastIndexOf("netscape");m_browserVersion=agent.slice(agentSplit+9);}else{if(agent.match(/safari/)){m_browserName="Safari";agentSplit=agent.lastIndexOf("safari");m_browserVersion=agent.slice(agentSplit+7);}else{if(agent.match(/opera/)){m_browserName="Opera";agentSplit=agent.lastIndexOf("opera");m_browserVersion=agent.slice(agentSplit+6);}else{if(agent.match(/Mozilla\/5.0/)){m_browserName="Mozilla";agentSplit=agent.lastIndexOf("mozilla");m_browserVersion=agent.slice(agentSplit+8);}}}}}}}this.isIE=function isIE(){return m_browserName=="MSIE";};this.isIE7=function isIE7(){if(m_browserName=="MSIE"&&m_browserVersion.match(/^7/))return true;return false;};this.isMozilla=function isMozilla(){if(m_browserName=="Mozilla"||m_browserName=="Firefox"||m_browserName=="Netscape")return true;return false;};this.getAdultPreference=function(){document.cookie.search(/ADLT=([^&;]*)/);if(RegExp.lastParen)return RegExp.lastParen.toLowerCase();else return "demote";};this.assert=function assert(test,message){if(!test)throw new Error("Assertion failed: "+message);};this.loadScript=function loadScript(url,callback){var el=document.createElement("script");document.body.appendChild(el);function runCallback(){if(el.readyState!="loaded")return;if(callback){callback();callback=null;}el.onreadystatechange=null;}function runCallbackFF(){if(callback){callback();callback=null;}el.onload=null;}if(MMUtil.isIE())el.onreadystatechange=runCallback;else el.onload=runCallbackFF;el.src=url;};this.initializeLive=function initializeLive(){if(this.m_liveInitialized)return;this.m_liveInitialized=true;if(window.lb)lb();var footer=document.getElementById("footer");if(footer!=null){var copyrightDiv=document.createElement("div");copyrightDiv.className="footer_center";MMUtil.setText(copyrightDiv,L_copyright_Text);footer.appendChild(copyrightDiv);}else{footer=document.getElementById("sw_footL");if(footer!=null){footer.lastChild.innerHTML=footer.lastChild.innerHTML+" | ";var copyright=document.createElement("li");copyright.className="sw_footC";MMUtil.setText(copyright,L_copyright_Text);footer.appendChild(copyright);}}};this.getFeedbackUrl=function getFeedbackUrl(imageFeedback){if(imageFeedback)type="dsatsingleliveimage";else type="dsatliveimage";var url="https://feedback.live.com/default.aspx?productkey=wlsearchimage";url+="&locale="+MMUtil.market;url+="&P1="+type;var query=MMUtil.getState().q?MMUtil.getState().q:"";url+="&P2="+encodeURIComponent(query);url+="&P3="+MMFEXParams.flight+"&P4="+MMFEXParams.form+"&P5="+MMFEXParams.cid+"&P6="+MMFEXParams.location+"&P7=Original&P8=&P9="+MMFEXParams.latlong+"&P10="+MMFEXParams.drange+"&P11="+MMFEXParams.rf;url+="&P12="+MMFEXParams.CMS+"&searchtype=Image+Search&optl1=1";if(!imageFeedback&&MMUtil.getState().furl)url+="&P13="+encodeURIComponent(MMUtil.getState().furl);url+="&backurl="+encodeURIComponent(location.href);return url;};this.setFeedbackUrl=function setFeedbackUrl(){MMUtil.singleFeedbackUrl=MMUtil.getFeedbackUrl(true);if(document.getElementById("Feedback"))document.getElementById("Feedback").href=MMUtil.getFeedbackUrl();};this.getImageFeedbackUrl=function getImageFeedbackUrl(murl){return MMUtil.singleFeedbackUrl+"&P13="+encodeURIComponent(murl);};this.readAdultMarkSettings=function readAdultMarkSettings(){if(this.readPreference("adultmark")=="off")MMUtil.adultMarkHost=null;else MMUtil.adultMarkHost=MMFEXParams.adultMarkPage;if(MMUtil.adultMarkHost){this.m_adultDialog=new AdultMarkDialog();this.m_adultDialog.initialize();}};};function gebi(id,node){if(node==null)node=document;return node.getElementById(id);}function gebt(tag,node){if(node==null)node=document;return node.getElementsByTagName(tag);}function gebc(cl,node,tag){if(node==null)node=document;if(tag==null)tag="*";var els=new Array();var tags=gebt(tag,node);var tcl=" "+cl+" ";var i;var j;for(i=0,j=0;i<tags.length;i++){var test=" "+tags[i].className+" ";if(test.indexOf(tcl)!=-1)els[j++]=tags[i];}return els;}function animate(callback,duration,after){if(duration==null)duration=1000;var t={};t.start=new Date().getTime();t.end=t.start+duration;t.after=after;t.timerId=setInterval(function(){var now=new Date().getTime();var linearPos=Math.min(1-(t.end-now)/(t.end-t.start),1);var pos=Math.sin(linearPos*(Math.PI/2));callback(pos);if(now>=t.end){clearInterval(t.timerId);if(t.after!=null)t.after();}},16);}function WarningMessage(element,text,linkText){element.className="warning_div";element.style.visibility="hidden";MMUtil.setText(element,text);this.warningArea=document.createElement("div");this.warningArea.className="warning_area";element.appendChild(this.warningArea);this.links=[];var link=document.createElement("span");link.className="warning_link";link.innerText=linkText.shift();this.warningArea.appendChild(link);this.links.push(link);while(linkText.length){var spacer=document.createElement("span");spacer.innerHTML="|";spacer.style.padding="0px 3px";this.warningArea.appendChild(spacer);link=document.createElement("span");link.className="warning_link";link.innerText=linkText.shift();this.warningArea.appendChild(link);this.links.push(link);}}function ComboBox(element){var me=this;var m_boxElement=element;var m_dropDownElement=null;var m_selectedText=null;var m_dropDownButton=null;var m_list=null;var m_visible=true;var m_selectCallback=null;this.initialize=function initialize(selectCallback){m_boxElement.className="combo_box";m_selectCallback=selectCallback;m_selectedText=MMUtil.createElement("combo_box_text",m_boxElement,"a");m_selectedText.className="combo_box_text";m_selectedText.href="#";m_dropDownButton=MMUtil.createElement("combo_box_button",m_boxElement,"img");m_dropDownButton.className="combo_box_button";m_dropDownButton.src="s/live/combobox_button.gif";m_dropDownElement=MMUtil.createElement("combo_box_dropdown",m_boxElement);m_list=new List(m_dropDownElement);m_list.initialize();MMUtil.addListener(m_boxElement,"mouseover",me.showList);MMUtil.addListener(m_boxElement,"mousemove",me.showList);MMUtil.addListener(m_boxElement,"mouseout",me.hideList);MMUtil.addListener(m_dropDownElement,"mouseover",me.showList);MMUtil.addListener(m_dropDownElement,"mousemove",me.showList);MMUtil.addListener(m_dropDownElement,"mouseout",me.hideList);function listClick(e){if(e&&e.preventDefault)e.preventDefault();if(m_visible)me.hideList();else me.showList();return false;}MMUtil.addListener(m_selectedText,"click",listClick);};this.dispose=function dispose(){if(m_list)m_list.dispose();m_selectCallback=null;me=element=m_selectedText=m_dropDownButton=m_dropDownElement=null;};this.createOption=function createOption(name,text,allowHandling){var item=m_list.createItem(name,text,me.listItemSelected,allowHandling);return item;};this.selectItemByName=function selectItemByName(name){var item=m_list.getItemByName(name);me.selectItem(item);};this.setText=function setText(itemName){if(!m_list.getItemByName(itemName))return;MMUtil.setText(m_selectedText,m_list.getItemByName(itemName).getText());me.positionList();me.setWidth();};this.selectItem=function selectItem(item){if(!item)return;me.setText(item.getName());if(m_selectCallback)m_selectCallback(item.getName());me.hideList();};this.listItemSelected=function listItemSelected(e,item){me.selectItem(item);};this.showList=function showList(e){if(e&&e.preventDefault)e.preventDefault();if(!m_visible){me.positionList();m_visible=true;m_dropDownElement.style.height="auto";m_dropDownElement.style.visibility="visible";me.setWidth();}return false;};this.hideList=function hideList(e){if(m_visible){if(e&&!MMUtil.validateMouseOut(m_dropDownElement,e)&&!MMUtil.validateMouseOut(m_boxElement,e))return;m_visible=false;m_dropDownElement.style.height="0px";m_dropDownElement.style.visibility="hidden";}};this.positionList=function positionList(){m_dropDownElement.style.position="absolute";m_dropDownElement.style.top=m_boxElement.offsetHeight-2+"px";};this.setWidth=function setWidth(){m_dropDownElement.style.width="auto";var width=m_dropDownElement.offsetWidth;m_dropDownElement.style.width=width+"px";m_boxElement.style.width=width+"px";};}function List(container){var me=this;var m_container=container;var m_items=Object();this.initialize=function initialize(id){m_container.className="list";if(id)m_container.id=id;};this.dispose=function dispose(){for(var i in m_items){m_items[i].dispose();}me=container=m_container=null;};this.getContainer=function getContainer(){return m_container;};this.createItem=function createItem(name,text,selectCallback,allowHandling){var element=MMUtil.createElement("list_item_"+name,m_container,"a");element.href="#";if(m_items[name])return null;var item=new ListItem(element);item.initialize(name,text,selectCallback,allowHandling);m_items[name]=item;return item;};this.getItemByName=function getItemByName(name){return m_items[name];};this.removeAllItems=function removeAllItems(){for(var name in m_items){var item=m_items[name];m_container.removeChild(item.getContainer());item.dispose();delete m_items[name];}};}function ListItem(container){var me=this;var m_container=container;var m_clickCallback=null;var m_name=null;var m_text=null;var m_textContainer=null;var m_selected=false;var m_currentClass=null;var m_allowHandling=true;this.initialize=function initialize(name,text,clickCallback,allowHandling){m_name=name;m_text=text;m_clickCallback=clickCallback;m_allowHandling=allowHandling==true;this.setClass("list_item");m_container.id=name;m_textContainer=MMUtil.createElement("list_item_text "+name,m_container,"div");m_textContainer.className="list_item_text";MMUtil.setText(m_textContainer,text);m_textContainer.title=text;MMUtil.addListener(m_container,"mouseover",me.mouseOver,true);MMUtil.addListener(m_container,"mousemove",me.mouseOver,true);MMUtil.addListener(m_container,"mouseout",me.mouseOut,true);if(m_clickCallback)MMUtil.addListener(m_container,"click",me.click,true);};this.dispose=function dispose(){MMUtil.removeListener(m_container,"mouseover",me.mouseOver);MMUtil.removeListener(m_container,"mousemove",me.mouseOver);MMUtil.removeListener(m_container,"mouseout",me.mouseOut);MMUtil.removeListener(m_container,"click",me.click);m_clickCallback=null;me=m_container=container=m_textContainer=null;};this.setClass=function setClass(className){if(className!=m_currentClass)m_container.className=className;m_currentClass=className;};this.setHref=function setHref(url){m_container.href=url;};this.getName=function getName(){return m_name;};this.getText=function getText(){return m_text;};this.getContainer=function getContainer(){return m_container;};this.setSelected=function setSelected(selected){m_selected=selected;me.setClass("list_item");};this.mouseOver=function mouseOver(e){me.setClass("list_item_hover");};this.mouseOut=function mouseOut(e){if(!MMUtil.validateMouseOut(m_container,e))return;me.setClass("list_item");};this.click=function click(e){if(!m_allowHandling){if(e.preventDefault)e.preventDefault();}me.setSelected(true);if(m_clickCallback)m_clickCallback(e,me);return m_allowHandling;};}var MMUtil=null;function MultimediaSearch(element){MMUtil=new MultimediaUtilities(this,element);var me=this;this.showMessage=false;var m_messageDiv=null;var m_resultsPanelOuterContainer=null;var m_resultViewOuterContainer=null;var m_sidePanelContainer=null;var m_resultsPanel=null;var m_resultView=null;var m_spellSuggestionContainer=null;var m_spellSuggestionLink=null;var m_allSizesLink=null;var m_sidePanel=null;var m_scratchpadModule=null;var m_relatedPeopleModule=null;var m_relatedEntitiesModule=null;var m_activeViewResultRequest=null;var m_savedStates=null;this.c_welcomeString=L_welcomeImage_Message;function sidePanelUpdate(){me.positionElements(false);m_resultsPanel.redraw();m_resultsPanel.loadResults();}MultimediaSearch.prototype.initialize=function initialize(preferences){MMUtil.initialize();MMUtil.initializePreferences(preferences);MMUtil.redirectOldPermalink();var qb=document.getElementById("q");if(!qb){document.write("Query box not found.");return;}if(!qb.value)qb.focus();m_sidePanelContainer=MMUtil.createPageElement("side_panel_container",element);m_sidePanel=new SidePanel(m_sidePanelContainer);m_sidePanel.initialize(sidePanelUpdate);if(MMUtil.isMozilla())m_sidePanelContainer.style.paddingLeft="8px";m_savedStates={};m_messageDiv=MMUtil.createPageElement("message_div",element);m_resultsPanelOuterContainer=MMUtil.createPageElement("results_control",element);m_resultsPanel=new ResultsPanel(m_resultsPanelOuterContainer,m_messageDiv);m_resultsPanel.initialize(this.closeFullImage,this.imageClick);m_resultViewOuterContainer=MMUtil.createPageElement("result_view_panel",element);m_resultView=this.createResultViewPanel(m_resultViewOuterContainer);m_resultView.initialize(this.backToResults);if(MMUtil.m_adultDialog)element.appendChild(MMUtil.m_adultDialog.getElement());setDims(true);m_relatedPeopleModule=new RelatedPeopleModule();m_relatedPeopleModule.initialize();m_sidePanel.addModule(m_relatedPeopleModule);m_relatedEntitiesModule=new RelatedEntitiesModule();m_relatedEntitiesModule.initialize();m_sidePanel.addModule(m_relatedEntitiesModule);m_spellSuggestionContainer=MMUtil.createElement("spell_suggestion",null,"div");var span=MMUtil.createElement(null,m_spellSuggestionContainer,"span");MMUtil.setText(span,L_spellingSuggestion_Message.replace(/%string%.*/,""));m_spellSuggestionLink=MMUtil.createElement("message_div_query",m_spellSuggestionContainer,"a");span=MMUtil.createElement(null,m_spellSuggestionContainer,"span");MMUtil.setText(span,L_spellingSuggestion_Message.replace(/.*%string%/,""));m_allSizesLink=MMUtil.createElement(null,null,"a","message_div_query");m_scratchpadModule=new ScratchpadModule();m_scratchpadModule.initialize(me.scratchpadImageClick);m_sidePanel.addModule(m_scratchpadModule);MMUtil.addListener(window,"resize",setDims);MMUtil.addListener(element,"mouseenter",MMUtil.stealFocus);MMUtil.addListener(element,"focus",MMUtil.stealFocus);MMUtil.addListener(window,"blur",function(){MMUtil.windowFocused=false;});MMUtil.addListener(window,"focus",function(){MMUtil.windowFocused=true;});if(document.getElementById("scratchpad_toggle"))MMUtil.addListener(document.getElementById("scratchpad_toggle"),"click",this.toggleScratchpad);if(MMUtil.getPreference("scratchpad")==1&&MMUtil.enableScratchpad)me.setModuleStatus("scratchpad","enable",L_scratchpadHide_Text);else me.setModuleStatus("scratchpad","disable",L_scratchpadShow_Text);if(MMUtil.getPreference("relatedpeople")==1)me.setModuleStatus("relatedPeople","enable");else me.setModuleStatus("relatedPeople","disable");if(gebc("re_thumbs").length>0){me.setModuleStatus("relatedEntities","enable");m_relatedEntitiesModule.updateNavText();}this.onStateChange();this.setHrefs();window.onunload=function(){me.dispose();};};MultimediaSearch.prototype.createResultViewPanel=function createResultViewPanel(container){return null;};MultimediaSearch.prototype.getResultViewPanel=function getResultViewPanel(){return m_resultView;};MultimediaSearch.prototype.getSidePanel=function getSidePanel(){return m_sidePanel;};MultimediaSearch.prototype.dispose=function dispose(unload){m_resultsPanel.dispose();m_resultView.dispose();m_sidePanel.dispose();m_scratchpadModule.dispose();m_relatedPeopleModule.dispose();m_relatedEntitiesModule.dispose();MMUtil.dispose();for(prop in me){delete me[prop];}me=element=m_sidePanel=m_messageDiv=m_resultViewOuterContainer=null;m_spellSuggestionContainer=m_resultsPanelOuterContainer=m_sidePanelContainer=null;m_allSizesLink=null;};var m_resizeTimeout=null;function setDims(immediate){var oldHeight=MMUtil.appHeight;var oldWidth=MMUtil.appWidth;MMUtil.getAppHeight();MMUtil.getAppWidth();if(oldHeight==MMUtil.appHeight&&oldWidth==MMUtil.appWidth)return;if(immediate==true){resize();return;}if(m_resizeTimeout)clearTimeout(m_resizeTimeout);function resize(){m_resizeTimeout=null;me.positionElements(true);m_resultsPanel.positionImages();m_resultsPanel.loadResults();}m_resizeTimeout=setTimeout(resize,100);}MultimediaSearch.prototype.determinePage=function determinePage(){var state=MMUtil.getState();state._lastPage=state._page;state._lastPageType=state._pageType;if(state.surl)state._page=state._pageType="sidepanel";else{if(state.q){if(MMUtil.query&&MMUtil.query.error&&!MMUtil.query.xmlRetriesRemaining){state._pageType="message";state._page="error";}else{if(MMUtil.query&&MMUtil.query.resultsReceived&&MMUtil.query.available>0){if(!state.furl)state._page=state._pageType="results";else{if(MMUtil.query.getImageFromHash(state.focal))state._page=state._pageType="view";else{state._page="viewloading";state._pageType="loading";}}}else{if(!MMUtil.query||MMUtil.query.moreResults&&!MMUtil.query.resultsReceived)state._pageType=state._page="loading";else{state._pageType="message";if(MMUtil.query.error)state._page="error";else state._page="noresults";}}}}else{state._page="start";state._pageType="message";}}};MultimediaSearch.prototype.clearMessage=function clearMessage(){MMUtil.setText(m_messageDiv,"");while(m_messageDiv.firstChild){m_messageDiv.removeChild(m_messageDiv.firstChild);}};MultimediaSearch.prototype.showLoadingPage=function showLoadingPage(){var displayQuery="";if(MMUtil.query)displayQuery=MMUtil.query.parameters.getDisplayQuery();var contextMessage=document.createElement("span");var frontBlock=document.createElement("span");var querystringBlock=document.createElement("span");var backBlock=document.createElement("span");var qsloc=L_loadingResults_Message.search(/%querystring%/);var qslen=13;MMUtil.setText(frontBlock,L_loadingResults_Message.substr(0,qsloc));MMUtil.setText(querystringBlock,displayQuery);querystringBlock.style.fontWeight="bold";MMUtil.setText(backBlock,L_loadingResults_Message.substr(qsloc+qslen,L_loadingResults_Message.length-qsloc-qslen));contextMessage.appendChild(frontBlock);contextMessage.appendChild(querystringBlock);contextMessage.appendChild(backBlock);m_resultsPanel.setContextMessage(contextMessage);this.setModuleStatus("relatedPeople","disable");this.setModuleStatus("relatedEntities","disable");if(MMUtil.getState()._page!="viewloading")return;if(m_activeViewResultRequest)return;function viewImageLoadCallback(info,success){if(success)MMUtil.query.injectResult(info);else{delete MMUtil.getState().furl;delete MMUtil.getState().focal;}m_activeViewResultRequest=false;me.updatePage();}m_activeViewResultRequest=true;this.loadImageForUrl(MMUtil.getState().furl,viewImageLoadCallback);};MultimediaSearch.prototype.updateFormCodes=function updateFormCodes(){if(MMUtil.getState()._page=="noresults")var formCode="IX";else return;var regex=/(FORM=..)IR/;var scopebar=document.getElementById("sch_scopes");var anchors;if(scopebar){anchors=scopebar.getElementsByTagName("a");for(var i=0;i<anchors.length;i++){anchors[i].href=anchors[i].href.replace(regex,"$1"+formCode);}}var scopechart=document.getElementById("sch_scopeChartDiv");if(scopechart){anchors=scopechart.getElementsByTagName("a");for(var i=0;i<anchors.length;i++){anchors[i].href=anchors[i].href.replace(regex,"$1"+formCode);}}};MultimediaSearch.prototype.showMessagePage=function showMessagePage(){var displayQuery="";if(MMUtil.query)displayQuery=MMUtil.query.parameters.getDisplayQuery();this.clearMessage();this.showMessage=true;var frontBlock=null;var querystringBlock=null;var backBlock=null;switch(MMUtil.getState()._page){case "noresults":this.clearMessage();if(MMUtil.names&&MMUtil.names.length){m_relatedPeopleModule.setSuggestions(MMUtil.names);this.setModuleStatus("relatedPeople","enable");}else this.setModuleStatus("relatedPeople","disable");if(this.setSpellSuggestion())break;else{if(this.setImageSizeMessage(true))break;}frontBlock=document.createElement("span");m_messageDiv.appendChild(frontBlock);querystringBlock=document.createElement("span");m_messageDiv.appendChild(querystringBlock);backBlock=document.createElement("span");m_messageDiv.appendChild(backBlock);qsloc=L_noResults_Message.search(/%querystring%/);qslen=13;MMUtil.setText(frontBlock,L_noResults_Message.substr(0,qsloc));MMUtil.setText(querystringBlock,displayQuery);querystringBlock.className="message_div_query";MMUtil.setText(backBlock,L_noResults_Message.substr(qsloc+qslen,L_noResults_Message.length-qsloc-qslen));m_resultsPanel.setContextMessage(null);break;case "error":this.clearMessage();if(MMUtil.query.error=="AdultBlock"){if(MMUtil.isAdultStaticSettingMarket){frontBlock=document.createElement("span");MMUtil.setText(frontBlock,L_adultBlock1_Message);m_messageDiv.appendChild(frontBlock);}else{adultBlockCombinedString=L_adultBlock1_Message+L_adultBlock2_Message;frontBlock=document.createElement("span");MMUtil.setText(frontBlock,adultBlockCombinedString.replace(/%startlink%.*/,""));m_messageDiv.appendChild(frontBlock);querystringBlock=document.createElement("a");querystringBlock.href="/settings.aspx?ru="+encodeURIComponent(location.href);var linkText=adultBlockCombinedString.replace(/.*%startlink%(.+)%endlink%.*/,"$1");MMUtil.setText(querystringBlock,linkText);querystringBlock.className="message_div_query";m_messageDiv.appendChild(querystringBlock);backBlock=document.createElement("span");MMUtil.setText(backBlock,adultBlockCombinedString.replace(/.*%endlink%/,""));m_messageDiv.appendChild(backBlock);}m_resultsPanel.setContextMessage(null);}else{if(MMUtil.query.error=="InvalidQuery"){frontBlock=document.createElement("span");m_messageDiv.appendChild(frontBlock);querystringBlock=document.createElement("span");m_messageDiv.appendChild(querystringBlock);backBlock=document.createElement("span");m_messageDiv.appendChild(backBlock);qsloc=L_noResults_Message.search(/%querystring%/);qslen=13;MMUtil.setText(frontBlock,L_noResults_Message.substr(0,qsloc));MMUtil.setText(querystringBlock,displayQuery);querystringBlock.className="message_div_query";MMUtil.setText(backBlock,L_noResults_Message.substr(qsloc+qslen,L_noResults_Message.length-qsloc-qslen));m_resultsPanel.setContextMessage(null);}else{m_resultsPanel.setContextMessage(null);MMUtil.setText(m_messageDiv,L_siteUnavailable_Message);}}break;case "start":this.clearMessage();MMUtil.setText(m_messageDiv,this.c_welcomeString);break;default:}this.updateFormCodes();};MultimediaSearch.prototype.setSpellSuggestion=function setSpellSuggestion(){if(!MMUtil.query.spellSuggestion)return false;if(location.href.toLowerCase().search(/form=ssir/)!=-1)return false;var query=MMUtil.query.spellSuggestion;var reg=/\s*imagesize:[\w]+\s*/;while(query.match(reg)){query=query.replace(reg,"");}this.clearMessage();MMUtil.setText(m_spellSuggestionLink,query);m_spellSuggestionLink.href=MMUtil.getHTMLUrl(query,"","SS");m_messageDiv.appendChild(m_spellSuggestionContainer);this.showMessage=true;return true;};MultimediaSearch.prototype.setHrefs=function setHrefs(){m_resultsPanel.setHrefs();if(MMUtil.query)m_allSizesLink.href=MMUtil.getHTMLUrl(MMUtil.query.parameters.getParameter("queryString"),"all","SZ");};MultimediaSearch.prototype.setImageSizeMessage=function setImageSizeMessage(noresults){var size=MMUtil.getState().imagesize;if(!size||size=="all")return false;this.clearMessage();var message;if(size=="small")message=noresults?L_noSmallImageResults_Message:L_showingSmallImages_Text;else{if(size=="medium")message=noresults?L_noMediumImageResults_Message:L_showingMediumImages_Text;else{if(size=="large")message=noresults?L_noLargeImageResults_Message:L_showingLargeImages_Text;else{if(size=="desktop")message=noresults?L_noDesktopSizeResults_Message:L_showingDesktopSize_Text;else{message=noresults?L_noCustomSizeImageResults_Message:L_showingCustomSizeImages_Text;message=message.replace(/%resolution%/,size);}}}}var allSizesText=L_showAllSizes_Text.replace(/.*%startlink%(.+)%endlink%.*/,"$1");MMUtil.setText(m_allSizesLink,allSizesText);message+=" "+L_showAllSizes_Text.replace(/%startlink%.*/,"");var displayQuery=MMUtil.query.parameters.getDisplayQuery();var qsloc=message.search(/%querystring%/);var qslen=qsloc!=-1?13:1;var frontBlock;var querystringBlock;var backBlock=document.createElement("span");MMUtil.setText(backBlock,message.substr(qsloc+qslen,message.length-qsloc-qslen));if(qsloc!=-1){frontBlock=document.createElement("span");querystringBlock=document.createElement("span");MMUtil.setText(frontBlock,message.substr(0,qsloc));MMUtil.setText(querystringBlock,displayQuery);querystringBlock.className="message_div_query";m_messageDiv.appendChild(frontBlock);m_messageDiv.appendChild(querystringBlock);}m_messageDiv.appendChild(backBlock);m_messageDiv.appendChild(m_allSizesLink);message=L_showAllSizes_Text.replace(/.*%endlink%/,"");var span=document.createElement("span");MMUtil.setText(span,message);m_messageDiv.appendChild(span);this.showMessage=true;return true;};MultimediaSearch.prototype.showResultsPage=function showResultsPage(){if(!this.setSpellSuggestion())this.setImageSizeMessage();if(MMFEXParams.multicolumnresults){for(var modName in m_savedStates){this.setModuleStatus(modName,m_savedStates[modName]?"enable":"disable");}this.alignScratchpadState();}if(MMUtil.names&&MMUtil.names.length){m_relatedPeopleModule.setSuggestions(MMUtil.names);this.setModuleStatus("relatedPeople","enable");}else this.setModuleStatus("relatedPeople","disable");};MultimediaSearch.prototype.showResultViewPage=function showResultViewPage(){var state=MMUtil.getState();var resultItem=MMUtil.query.getImageFromHash(state.focal);m_resultView.setImage(resultItem.properties);m_resultsPanel.setFocalResultItem(resultItem);if(MMFEXParams.multicolumnresults){var modules=m_sidePanel.getModules();for(var modName in modules){var module=modules[modName];m_savedStates[modName]=module.m_enabled;this.setModuleStatus(modName,"disable");}this.alignScratchpadState();}if(MMUtil.names&&MMUtil.names.length){m_relatedPeopleModule.setSuggestions(MMUtil.names);this.setModuleStatus("relatedPeople","enable");}else this.setModuleStatus("relatedPeople","disable");};MultimediaSearch.prototype.showSidepanelPage=function showSidepanelPage(){var state=MMUtil.getState();if(state._mediaProperties){var mp=new MediaProperties();mp.initialize(MMUtil.deserializeArray(state._mediaProperties),m_resultView.setImage);mp.fetch();}else this.loadImageForUrl(state.surl,m_resultView.setImage);};MultimediaSearch.prototype.updatePage=function updatePage(){this.determinePage();for(var e=0;e<MMUtil.pageElements.length;e++){MMUtil.setClass(MMUtil.pageElements[e],MMUtil.getState()._pageType);}m_resultView.clear();this.showMessage=false;switch(MMUtil.getState()._pageType){case "message":this.showMessagePage();break;case "loading":this.showLoadingPage();break;case "results":this.showResultsPage();break;case "view":this.showResultViewPage();break;case "sidepanel":this.showSidepanelPage();break;default:}if(this.showMessage)m_messageDiv.style.display="block";else m_messageDiv.style.display="none";this.positionElements(true);m_resultsPanel.redraw();m_resultsPanel.loadResults();};MultimediaSearch.prototype.positionElements=function positionElements(setHeight){if(setHeight){var height=MMUtil.appHeight-2;element.style.height=height+"px";m_resultsPanel.setHeight(height);m_sidePanel.setHeight(height);}var state=MMUtil.getState();if(state._page=="view"||state._page=="sidepanel")m_resultView.position();if(state._page=="results"){if(state._pivotHash)m_resultsPanel.jumpToPivot();else m_resultsPanel.jumpToOffset(0);}else{if(state._page=="view")m_resultsPanel.centerFocalResultItem();}m_resultsPanel.positionElements();};MultimediaSearch.prototype.setModuleStatus=function setModuleStatus(moduleName,state,buttonText){MMUtil.setPreference(moduleName.toLowerCase(),state=="enable"?"1":"0");var toggle=document.getElementById(moduleName.toLowerCase()+"_toggle");if(toggle)MMUtil.setText(toggle,buttonText);if(state=="enable")m_sidePanel.enableModule(moduleName);else m_sidePanel.disableModule(moduleName);};MultimediaSearch.prototype.toggleScratchpad=function toggleScratchpad(e){if(e&&e.preventDefault)e.preventDefault();var link=document.getElementById("scratchpad_toggle");if(MMUtil.getPreference("scratchpad")=="0"){if(MMFEXParams.multicolumnresults&&MMUtil.getState()._pageType!="results")me.backToResults();me.setModuleStatus("scratchpad","enable",L_scratchpadHide_Text);link.title=L_scratchpadHide_Text;}else{me.setModuleStatus("scratchpad","disable",L_scratchpadShow_Text);link.title=L_scratchpadShow_Text;}return false;};MultimediaSearch.prototype.alignScratchpadState=function alignScratchpadState(){var link=document.getElementById("scratchpad_toggle");link.title=link.innerHTML=m_sidePanel.getModules()["scratchpad"].m_enabled?L_scratchpadHide_Text:L_scratchpadShow_Text;};MultimediaSearch.prototype.closeFullImage=function closeFullImage(control){m_resultView.closeFullImage(control);};MultimediaSearch.prototype.imageClick=function imageClick(resultItem){MMUtil.record("Results","image click",{"murl":resultItem.properties.mediaurl});var mediaProperties=resultItem.properties;var hash=mediaProperties.mediahash;if(hash==MMUtil.getState().focal&&MMUtil.getState()._lastPage=="view")return;MMUtil.commitState();MMUtil.getState().focal=resultItem.properties.mediahash;MMUtil.getState().furl=resultItem.properties.mediaurl;me.updatePage();MMUtil.storeState();MMUtil.doGPing(mediaProperties.gping);};MultimediaSearch.prototype.scratchpadImageClick=function scratchpadImageClick(mediaProperties){if(m_resultView.info==mediaProperties&&MMUtil.getState()._lastPage=="sidepanel")return;MMUtil.commitState();delete MMUtil.getState().q;MMUtil.getState().fi="true";MMUtil.getState().surl=mediaProperties.mediaurl;MMUtil.getState()._mediaProperties=MMUtil.serializeArray(mediaProperties.propertiesArray);me.updatePage();MMUtil.storeState();};MultimediaSearch.prototype.backToResults=function backToResults(control){MMUtil.record("ResultView","back to results",{});MMUtil.commitState();var state=MMUtil.getState();delete state.furl;delete state.surl;delete state.focal;if(MMUtil.query)state.q=MMUtil.query.parameters.getParameter("queryString");me.updatePage();MMUtil.storeState();};MultimediaSearch.prototype.xmlCallback=function xmlCallback(query){if(query==MMUtil.query)me.updatePage();};MultimediaSearch.prototype.changeQuery=function changeQuery(queryParameters){MMUtil.query=new MultimediaQuery(queryParameters);MMUtil.query.initialize(this.xmlCallback,m_resultsPanel.processResultItem,m_resultsPanel.createResultItem);MMUtil.setText(m_relatedPeopleModule.m_title,m_relatedPeopleModule.c_titleText);this.updatePage();};MultimediaSearch.prototype.onStateChange=function onStateChange(){MMUtil.setFeedbackUrl();var state=MMUtil.getState();var queryBox=document.getElementById("q");if(!state.q){me.updatePage();return;}var qp=new QueryParameters();qp.populateFromState(state);if(!queryBox.value)queryBox.value=qp.getParameter("queryString");var reg=/\s*imagesize:[\w]+\s*/;while(queryBox.value.match(reg)){queryBox.value=queryBox.value.replace(reg,"");}if(!MMUtil.query){me.changeQuery(qp);return;}me.updatePage();return;};MultimediaSearch.prototype.loadImageForUrl=function(murl,callback){var query="url:"+murl;url=MMUtil.getXMLUrl(query,"",1,1);var xmlRequest=new XMLRequest();try{xmlRequest.execute(url,receive);}catch(e){xmlRequest.dispose();}function receive(xml){var results=MultimediaQuery.parseXML(xml);if(results.error)callback(null,false);else{if(results.length==0)callback(null,false);else{var props=results[0];var mp=new MediaProperties();mp.initialize(props,callback);mp.fetch();}}xmlRequest.dispose();}};}function ImageSearch(element){ImageSearch.baseConstructor.call(this,element);this.c_welcomeString=L_welcomeImage_Message;var c_defaultPreferences={"lod":4,"scratchpad":0};this.initialize=function initialize(){MMUtil.setText(document.title,L_imagePageTitle_Text);ImageSearch.parentClass.initialize.call(this,c_defaultPreferences);};this.dispose=function dispose(unload){ImageSearch.parentClass.dispose.call(this,unload);};this.createResultViewPanel=function createResultViewPanel(container){return new ImageResultViewPanel(container);};}LiveMM.extend(ImageSearch,MultimediaSearch);SidePanelModule=function(){this.m_name=null;this.m_container=null;this.m_titlebar=null;this.m_content=null;this.m_closeButton=null;this.m_height=null;this.m_minWidth=null;this.m_enabled=null;function cancelEvent(e){if(!e)e=window.event;e.cancelBubble=true;}SidePanelModule.prototype.initialize=function(name){this.m_name=name;this.m_container=MMUtil.createElement(name,null,"div","side_panel_module_container");this.m_titlebar=MMUtil.createElement(name+"_title",this.m_container,"div","side_panel_module_titlebar");this.m_content=MMUtil.createElement(name+"_content",this.m_container,"div","side_panel_module_content");this.m_closeButton=MMUtil.createElement(null,this.m_titlebar,"a","scratchpad_collection_close_button");this.m_closeButton.innerHTML="<img src='s/live/glyph_close_rest.gif' />";this.m_enabled=true;if(MMUtil.isIE()){MMUtil.addListener(this.m_container,"keydown",cancelEvent,true);MMUtil.addListener(this.m_container,"mousewheel",cancelEvent,true);}else{MMUtil.addListener(this.m_container,"keydown",cancelEvent,true);MMUtil.addListener(this.m_container,"DOMMouseScroll",cancelEvent,true);}};SidePanelModule.prototype.dispose=function dispose(){if(MMUtil.isIE()){MMUtil.removeListener(this.m_container,"keydown",cancelEvent);MMUtil.removeListener(this.m_container,"mousewheel",cancelEvent);}else{MMUtil.removeListener(this.m_container,"keydown",cancelEvent);MMUtil.removeListener(this.m_container,"DOMMouseScroll",cancelEvent);}};SidePanelModule.prototype.enable=function enable(){this.m_container.style.display="block";this.m_enabled=true;};SidePanelModule.prototype.disable=function disable(){this.m_container.style.display="none";this.m_enabled=false;};SidePanelModule.prototype.dispose=function dispose(){};SidePanelModule.prototype.setHeight=function setHeight(height){this.m_container.style.height=height+"px";};};ScratchpadModule=function(){ScratchpadModule.baseConstructor.call(this);var m_viewMedia=null;var m_height=0;var m_title;var m_newCollectionButton;this.m_minWidth=24;var c_newCollectionButtonText=L_scratchpadNewCollectionButton_Text;function createNewCollection(e){var col=MMUtil.scratchpad.createCollection();if(col){MMUtil.record("scratchpad","new collection click",{"collection":col.getName()});col.roll(ScratchpadCollection.c_expand);MMUtil.scratchpad.positionCollections();}else MMUtil.record("scratchpad","new collection click - failed",{});if(e.preventDefault)e.preventDefault();return false;}ScratchpadModule.prototype.initialize=function initialize(viewMedia){ScratchpadModule.parentClass.initialize.call(this,"scratchpad");this.m_container.scratchpad="scratchpad";m_title=MMUtil.createElement(null,this.m_titlebar,"div","side_panel_title");MMUtil.setText(m_title,L_scratchpadTitle_Text);MMUtil.addListener(this.m_closeButton,"click",MMUtil.getMMSearchInstance().toggleScratchpad,true);m_newCollectionButton=MMUtil.createElement("new_collection_button",null,"a");MMUtil.setText(m_newCollectionButton,c_newCollectionButtonText);m_newCollectionButton.unselectable="on";this.m_titlebar.insertBefore(m_newCollectionButton,this.m_closeButton);MMUtil.addListener(m_newCollectionButton,"click",createNewCollection,true);m_viewMedia=viewMedia;};ScratchpadModule.prototype.dispose=function dispose(){ScratchpadModule.parentClass.dispose.call(this);MMUtil.removeListener(this.m_closeButton,"click",MMUtil.getMMSearchInstance().toggleScratchpad);MMUtil.removeListener(m_newCollectionButton,"click",createNewCollection);this.disable();if(MMUtil.scratchpad){MMUtil.removeListener(this.m_closeButton,"focus",MMUtil.scratchpad.setCollectionsFocusStyle);MMUtil.removeListener(this.m_closeButton,"blur",MMUtil.scratchpad.setCollectionsUnfocusStyle);MMUtil.removeListener(m_newCollectionButton,"focus",MMUtil.scratchpad.setCollectionsFocusStyle);MMUtil.removeListener(m_newCollectionButton,"blur",MMUtil.scratchpad.setCollectionsUnfocusStyle);MMUtil.scratchpad.dispose();}MMUtil.scratchpad=null;while(this.m_content.firstChild){this.m_content.removeChild(this.m_content.firstChild);}m_title=m_newCollectionButton=null;};ScratchpadModule.prototype.enable=function enable(){ScratchpadModule.parentClass.enable.call(this);if(!MMUtil.scratchpad){MMUtil.scratchpad=new Scratchpad(this.m_content);MMUtil.scratchpad.initialize(m_viewMedia);}MMUtil.addListener(this.m_closeButton,"focus",MMUtil.scratchpad.setCollectionsFocusStyle,true);MMUtil.addListener(this.m_closeButton,"blur",MMUtil.scratchpad.setCollectionsUnfocusStyle,true);MMUtil.addListener(m_newCollectionButton,"focus",MMUtil.scratchpad.setCollectionsFocusStyle,true);MMUtil.addListener(m_newCollectionButton,"blur",MMUtil.scratchpad.setCollectionsUnfocusStyle,true);};ScratchpadModule.prototype.disable=function(){ScratchpadModule.parentClass.disable.call(this);};ScratchpadModule.prototype.setHeight=function(height){ScratchpadModule.parentClass.setHeight.call(this,height);m_height=height;if(MMUtil.scratchpad)MMUtil.scratchpad.setHeight(m_height);};};LiveMM.extend(ScratchpadModule,SidePanelModule);RelatedEntitiesModule=function(){RelatedEntitiesModule.baseConstructor.call(this);this.m_minWidth=20;this.m_title=null;this.m_scroller=null;this.m_thumbs=null;this.m_animationDuration=750;this.m_scrollWheelDuration=400;this.m_navUp=null;this.m_navDown=null;this.m_active=null;this.m_scrollMutex=false;var m_list=null;RelatedEntitiesModule.prototype.initialize=function initialize(){RelatedEntitiesModule.parentClass.initialize.call(this,"relatedEntities");this.m_container.removeChild(this.m_titlebar);this.m_scroller=gebc("re_thumbs",gebi("relatedEntities"))[0];this.m_thumbs=gebc("re_thumb",this.m_scroller);var re=this;this.m_navUp=gebc("re_nu",this.m_container)[0];this.m_navDown=gebc("re_nd",this.m_container)[0];if(this.m_navUp&&this.m_navDown){this.m_navUp.onclick=function(){re.scrollUp();return false;};this.m_navDown.onclick=function(){re.scrollDown();return false;};}if(this.m_container.className.match("re_img")){MMUtil.addListener(window,"load",function(){imageSearch.getSidePanel().getModules().relatedEntities.alignThumbs();});var listenerEvent=MMUtil.isIE()?"mousewheel":"DOMMouseScroll";MMUtil.addListener(this.m_container,listenerEvent,this.mouseWheelHandler);this.updateNavText();}else this.m_minWidth=15;this.m_active=true;};RelatedEntitiesModule.prototype.mouseWheelHandler=function mouseWheelHandler(e){if(!e)e=window.event;var delta=0;if(e.wheelDelta)delta=e.wheelDelta;else{if(e.detail)delta=-e.detail;}rePanel=imageSearch.getSidePanel().getModules().relatedEntities;var vr=rePanel.visibleRange();if(delta>0)rePanel.scrollTo(vr[0]-2,false,rePanel.m_scrollWheelDuration);else{if(delta<0)rePanel.scrollTo(vr[0]+2,false,rePanel.m_scrollWheelDuration);}e.cancelBubble=true;};RelatedEntitiesModule.prototype.alignThumbs=function alignThumbs(){var haveDeleted=false;for(i=0;i<this.m_thumbs.length;i++){thumb=this.m_thumbs[i];img=thumb.getElementsByTagName("img")[0];if(!img.complete||img.naturalWidth==0){haveDeleted=true;thumb.style.display="none";this.removeThumb(i);i--;}}if(this.m_thumbs.length==0){imageSearch.setModuleStatus("relatedEntities","disable");return;}if(haveDeleted)for(i=0;i<this.m_thumbs.length;i+=2){thumb1=this.m_thumbs[i];thumb2=this.m_thumbs[i+1]||thumb1;if(thumb1&&thumb2){if(thumb1.offsetHeight!=thumb2.offsetHeight){img1=thumb1.getElementsByTagName("img")[0];img2=thumb2.getElementsByTagName("img")[0];maxImgHeight=Math.max(img1.offsetHeight,img2.offsetHeight);img1.style.margin=(maxImgHeight-img1.offsetHeight)/2+"px 0";img2.style.margin=(maxImgHeight-img2.offsetHeight)/2+"px 0";}}}this.updateNavText();};RelatedEntitiesModule.prototype.removeThumb=function removeThumb(thumbIndex){if(thumbIndex<0||thumbIndex>=this.m_thumbs.length)return;a=this.m_thumbs.slice(0,thumbIndex);b=this.m_thumbs.slice(thumbIndex+1,this.m_thumbs.length);this.m_thumbs=a.concat(b);};RelatedEntitiesModule.prototype.getScrollOffset=function getScrollOffset(thumbIndex){thumbIndex=Math.max(0,Math.min(this.m_thumbs.length-1,thumbIndex));return this.m_thumbs[thumbIndex].offsetTop-this.m_thumbs[0].offsetTop;};RelatedEntitiesModule.prototype.scrollTo=function scrollTo(thumbIndex,disableAnimation,duration){if(this.m_scrollMutex)return;this.m_scrollMutex=true;var offset=this.getScrollOffset(thumbIndex);duration=duration||this.m_animationDuration;if(disableAnimation)this.m_scroller.scrollTop=offset;else{var start=this.m_scroller.scrollTop;var end=offset;var scroller=this.m_scroller;var re=this;animate(function(p){scroller.scrollTop=start+(end-start)*p;},duration,function(){re.updateNavText();re.m_scrollMutex=false;});}};RelatedEntitiesModule.prototype.updateNavText=function updateNavText(){if(!(this.m_navUp&&this.m_navDown))return;var vr=this.visibleRange();var text=vr[0]+1+"-"+(vr[1]+1)+" of "+this.m_thumbs.length;this.m_navUp.style.visibility=vr[0]==0?"hidden":"visible";this.m_navDown.style.visibility=vr[1]==this.m_thumbs.length-1?"hidden":"visible";};RelatedEntitiesModule.prototype.scrollUp=function scrollUp(){var vr=this.visibleRange();this.scrollTo(vr[0]-(vr[1]-vr[0]));};RelatedEntitiesModule.prototype.scrollDown=function scrollDown(){var vr=this.visibleRange();this.scrollTo(vr[1]+1);};RelatedEntitiesModule.prototype.visibleRange=function visibleRange(){var viewportTop=this.m_scroller.scrollTop;var viewportBottom=viewportTop+this.m_scroller.clientHeight;var firstVisible=null;var lastVisible=null;for(var i=0;i<this.m_thumbs.length;i++){var thumb=this.m_thumbs[i];var thumbTop=thumb.offsetTop;var thumbBottom=thumbTop+thumb.offsetHeight;if(firstVisible==null&&thumbTop>=viewportTop&&thumbBottom<=viewportBottom)firstVisible=i;if(firstVisible!=null){if(thumbTop>=viewportTop&&thumbBottom<=viewportBottom)lastVisible=i;else break;}}return [firstVisible||0,lastVisible||1];};RelatedEntitiesModule.prototype.setHeight=function setHeight(height){if(!this.m_active)return;this.m_container.style.height=height+"px";this.updateNavText();};};LiveMM.extend(RelatedEntitiesModule,SidePanelModule);RelatedPeopleModule=function(){RelatedPeopleModule.baseConstructor.call(this);this.c_titleText=L_relatedPeopleTitle_Text;this.m_minWidth=15;this.m_title=null;this.m_ServerSiderRendered=false;var m_list=null;RelatedPeopleModule.prototype.initialize=function initialize(){RelatedPeopleModule.parentClass.initialize.call(this,"relatedPeople");this.m_titlebar.removeChild(this.m_closeButton);this.m_title=MMUtil.createElement("side_panel_title",this.m_titlebar,"div","side_panel_title");MMUtil.setText(this.m_title,this.c_titleText);this.m_listElement=MMUtil.createElement("relatedPeople_list",this.m_content,"div");if(this.m_listElement.childNodes.length>0)this.m_ServerSiderRendered=true;m_list=new List(this.m_listElement);m_list.initialize("relatedPeople_list");};RelatedPeopleModule.prototype.dispose=function dispose(){ScratchpadModule.parentClass.dispose.call(this);this.removeSuggestions();};RelatedPeopleModule.prototype.setSuggestions=function setSuggestions(names){if(this.m_ServerSiderRendered)return;this.removeSuggestions();for(var i=0;i<names.length;i++){var name=names[i];var item=m_list.createItem(name,name);if(item){item.rank=i;item.setHref(MMUtil.getHTMLUrl(name,"","RP"));}}this.m_listElement.style.height=1.8*names.length+"em";};RelatedPeopleModule.prototype.removeSuggestions=function removeSuggestions(){m_list.removeAllItems();};RelatedPeopleModule.prototype.setHeight=function setHeight(height){RelatedPeopleModule.parentClass.setHeight.call(this,height);this.m_content.style.height=height-this.m_content.offsetTop+"px";};};LiveMM.extend(RelatedPeopleModule,SidePanelModule);SidePanel=function(m_el){var me=this;var m_sidePanelHeight=0;var m_sidePanelUpdate=null;var m_hidden=false;var m_modules={};var c_moduleSpacing=9;var c_moduleBorder=2;var m_width=0;this.initialize=function initialize(onDisplayChange){m_sidePanelUpdate=onDisplayChange;};this.dispose=function dispose(){m_onDisplayChange=null;me=m_el=null;};this.setHeight=function setHeight(height){m_sidePanelHeight=height;m_el.style.height=height+2+"px";var enabled=0;for(var m in m_modules){if(m_modules[m].m_enabled==true)enabled++;}if(enabled==0)return;var availableHeight=height-(enabled-1)*(c_moduleSpacing+c_moduleBorder);var moduleHeight=Math.floor(availableHeight/enabled);var extra=availableHeight-moduleHeight*enabled;var lastmod;for(var m in m_modules){if(extra>0){m_modules[m].setHeight(moduleHeight+1);extra--;}else m_modules[m].setHeight(moduleHeight);m_modules[m].m_container.style.marginBottom="9px";if(m_modules[m].m_enabled)lastmod=m_modules[m];}if(lastmod)lastmod.m_container.style.marginBottom="0px";};this.updatePanel=function updatePanel(){var enabled=0;m_width=0;for(var m in m_modules){if(m_modules[m].m_enabled==true){enabled++;if(m_modules[m].m_minWidth>m_width)m_width=m_modules[m].m_minWidth;}}m_el.style.width=m_width+"em";m_sidePanelUpdate();if(enabled>0&&!m_hidden&&!MMUtil.sidepanelShowing){m_el.style.display="block";MMUtil.sidepanelShowing=true;m_sidePanelUpdate();}else{if((enabled==0||m_hidden)&&MMUtil.sidepanelShowing){m_el.style.display="none";MMUtil.sidepanelShowing=false;m_sidePanelUpdate();}}this.setHeight(m_sidePanelHeight);};this.setHidden=function setHidden(hide){m_hidden=hide;this.updatePanel();};this.addModule=function addModule(module){m_modules[module.m_name]=module;m_el.appendChild(module.m_container);this.disableModule(module.m_name);this.updatePanel();};this.removeModule=function removeModule(moduleName){var toDelete=m_modules[moduleName];if(!toDelete)return;if(MMUtil.getParentElement(toDelete.m_container)==m_el)m_el.removeChild(toDelete.m_container);delete m_modules[module.m_name];this.updatePanel();};this.enableModule=function enableModule(moduleName){var toEnable=m_modules[moduleName];if(!toEnable||toEnable.m_enabled==true)return;toEnable.enable();this.updatePanel();};this.disableModule=function disableModule(moduleName){var toDisable=m_modules[moduleName];if(!toDisable||toDisable.m_enabled==false)return;toDisable.disable();this.updatePanel();};this.getModules=function getModules(){return m_modules;};this.getWidth=function getWidth(){return m_el.offsetWidth;};this.dispose=function dispose(){for(var m in m_modules){this.removeModule(m_modules[m]);}};};Scratchpad=function(container){var me=this;var m_collections=Array();var m_container=container;var m_collectionsContainer;var m_helpBlock;var m_helpTextBlock;var m_fullMessageElement;var m_messageTimer;var m_height;this.m_focused=false;var m_draggedItem=null;var m_draggedItemCover=null;this.isDragging=false;var m_dropTargetCollection=null;var m_dropTargetItem=null;var m_dropTargetItemIndex=null;var m_dropScratchpad=false;var m_dropOverIndicator=false;var m_dragFromScratchpad=false;var m_hoverCollection=null;this.isScrolling=false;var m_scrollRate=50;var m_scrollInterval=null;var m_scrollTime=0;var m_mouseNearEdgeThreshold=100;var m_lastMouseX;var m_lastMouseY;m_leftDragBound=null;m_rightDragBound=null;m_topDragBound=null;m_bottomDragBound=null;var m_dropIndicatorTimeout=null;this.imageClickCallback;var c_itemCountLimit=40;var c_collectionCountLimit=10;var c_tooManyItemsText=L_tooManyItems_Message.replace(/%count%/,c_itemCountLimit);var c_tooManyItemsMultiCollectionText=L_tooManyItemsMultiCollection_Message.replace(/%count%/,c_itemCountLimit);var c_tooManyCollectionsText=L_tooManyCollections_Message.replace(/%count%/,c_collectionCountLimit);var c_defaultCollectionName=L_defaultCollection_Text;var c_cookieName="com.live.images.scratchpad";var c_helpText=L_scratchpadHelp_Text;var c_delayToPopCollection=750;var c_scrollFrameRate=60;var c_minScrollRate=50;var c_maxScrollRate=500;var c_mouseNearEdgeBuffer=10;var c_offsetPerCollection=1;var c_collectionsOffsetHeight=MMUtil.isMozilla()||MMUtil.isIE7()?0:-1;var c_dragStartThreshold=20;var c_scrollNearEdgeHeight=90;var c_removeWarningMessageDelay=5000;this.collectionsWidth=0;this.initialize=function initialize(imageClickCallback){this.collectionsWidth=MMUtil.isMozilla()?"100%":"240px";this.imageClickCallback=imageClickCallback;m_collections=Object();m_helpBlock=document.createElement("div");m_helpBlock.className="scratchpad_help_block";m_helpTextBlock=document.createElement("div");m_helpTextBlock.className="scratchpad_help_text_block";MMUtil.setText(m_helpTextBlock,c_helpText);m_draggedItemCover=document.createElement("iframe");m_draggedItemCover.id="dragged_item_cover";MMUtil.setOpacity(m_draggedItemCover,0);m_helpBlock.appendChild(m_helpTextBlock);m_fullMessageElement=document.createElement("div");m_fullMessageElement.className="scratchpad_full_message";m_collectionsContainer=document.createElement("div");m_collectionsContainer.id="scratchpad_collections_container";m_container.appendChild(m_fullMessageElement);m_container.appendChild(m_collectionsContainer);m_container.appendChild(m_helpBlock);m_collectionsContainer.style.display="none";m_helpBlock.style.display="block";me.load();MMUtil.addListener(document,"mouseup",this.mouseUp,true);MMUtil.addListener(document,"mousemove",this.mouseMove,true);};this.dispose=function dispose(){me.store();MMUtil.removeListener(document,"mouseup",me.mouseUp);MMUtil.removeListener(document,"mousemove",me.mouseMove);m_draggedItem=null;m_draggedItemCover=null;for(var c in m_collections){m_collectionsContainer.removeChild(me.getCollectionByName(c).getContainer());me.getCollectionByName(c).dispose();delete m_collections[c.toLowerCase()];}me=m_helpBlock=m_helpTextBlock=m_fullMessageElement=m_collectionsContainer=null;};this.setHeight=function setHeight(height){if(!height||height<0)return;m_height=height;if(m_collectionsContainer.offsetTop!=null)var colHeight=height-m_collectionsContainer.offsetTop-m_container.offsetTop;else var colHeight=height-m_helpBlock.offsetTop-m_container.offsetTop;m_collectionsContainer.style.height=colHeight+"px";m_helpBlock.style.height=colHeight+"px";m_mouseNearEdgeThreshold=c_scrollNearEdgeHeight;me.positionCollections();};this.collapseAllCollections=function collapseAllCollections(){for(var c in m_collections){me.getCollectionByName(c).roll(ScratchpadCollection.c_collapse);}MMUtil.scratchpad.positionCollections();};this.positionCollections=function positionCollections(atLeastOneUnrolled){var height=m_collectionsContainer.offsetHeight;var currentheight=0;var unrolledcount=0;var count=0;var lastcollection=null;var lastUnrolledCollection=null;for(var c in m_collections){currentheight+=me.getCollectionByName(c).getNaturalHeight();if(me.getCollectionByName(c).getRollState()==ScratchpadCollection.c_expand){unrolledcount++;lastUnrolledCollection=me.getCollectionByName(c);}count++;lastcollection=me.getCollectionByName(c);}if(atLeastOneUnrolled&&unrolledcount==0&&lastcollection){currentheight-=lastcollection.getNaturalHeight();lastcollection.roll(ScratchpadCollection.c_expand);currentheight+=lastcollection.getNaturalHeight();unrolledcount++;lastUnrolledCollection=lastcollection;}var offset=count*c_offsetPerCollection+c_collectionsOffsetHeight;var availableHeight=height-currentheight-offset;if(lastUnrolledCollection)var lastCollectionHeight=lastUnrolledCollection.getNaturalHeight()+availableHeight;for(var c in m_collections){me.getCollectionByName(c).getContainer().style.height="auto";me.getCollectionByName(c).getContainer().style.borderBottomWidth="1px";if(!MMUtil.isMozilla())me.getCollectionByName(c).getContainer().style.width=Math.max(m_collectionsContainer.clientWidth-5,0)+"px";}if(lastUnrolledCollection&&availableHeight>0)lastUnrolledCollection.getContainer().style.height=lastCollectionHeight+"px";if(unrolledcount>0)lastcollection.getContainer().style.borderBottomWidth="0px";};this.store=function store(){var value=me.serialize();MMUtil.writePreference(c_cookieName,value);};this.load=function load(){var content=MMUtil.readPreference(c_cookieName);me.deserialize(content);};this.validateItemCount=function validateItemCount(){var count=0;for(var c in m_collections){count+=me.getCollectionByName(c).getItemCount();}if(count>=c_itemCountLimit){MMUtil.record("scratchpad","exceeded item limit",{"numberofitems":count});var collectioncount=0;for(var c in m_collections){collectioncount++;}if(collectioncount>1)MMUtil.setText(m_fullMessageElement,c_tooManyItemsMultiCollectionText);else MMUtil.setText(m_fullMessageElement,c_tooManyItemsText);return false;}else return true;};this.validateCollectionCount=function validateCollectionCount(){var collectioncount=0;for(var c in m_collections){collectioncount++;}if(collectioncount>=c_collectionCountLimit){MMUtil.record("scratchpad","exceeded collection limit",{"numberofcollections":collectioncount});MMUtil.setText(m_fullMessageElement,c_tooManyCollectionsText);return false;}else return true;};this.showWarningMessage=function showWarningMessage(){clearTimeout(m_messageTimer);m_fullMessageElement.style.display="block";me.setHeight(m_height);m_messageTimer=setTimeout(this.hideWarningMessage,c_removeWarningMessageDelay);};this.hideWarningMessage=function hideWarningMessage(){clearTimeout(m_messageTimer);if(m_fullMessageElement)m_fullMessageElement.style.display="none";me.setHeight(m_height);};this.getCollectionByName=function getCollectionByName(name){return m_collections[name.toLowerCase()];};this.createCollection=function createCollecton(name){if(!me.validateCollectionCount()){me.showWarningMessage();return;}if(!name)name=c_defaultCollectionName;var collection=new ScratchpadCollection();collection.initialize();collection.setName(name);me.fixCollectionName(collection);m_collections[collection.getName().toLowerCase()]=collection;m_collectionsContainer.appendChild(collection.getContainer());me.getCollectionByName(collection.getName()).roll(ScratchpadCollection.c_expand);m_helpBlock.style.display="none";m_collectionsContainer.style.display="block";me.positionCollections();return collection;};this.fixCollectionName=function fixCollectionName(collection){var name=collection.getName();while(me.getCollectionByName(name)){var chunks=name.split(" ");var number=chunks[chunks.length-1];if(number!=parseInt(number))name+=" 2";else{var string="";for(var i=0;i<chunks.length-1;i++){string+=chunks[i]+" ";}name=string+(parseInt(number)+1);}collection.setName(name);}};this.renameCollection=function renameCollection(collection,newname){if(newname=="")return;m_collections[collection.getName().toLowerCase()]=null;delete m_collections[collection.getName().toLowerCase()];collection.setName(newname);me.fixCollectionName(collection);m_collections[collection.getName().toLowerCase()]=collection;};this.deleteCollection=function deleteCollection(name){if(me.getCollectionByName(name)){m_collectionsContainer.removeChild(me.getCollectionByName(name).getContainer());me.getCollectionByName(name).dispose();delete m_collections[name.toLowerCase()];if(m_collectionsContainer.childNodes.length==0){m_collectionsContainer.style.display="none";m_helpBlock.style.display="block";}}me.hideWarningMessage();me.positionCollections();};this.setCollectionsFocusStyle=function setCollectionsFocusStyle(e){this.m_focused=true;for(var c in m_collections){me.getCollectionByName(c).setFocusStyle();}};this.setCollectionsUnfocusStyle=function setUnfocusStyle(e){this.m_focused=false;for(var c in m_collections){me.getCollectionByName(c).setUnfocusStyle();}};this.addImage=function addImage(mediaProperties){MMUtil.record("scratchpad","add to scratchpad",{"murl":mediaProperties.mediaurl});var collectionName=null;var openedFound=false;for(var c in m_collections){if(!openedFound||me.getCollectionByName(c).m_rollState==-1)collectionName=c;if(!openedFound&&me.getCollectionByName(c).m_rollState==-1)openedFound=true;}if(collectionName==null){me.createCollection(c_defaultCollectionName);collectionName=c_defaultCollectionName;}var collection=me.getCollectionByName(collectionName);var item=new ScratchpadItem();item.initialize(mediaProperties);item.setCollection(collection);collection.addItem(item);MMUtil.scratchpad.positionCollections();};this.serialize=function serialize(){var string="";for(var c in m_collections){string+=me.getCollectionByName(c).serialize();}return string;};this.deserialize=function deserialize(content){if(content){var collections=content.split("}");for(var i=0;i<collections.length;i++){var murls=collections[i].split("]");var name=decodeURIComponent(murls.splice(0,1));if(!name)continue;var collection=me.createCollection(name);var state=decodeURIComponent(murls.splice(0,1));murls.pop();collection.addItemsForUrls(murls);collection.roll(state);MMUtil.scratchpad.positionCollections();}MMUtil.scratchpad.positionCollections();}};this.scrollNearEdge=function scrollNearEdge(e){var m=MMUtil.getMousePosition(e);var sptop=MMUtil.getGlobalOffset(m_container,"offsetTop");var cctop=m_collectionsContainer.offsetTop+sptop;var ccheight=parseInt(m_collectionsContainer.style.height);var ccbottom=cctop+ccheight;cctop-=c_mouseNearEdgeBuffer;ccbottom+=c_mouseNearEdgeBuffer;if(me.isDragging&&m_dropScratchpad&&m.y>=cctop&&m.y<=ccbottom){var distanceFromEdge=0;var direction=0;if(m.y<cctop+m_mouseNearEdgeThreshold){direction=1;distanceFromEdge=m.y-cctop;}else{if(m.y>ccbottom-m_mouseNearEdgeThreshold){direction=-1;distanceFromEdge=ccbottom-m.y;}else{me.stopScroll();return;}}var rateProp=1-distanceFromEdge/m_mouseNearEdgeThreshold;var scrollRate=rateProp*(c_maxScrollRate-c_minScrollRate)+c_minScrollRate;me.startScroll(direction*scrollRate);}else me.stopScroll();};this.startScroll=function startScroll(rate){m_scrollRate=rate;me.stopScroll();me.isScrolling=true;var d=new Date();m_scrollTime=d.getTime();m_scrollInterval=setInterval(me.scrollTick,1000/c_scrollFrameRate);};this.scrollTick=function scrollTick(){var d=new Date();var t=d.getTime();var elapsed=m_scrollTime-t;m_scrollTime=t;m_collectionsContainer.scrollTop+=elapsed/1000*m_scrollRate;};this.stopScroll=function stopScroll(){me.isScrolling=false;if(m_scrollInterval)clearInterval(m_scrollInterval);m_scrollInterval=null;};this.imageMouseDown=function imageMouseDown(mediaProperties,e){if(!e)var e=window.event;if(MMUtil.isRightClick(e))return false;e.cancelBubble=true;if(e.preventDefault)e.preventDefault();var mousepos=MMUtil.getMousePosition(e);m_lastMouseX=mousepos.x;m_lastMouseY=mousepos.y;m_dropTargetCollection=null;m_dropTargetItem=null;m_dropTargetItemIndex=null;m_dropOverIndicator=false;m_dropScratchpad=false;m_dragFromScratchpad=false;var item=new ScratchpadItem();item.initialize(mediaProperties,me.startDrag);return false;};this.itemMouseDown=function itemMouseDown(scratchpadItem,e){if(!e)var e=window.event;if(MMUtil.isRightClick(e))return true;e.cancelBubble=true;var mousepos=MMUtil.getMousePosition(e);m_lastMouseX=mousepos.x;m_lastMouseY=mousepos.y;m_dropTargetCollection=scratchpadItem.getCollection().getName();m_dropTargetItem=scratchpadItem.getMediaProperties().mediahash;m_dropTargetItemIndex=scratchpadItem.getCollection().getIndexByHash(m_dropTargetItem);m_dropOverIndicator=true;m_dropScratchpad=true;m_dragFromScratchpad=true;me.startDrag(scratchpadItem);return true;};this.startDrag=function startDrag(scratchpadItem){if(!me.isDragging&&!m_draggedItem){MMUtil.getMMSearchInstance().getResultViewPanel().cover();m_draggedItem=scratchpadItem;}};this.populateDropTargets=function populateDropTargets(e){var target=MMUtil.getSrcElement(e);newDropTargetCollection=null;newDropTargetItem=null;newDropScratchpad=false;newDropOverIndicator=false;while(target&&!target.scratchpad&&target.nodeName!="BODY"){if(target.collectionName)newDropTargetCollection=target.collectionName;if(target.scratchpadItemHash)newDropTargetItem=target.scratchpadItemHash;if(target==m_draggedItem.getContainer())newDropOverIndicator=true;if(target==m_draggedItem.getDraggableHandle())return;target=MMUtil.getParentElement(target);}newDropScratchpad=target&&target.scratchpad?true:false;m_dropTargetCollection=newDropTargetCollection;m_dropTargetItem=newDropTargetItem;m_dropScratchpad=newDropScratchpad;m_dropOverIndicator=newDropOverIndicator;};this.mouseMove=function mouseMove(e){var mousepos=MMUtil.getMousePosition(e);if(mousepos.x==m_lastMouseX&&mousepos.y==m_lastMouseY)return false;me.scrollNearEdge(e);var previousDragState=me.isDragging;if(m_draggedItem&&!me.isDragging){var canStartDrag=Math.sqrt(Math.pow(mousepos.x-m_lastMouseX,2)+Math.pow(mousepos.y-m_lastMouseY,2))>c_dragStartThreshold;if(!canStartDrag)return false;if(m_draggedItem.getCollection()){m_draggedItem.getCollection().removeItem(m_draggedItem,true);var params={"collection":m_draggedItem.getCollection().getName(),"murl":m_draggedItem.getMediaProperties().mediaurl,"index":m_dropTargetItemIndex};MMUtil.record("scratchpad","drag from scratchpad",params);}else{var params={"murl":m_draggedItem.getMediaProperties().mediaurl};MMUtil.record("scratchpad","drag from results",params);}m_draggedItem.createDraggableHandle();m_draggedItem.getDraggableHandle().style.display="none";m_draggedItemCover.style.visibility="visible";document.body.appendChild(m_draggedItemCover);document.body.appendChild(m_draggedItem.getDraggableHandle());me.positionCollections();me.isDragging=true;}m_lastMouseX=mousepos.x;m_lastMouseY=mousepos.y;if(me.isDragging){if(e.preventDefault)e.preventDefault();if(!previousDragState)m_draggedItem.setStyleDraggable();var target=MMUtil.getSrcElement(e);var old_collection=m_dropTargetCollection;var old_item=m_dropTargetItem;var old_scratchpad=m_dropScratchpad;me.populateDropTargets(e);if(!old_scratchpad&&m_dropScratchpad&&!m_dropTargetCollection)me.positionCollections(true);if(!m_dropOverIndicator&&(old_collection!=m_dropTargetCollection||old_item!=m_dropTargetItem)){try{if(old_collection)me.getCollectionByName(old_collection).getItemContainer().removeChild(m_draggedItem.getContainer());}catch(e){}if(m_dropTargetCollection&&me.getCollectionByName(m_dropTargetCollection)){m_hoverCollection=m_dropTargetCollection;setTimeout(me.openCollectionAfterDelay,c_delayToPopCollection);}me.placeDropIndicator(old_collection==m_dropTargetCollection);}var x=mousepos.x-m_draggedItem.getHandleX();var y=mousepos.y-m_draggedItem.getHandleY();if(m_draggedItem.getDraggableHandle().offsetWidth&&m_leftDragBound==null){m_leftDragBound=MMUtil.getGlobalOffset(MMUtil.element,"offsetLeft");m_rightDragBound=m_leftDragBound+MMUtil.element.offsetWidth-m_draggedItem.getDraggableHandle().offsetWidth;m_topDragBound=MMUtil.getGlobalOffset(MMUtil.element,"offsetTop");m_bottomDragBound=m_topDragBound+MMUtil.element.offsetHeight-m_draggedItem.getDraggableHandle().offsetHeight;}if(m_leftDragBound!=null&&x<m_leftDragBound)x=m_leftDragBound;if(m_rightDragBound!=null&&x>m_rightDragBound)x=m_rightDragBound;if(m_topDragBound!=null&&y<m_topDragBound)y=m_topDragBound;if(m_bottomDragBound!=null&&y>m_bottomDragBound)y=m_bottomDragBound;m_draggedItem.getDraggableHandle().style.left=x+"px";m_draggedItem.getDraggableHandle().style.top=y+"px";m_draggedItemCover.style.height=m_draggedItem.getDraggableHandle().offsetHeight+m_draggedItem.getDraggableHandle().style.borderWidth+"px";m_draggedItemCover.style.width=m_draggedItem.getDraggableHandle().offsetWidth+m_draggedItem.getDraggableHandle().style.borderWidth+"px";m_draggedItemCover.style.top=m_draggedItem.getDraggableHandle().offsetTop-m_draggedItem.getDraggableHandle().style.borderWidth+"px";m_draggedItemCover.style.left=m_draggedItem.getDraggableHandle().offsetLeft-m_draggedItem.getDraggableHandle().style.borderWidth+"px";m_draggedItem.getDraggableHandle().style.display="block";return false;}return true;};this.placeDropIndicator=function placeDropIndicator(sameCollection){var existingIndex=-1;if(m_draggedItem&&m_dropTargetCollection&&me.getCollectionByName(m_dropTargetCollection)){var itemhash=m_draggedItem.getMediaProperties().mediahash;existingIndex=me.getCollectionByName(m_dropTargetCollection).getIndexByHash(itemhash);}if(existingIndex==-1&&m_dropTargetCollection){var collection=me.getCollectionByName(m_dropTargetCollection);var items=collection.getItemContainer();var index=collection.getIndexByHash(m_dropTargetItem);if(sameCollection&&m_dropTargetItemIndex>=0&&m_dropTargetItemIndex<=index)index++;if(index<0)index=items.childNodes.length;if(index<items.childNodes.length)items.insertBefore(m_draggedItem.getContainer(),items.childNodes[index]);else items.appendChild(m_draggedItem.getContainer());m_dropTargetItemIndex=index;me.positionCollections();}else m_dropTargetItemIndex=null;};this.openCollectionAfterDelay=function openCollecitonAfterDelay(){if(m_hoverCollection==m_dropTargetCollection){me.getCollectionByName(m_hoverCollection).roll(ScratchpadCollection.c_expand);MMUtil.scratchpad.positionCollections();}};this.mouseUp=function mouseUp(e){var target=MMUtil.getSrcElement(e);if(me.isDragging){if(e&&e.preventDefault)e.preventDefault();document.body.removeChild(m_draggedItem.getDraggableHandle());document.body.removeChild(m_draggedItemCover);m_draggedItem.releaseDraggableHandle();if(m_dropScratchpad){var col;if(!m_dropTargetCollection){if(!me.getCollectionByName(c_defaultCollectionName))me.createCollection(c_defaultCollectionName);m_dropTargetCollection=c_defaultCollectionName;}col=me.getCollectionByName(m_dropTargetCollection);try{col.getItemContainer().removeChild(m_draggedItem.getContainer());}catch(e){}col.addItem(m_draggedItem,m_dropTargetItemIndex);col.roll(ScratchpadCollection.c_expand);var params={"collection":col.getName(),"murl":m_draggedItem.getMediaProperties().mediaurl,"index":m_dropTargetItemIndex};MMUtil.record("scratchpad","drop into scratchpad",params);if(m_dropTargetCollection)col.mouseOver();if(m_dropOverIndicator)m_draggedItem.mouseoverAction();m_dropTargetCollection=null;m_dropTargetItem=null;m_dropTargetItemIndex=null;m_dropOverIndicator=false;}else{if(m_draggedItem){var params={"murl":m_draggedItem.getMediaProperties().mediaurl};MMUtil.record("scratchpad","drop out of scratchpad",params);m_draggedItem.dispose();}}m_draggedItem=null;me.isDragging=false;me.positionCollections();}m_leftDragBound=null;m_rightDragBound=null;m_topDragBound=null;m_bottomDragBound=null;m_draggedItem=null;me.isDragging=false;MMUtil.getMMSearchInstance().getResultViewPanel().uncover();me.stopScroll();};};ScratchpadCollection=function(){var me=this;ScratchpadCollection.c_expand=-1;ScratchpadCollection.c_collapse=1;ScratchpadCollection.c_toggle=0;var m_name;var m_scratchpadItems=[];var m_rollState=1;var m_mouseIn;var m_container;var m_itemContainer;var m_actionsContainer;var m_titlebar;var m_title;var m_rollbutton;var m_deleteButton;var m_renameButton;var m_editTitleField;var m_clearTitlebar;var m_helpBlock;var c_rollupImage="s/live/glyph_expand_rest.gif";var c_rolldownImage="s/live/glyph_collapse_rest.gif";var c_helpBlockText=L_scratchpadCollectionHelp_Text;var c_renameButtonText=L_rename_Text;var c_maxItems=100;var c_itemHeight=95;this.initialize=function initialize(murls){m_container=document.createElement("div");m_container.className="scratchpad_collection";m_container.style.width=MMUtil.scratchpad.collectionsWidth;MMUtil.addListener(m_container,"mouseover",me.mouseOver,true);MMUtil.addListener(m_container,"mouseout",me.mouseOut,true);MMUtil.addListener(m_container,"focus",me.focus,true);MMUtil.addListener(m_container,"blur",me.blur,true);m_itemContainer=document.createElement("div");m_itemContainer.className="scratchpad_items";m_titlebar=document.createElement("div");m_titlebar.className="scratchpad_collection_titlebar";m_title=document.createElement("a");m_title.href="#";m_title.className="scratchpad_collection_title";MMUtil.addListener(m_title,"click",me.titleClick,true);MMUtil.addListener(m_title,"focus",me.focus,true);MMUtil.addListener(m_title,"blur",me.blur,true);m_rollbutton=document.createElement("span");m_rollbutton.innerHTML="<img src='"+c_rollupImage+"' />";m_rollbutton.className="scratchpad_collection_rollbutton";MMUtil.addListener(m_rollbutton,"click",me.titleClick,true);m_titlebar.appendChild(m_rollbutton);m_titlebar.appendChild(m_title);m_renameButton=document.createElement("a");m_renameButton.href="#";m_renameButton.className="scratchpad_rename_button_hidden";MMUtil.setText(m_renameButton,c_renameButtonText);MMUtil.addListener(m_renameButton,"click",me.renameAction,true);MMUtil.addListener(m_renameButton,"focus",me.focus,true);MMUtil.addListener(m_renameButton,"blur",me.blur,true);m_titlebar.appendChild(m_renameButton);m_deleteButton=document.createElement("a");m_deleteButton.innerHTML="<img src='s/live/glyph_close_rest.gif' class='close_button_img' />";m_deleteButton.className="scratchpad_collection_close_button_hidden";m_deleteButton.href="#";m_titlebar.appendChild(m_deleteButton);MMUtil.addListener(m_deleteButton,"click",me.deleteCollection,true);MMUtil.addListener(m_deleteButton,"focus",me.focus,true);MMUtil.addListener(m_deleteButton,"blur",me.blur,true);m_editTitleField=document.createElement("input");m_editTitleField.className="scratchpad_collection_edit_title_field";m_editTitleField.type="text";m_editTitleField.style.display="none";m_titlebar.appendChild(m_editTitleField);m_clearTitlebar=document.createElement("div");m_clearTitlebar.style.clear="both";m_titlebar.appendChild(m_clearTitlebar);MMUtil.addListener(m_editTitleField,"blur",me.renameSaveAction);MMUtil.addListener(m_editTitleField,"keypress",me.renameKeyPress,true);m_helpBlock=document.createElement("div");m_helpBlock.className="scratchpad_collection_help_block";MMUtil.setText(m_helpBlock,c_helpBlockText);m_container.appendChild(m_titlebar);m_container.appendChild(m_helpBlock);m_container.appendChild(m_itemContainer);m_mouseIn=false;m_focused=false;if(murls)me.addItemsForUrls(murls);};this.dispose=function dispose(){MMUtil.removeListener(m_container,"mouseover",me.mouseOver);MMUtil.removeListener(m_container,"mouseout",me.mouseOut);MMUtil.removeListener(m_container,"focus",me.focus);MMUtil.removeListener(m_container,"blur",me.blur);MMUtil.removeListener(m_deleteButton,"click",me.deleteCollection);MMUtil.removeListener(m_deleteButton,"focus",me.focus);MMUtil.removeListener(m_deleteButton,"blur",me.blur);MMUtil.removeListener(m_renameButton,"click",me.renameAction);MMUtil.removeListener(m_renameButton,"focus",me.focus);MMUtil.removeListener(m_renameButton,"blur",me.blur);MMUtil.removeListener(m_title,"click",me.titleClick);MMUtil.removeListener(m_title,"focus",me.focus);MMUtil.removeListener(m_title,"blur",me.blur);MMUtil.removeListener(m_rollbutton,"click",me.titleClick);MMUtil.removeListener(m_editTitleField,"keypress",me.renameKeyPress);for(var i=0;i<m_scratchpadItems.length;i++){m_itemContainer.removeChild(m_scratchpadItems[i].getContainer());m_scratchpadItems[i].dispose();m_scratchpadItems[i]=null;}me=m_container=m_itemContainer=m_titlebar=m_deleteButton=m_renameButton=null;m_title=m_rollbutton=m_editTitleField=m_helpBlock=null;};this.getContainer=function getContainer(){return m_container;};this.getItemContainer=function getItemContainer(){return m_itemContainer;};this.getNaturalHeight=function getNaturalHeight(){var height=m_titlebar.offsetHeight;if(m_rollState==ScratchpadCollection.c_expand){if(m_scratchpadItems.length>0)height+=m_itemContainer.childNodes.length*c_itemHeight;else height+=m_helpBlock.offsetHeight;}return height;};this.setName=function setName(name){m_name=name;MMUtil.setText(m_title,name);m_container.collectionName=name;};this.getName=function getName(){return m_name;};this.titleClick=function titleClick(e){if(!MMUtil.scratchpad.isDragging){me.roll(ScratchpadCollection.c_toggle);MMUtil.scratchpad.positionCollections();MMUtil.record("scratchpad","collection roll",{"direction":me.getRollState()});}};this.mouseOver=function mouseOver(e){m_mouseIn=true;me.setFocusStyle();};this.mouseOut=function mouseOut(e){if(!MMUtil.validateMouseOut(m_container,e)||m_focused)return false;m_mouseIn=false;me.setUnfocusStyle();};this.focus=function focus(e){MMUtil.scratchpad.setCollectionsFocusStyle();};this.blur=function blur(e){MMUtil.scratchpad.setCollectionsUnfocusStyle();};this.setFocusStyle=function setFocusStyle(){m_container.className="scratchpad_collection_hover";if(!MMUtil.scratchpad.isDragging){m_deleteButton.className="scratchpad_collection_close_button";m_renameButton.className="scratchpad_rename_button";}};this.setUnfocusStyle=function setUnfocusStyle(){if(m_mouseIn||MMUtil.scratchpad.m_focused)return;m_container.className="scratchpad_collection";m_deleteButton.className="scratchpad_collection_close_button_hidden";m_renameButton.className="scratchpad_rename_button_hidden";};this.deleteCollection=function deleteCollection(e){e.cancelBubble=true;if(e.preventDefault)e.preventDefault();MMUtil.record("scratchpad","delete collection",{"collection":me.getName()});MMUtil.scratchpad.deleteCollection(me.getName());return false;};this.renameAction=function renameAction(e){if(e.preventDefault)e.preventDefault();MMUtil.record("scratchpad","click rename button",{"collection":me.getName()});if(e)e.cancelBubble=true;me.showRenameForm();return false;};this.showRenameForm=function showRenameForm(){m_title.style.visibility="hidden";m_renameButton.style.visibility="hidden";m_editTitleField.style.display="block";m_editTitleField.value=me.getName();m_editTitleField.focus();m_editTitleField.select();};this.hideRenameForm=function hideRenameForm(){m_editTitleField.style.display="none";m_renameButton.style.visibility="visible";m_title.style.visibility="visible";};this.renameSaveAction=function renameSaveAction(e){if(e&&e.preventDefault)e.preventDefault();if(!m_editTitleField.value||m_editTitleField.value==""){me.renameCancelAction();return false;}var params={"oldname":me.getName(),"newname":m_editTitleField.value};MMUtil.record("scratchpad","rename save",params);if(e)e.cancelBubble=true;MMUtil.scratchpad.renameCollection(me,m_editTitleField.value);me.hideRenameForm();return false;};this.renameCancelAction=function renameCancelAction(e){if(e&&e.preventDefault)e.preventDefault();var params={"collection":me.getName()};MMUtil.record("scratchpad","rename cancel",params);if(e)e.cancelBubble=true;me.hideRenameForm();return false;};this.renameKeyPress=function renameKeyPress(e){var keycode=MMUtil.getKey(e);if(keycode==13){MMUtil.record("scratchpad","rename enter key",{"collection":me.getName()});me.renameSaveAction(e);}if(keycode==27){MMUtil.record("scratchpad","rename escape key",{"collection":me.getName()});me.renameCancelAction(e);}return true;};this.getItemCount=function getItemCount(){return m_scratchpadItems.length;};this.addItemsForUrls=function addItemsForUrls(murls){if(!murls.length)return;var query="";var indexmap=[];for(var i=0;i<murls.length;i++){if(!murls[i])continue;indexmap[murls[i]]=i;if(query)query+=" || ";if(query.length+murls[i].length<1000)query+="url:"+murls[i];else{this.sendItemXmlRequest(query,indexmap);query="";i--;}}if(query)this.sendItemXmlRequest(query,indexmap);};this.sendItemXmlRequest=function sendItemXmlRequest(query,indexmap){var url=MMUtil.getXMLUrl(query,"",1,c_maxItems);var xmlRequest=new XMLRequest();try{xmlRequest.execute(url,receive);}catch(e){xmlRequest.dispose();}function receive(xml){var results=MultimediaQuery.parseXML(xml);if(results.error){}else{if(results.length==0){}else for(var i=0;i<results.length;i++){var spItem=new ScratchpadItem();var props=results[i];var mp=new MediaProperties();mp.initialize(props,spItem.receiveImage,false);spItem.initialize(mp);var index=indexmap[encodeURI(props.mediaurl)];me.addItem(spItem,index!=null?index:results.length,true);}}xmlRequest.dispose();}};this.addItem=function addItem(scratchpadItem,index){if(!MMUtil.scratchpad.validateItemCount()){MMUtil.scratchpad.showWarningMessage();return -1;}scratchpadItem.setCollection(me);if(index==null||index<0||index>m_scratchpadItems.length)index=m_scratchpadItems.length;var mediaProperties=scratchpadItem.getMediaProperties();var myhash=mediaProperties.mediahash;var existingIndex=me.getIndexByHash(myhash);if(existingIndex!=-1)me.removeItemByIndex(existingIndex);if(index>m_itemContainer.childNodes.length)index=m_itemContainer.childNodes.length;if(m_itemContainer.childNodes.length==index)m_itemContainer.appendChild(scratchpadItem.getContainer());else m_itemContainer.insertBefore(scratchpadItem.getContainer(),m_itemContainer.childNodes[index]);m_scratchpadItems.splice(index,0,scratchpadItem);MMUtil.addListener(scratchpadItem.getContainer(),"mousedown",scratchpadItem.mouseDown,true);me.roll(m_rollState);return index;};this.getIndexByHash=function(hash){for(var i=0;i<m_scratchpadItems.length;i++){mediaProperties=m_scratchpadItems[i].getMediaProperties();var testhash=mediaProperties.mediahash;if(testhash==hash)return i;}return -1;};this.getItemByIndex=function(index){if(index>=m_scratchpadItems.length)return null;return m_scratchpadItems[index];};this.removeItem=function(item,keepInDom){var hash=item.getMediaProperties().mediahash;me.removeItemByHash(hash,keepInDom);};this.removeItemByHash=function(hash,keepInDom){var index=me.getIndexByHash(hash);me.removeItemByIndex(index,keepInDom);return index;};this.removeItemByIndex=function removeItemByIndex(index,keepInDom){if(index<0||index>=m_scratchpadItems.length)return;var item=m_scratchpadItems[index];m_scratchpadItems.splice(index,1);if(!keepInDom){var element=m_itemContainer.childNodes[index];m_itemContainer.removeChild(m_itemContainer.childNodes[index]);item.dispose();}me.roll(m_rollState);MMUtil.scratchpad.hideWarningMessage();MMUtil.scratchpad.positionCollections();};this.removeAllItems=function removeAllItems(){while(m_scratchpadItems.length>0){me.removeItemByIndex(0);}};this.getRollState=function getRollState(){return m_rollState;};this.roll=function roll(direction){if(direction==null)direction=ScratchpadCollection.c_toggle;m_rollState=direction!=ScratchpadCollection.c_toggle?direction:-m_rollState;if(m_rollState==1){me.getItemContainer().style.display="none";m_helpBlock.style.display="none";m_rollbutton.innerHTML="<img src='"+c_rollupImage+"' />";}else{if(m_scratchpadItems.length>0){m_helpBlock.style.display="none";m_itemContainer.style.display="block";}else{m_itemContainer.style.display="none";m_helpBlock.style.display="block";}m_rollbutton.innerHTML="<img src='"+c_rolldownImage+"' />";}};this.serialize=function(){var string=encodeURIComponent(me.getName())+"]"+encodeURIComponent(me.getRollState())+"]";for(var i=0;i<m_scratchpadItems.length;i++){string+=m_scratchpadItems[i].serialize();}return string+"}";};};ScratchpadItem=function(){var me=this;var m_mediaProperties;var m_collection;var m_imageWidth;var m_imageHeight;var m_state;var m_mouseIn;var m_focused;var m_callback;this.m_imageframe;var m_container;var m_imageContainer;var m_actionsContainer;var m_removeButton;var m_image;var m_metadata;var m_metadataURL;var m_metadataFilesize;var m_metadataDimensions;var m_metadataFilename;var c_imageSize=72;var c_frameBorder=4;var c_imageContainerHeight=82;var c_opacityDraggable=90;var c_opacityNormal=100;this.initialize=function initialize(mediaProperties,callback){m_callback=callback;m_container=document.createElement("a");m_container.className="scratchpad_item";m_container.href="#";m_imageContainer=document.createElement("div");m_imageContainer.className="scratchpad_item_imagecontainer";m_metadata=document.createElement("a");m_metadata.className="scratchpad_metadata";m_metadata.tabIndex=-1;m_metadata.href="#";m_metadataFilename=document.createElement("div");m_metadataFilename.className="scratchpad_metadata_filename";m_metadata.appendChild(m_metadataFilename);m_metadataDimensions=document.createElement("div");m_metadataDimensions.className="scratchpad_metadata_dimensions";m_metadata.appendChild(m_metadataDimensions);m_metadataFilesize=document.createElement("div");m_metadataFilesize.className="scratchpad_metadata_filesize";m_metadata.appendChild(m_metadataFilesize);m_metadataURL=document.createElement("div");m_metadataURL.className="scratchpad_metadata_url";m_metadata.appendChild(m_metadataURL);this.m_imageframe=document.createElement("div");this.m_imageframe.className="scratchpad_imageframe";m_imageContainer.appendChild(this.m_imageframe);m_actionsContainer=document.createElement("div");m_actionsContainer.className="scratchpad_item_actions";m_metadata.appendChild(m_actionsContainer);m_removeButton=document.createElement("a");m_removeButton.innerHTML="<img src='s/live/glyph_close_rest.gif' class='close_button_img' />";m_removeButton.className="close_button";m_removeButton.href="#";m_removeButton.style.zIndex="255";m_container.appendChild(m_imageContainer);m_container.appendChild(m_metadata);m_container.appendChild(m_removeButton);MMUtil.addListener(m_removeButton,"click",me.removeAction,true);MMUtil.addListener(m_container,"mouseover",me.mouseoverAction,true);MMUtil.addListener(m_container,"mouseout",me.mouseoutAction,true);MMUtil.addListener(m_container,"focus",me.focusAction,true);MMUtil.addListener(m_container,"blur",me.blurAction,true);MMUtil.addListener(m_metadata,"focus",me.focusAction,true);MMUtil.addListener(m_metadata,"blur",me.blurAction,true);MMUtil.addListener(m_removeButton,"focus",me.focusAction,true);MMUtil.addListener(m_removeButton,"blur",me.blurAction,true);MMUtil.addListener(m_container,"click",me.clickImageAction,true);MMUtil.addListener(m_container,"focus",me.updateHref,true);MMUtil.addListener(m_container,"mouseover",me.updateHref,true);me.hide();me.setMediaProperties(mediaProperties);me.setStyleNormal();m_mouseIn=false;m_focused=false;this.setHref(MMUtil.getState().fi=="true");};this.dispose=function dispose(){MMUtil.removeListener(m_removeButton,"click",me.removeAction);MMUtil.removeListener(m_container,"mouseover",me.mouseoverAction);MMUtil.removeListener(m_container,"mouseout",me.mouseoutAction);MMUtil.removeListener(m_container,"click",me.clickImageAction);MMUtil.removeListener(m_container,"focus",me.updateHref);MMUtil.removeListener(m_container,"mouseover",me.updateHref);MMUtil.removeListener(m_container,"focus",me.focusAction);MMUtil.removeListener(m_container,"blur",me.blurAction);MMUtil.removeListener(m_metadata,"focus",me.focusAction);MMUtil.removeListener(m_metadata,"blur",me.blurAction);MMUtil.removeListener(m_removeButton,"focus",me.focusAction);MMUtil.removeListener(m_removeButton,"blur",me.blurAction);MMUtil.removeListener(me.getImageContainer(),"mousedown",me.mouseDown);MMUtil.removeListener(me.getMetaContainer(),"mousedown",me.mouseDown);m_callback=null;m_collection=null;m_mediaProperties.dispose();me=m_container=m_imageContainer=m_metadata=m_metadataFilename=null;m_metadataDimensions=m_metadataFilesize=m_metadataURL=this.m_imageframe=null;m_actionsContainer=m_removeButton=null;};this.setHref=function setHref(fi){url=location.href;url=url.replace(/#.*/,"");url+="#focal="+m_mediaProperties.mediahash+"&furl="+m_mediaProperties.mediaurl+(fi?"&fi=true":"");m_container.href=url;m_metadata.href=url;m_removeButton.href=url;};this.updateHref=function updateHref(fi){me.setHref(MMUtil.getState().fi);};this.mouseDown=function(e){if(!e)e=window.event;e.cancelBubble=true;if(e.preventDefault)e.preventDefault();MMUtil.scratchpad.itemMouseDown(me,e);return false;};this.clickImageAction=function(e){if(e&&e.preventDefault)e.preventDefault();var params={"collection":me.getCollection().getName(),"murl":me.getMediaProperties().mediaurl};MMUtil.record("scratchpad","image click",params);var target=MMUtil.getSrcElement(e);if(target==m_removeButton)me.removeAction(e);else MMUtil.scratchpad.imageClickCallback(m_mediaProperties,true);return false;};this.setCollection=function(collection){m_collection=collection;};this.getCollection=function(){return m_collection;};this.removeAction=function(e){if(e.preventDefault)e.preventDefault();if(e)e.cancelBubble=true;else{if(window.event)window.event.cancelBubble=true;}var params={"collection":me.getCollection().getName(),"murl":me.getMediaProperties().mediaurl};MMUtil.record("scratchpad","remove item",params);m_collection.removeItemByHash(m_mediaProperties.mediahash);return false;};this.mouseoverAction=function(e){if(m_state=="draggable"||MMUtil.scratchpad.isDragging)return;m_mouseIn=true;if(m_state!="hover")me.setStyleHover();};this.mouseoutAction=function(e){e.cancelBubble;if(m_state=="draggable")return;if(!MMUtil.validateMouseOut(me.getContainer(),e))return;m_mouseIn=false;if(!m_focused)me.setStyleNormal();return false;};this.focusAction=function focusAction(e){if(m_state=="draggable"||MMUtil.scratchpad.isDragging)return;m_focused=true;if(m_state!="hover")me.setStyleHover();m_collection.focus();};this.blurAction=function blurAction(e){e.cancelBubble;m_focused=false;if(m_state=="draggable")return;if(!m_mouseIn)me.setStyleNormal();m_collection.blur(e);return false;};this.setImageSize=function(size){if(!m_image)return;if(m_imageWidth>m_imageHeight){var width=size;var height=m_imageHeight*size/m_imageWidth;}else{var height=size;var width=m_imageWidth*size/m_imageHeight;}setStyleDimension(m_image,"width",width);setStyleDimension(m_image,"height",height);setStyleDimension(me.m_imageframe,"width",width);setStyleDimension(me.m_imageframe,"height",height);var frametop=(c_imageContainerHeight-height)/2-c_frameBorder;setStyleDimension(me.m_imageframe,"top",frametop);function setStyleDimension(element,property,value){element.style[property]=(value<0?0:value)+"px";}};this.setMediaProperties=function(mediaProperties){if(!mediaProperties)return;m_mediaProperties=mediaProperties.clone();m_mediaProperties.setCallback(me.receiveImage);m_mediaProperties.fetch();};this.getMediaProperties=function(){return m_mediaProperties;};this.receiveImage=function(mediaProperties,success){if(success){m_mediaProperties=mediaProperties;m_image=mediaProperties.image;m_imageWidth=m_image.width;m_imageHeight=m_image.height;m_image.className="scratchpad_image";m_container.scratchpadItemHash=mediaProperties.mediahash;me.m_imageframe.appendChild(m_image);me.setImageSize(c_imageSize);var dimString=L_dimensions_Text+" "+mediaProperties.getResolutionString();var sizeString=L_filesize_Text+" "+mediaProperties.getFileSizeString();MMUtil.setText(m_metadataDimensions,dimString);m_metadataDimensions.title=dimString;MMUtil.setText(m_metadataFilesize,sizeString);m_metadataFilesize.title=sizeString;MMUtil.setText(m_metadataURL,mediaProperties.mediaurl);m_metadataURL.title=mediaProperties.mediaurl;MMUtil.setText(m_metadataFilename,mediaProperties.getTitle());m_metadataFilename.title=mediaProperties.getTitle();me.show();if(m_callback)m_callback(me);}};this.getContainer=function(){return m_container;};this.getImageContainer=function(){return m_imageContainer;};this.getMetaContainer=function(){return m_metadata;};this.getHandleX=function(){return -4;};this.getHandleY=function(){return -4;};this.hide=function(){m_container.style.display="none";};this.show=function(){m_container.style.display="block";};this.createDraggableHandle=function(){try{m_imageContainer.removeChild(me.m_imageframe);}catch(e){}me.setStyleDraggable();return me.m_imageframe;};this.getDraggableHandle=function(){return me.m_imageframe;};this.releaseDraggableHandle=function(){me.setStyleNormal();m_imageContainer.appendChild(me.m_imageframe);};this.setStyleDraggable=function(){if(m_state=="draggable")return;me.show();m_container.className="scratchpad_item_draggable";MMUtil.setOpacity(me.m_imageframe,c_opacityDraggable);m_state="draggable";};this.setStyleNormal=function(){m_container.className="scratchpad_item";MMUtil.setOpacity(me.m_imageframe,c_opacityNormal);me.m_imageframe.style.left="";me.m_imageframe.style.top="";me.show();me.setImageSize(c_imageSize);m_state="normal";};this.setStyleHover=function(){me.show();m_container.className="scratchpad_item_hover";me.setImageSize(c_imageSize);MMUtil.setOpacity(me.m_imageframe,c_opacityNormal);m_state="hover";};this.serialize=function(){return me.getMediaProperties().mediaurl+"]";};};var c_padding=4;var c_borderWidth=1;var c_shadowWidth=4;var c_innerExtra=30;var c_maxContainerSize=200;var c_metaContainerWidth=c_maxContainerSize+20;var c_metaContainerBorderWidth=1;var c_metaContainerPadding=4;var c_metaContainerSpacing=7;var c_imageExtra=(c_padding+c_borderWidth)*2;var c_imageSpacing=22;ResultItem=function(){var me=this;this.container=null;this.innerContainer=null;this.m_shadow=null;this.metaDisplay=null;this.m_thumbnailImage=null;this.imageListeners=[];this.metaDisplayListeners=[];this.m_hidden=true;this.m_containerTop=0;this.m_containerLeft=0;this.m_displaySize=0;this.m_innerContainerWidth=0;this.m_innerContainerHeight=0;this.m_thumbnailWidth=0;this.m_thumbnailHeight=0;this.m_containerSizeUpdated=false;this.m_containerPosUpdated=false;this.properties=null;this.m_growDuration=0;this.m_growStartTime=0;this.m_growStartWidth=0;this.m_growStartHeight=0;this.m_state="shrunk";this.m_growWidthPix=0;this.m_growHeightPix=0;this.m_growTopDelta=0;this.m_growLeftDelta=0;this.m_growFinalTop=0;this.m_growFinalLeft=0;this.m_growShiftLeftPix=0;this.m_growShiftTopPix=0;this.m_growBaseInterval=5;this.growDelayTimer=null;this.shrinkDelayTimer=null;this.m_growIntervalTimer=null;this.m_growCompleteCallback=null;var m_innerHTML=["<a class='result_a' href='#' style='left:",null,"px;top:",null,"px'><div style='width:",null,"px;height:",null,"px'></div>",null,"</a>"];ResultItem.prototype.initialize=function initialize(panel,mediaProperties,displaySize,xPos,yPos){this.properties=mediaProperties;this.m_displaySize=displaySize;this.m_containerTop=yPos;this.m_containerLeft=xPos;this.container=MMUtil.createElement("result_"+this.properties.rank,panel,"div","result");if(this.container.parentNode!==panel)panel.appendChild(this.container);this.container.style.top=yPos+"px";this.container.style.left=xPos+"px";this.container.style.width=displaySize+"px";this.container.style.height=displaySize+"px";this.m_thumbnailWidth=this.getThumbnailWidth();this.m_thumbnailHeight=this.getThumbnailHeight();if(!this.container.firstChild){m_innerHTML[5]=this.m_thumbnailWidth;m_innerHTML[7]=this.m_thumbnailHeight;m_innerHTML[1]=this.getThumbnailXPos();m_innerHTML[3]=this.getThumbnailYPos();this.container.innerHTML=m_innerHTML.join("");}this.innerContainer=this.container.firstChild;this.m_shadow=this.innerContainer.firstChild;MMUtil.addListener(this.innerContainer,"focus",this.focusAction);MMUtil.addListener(this.innerContainer,"focus",this.updateHref);MMUtil.addListener(this.innerContainer,"mouseover",this.updateHref);this.m_thumbnailImage=mediaProperties.image;MMUtil.setAlt(this.m_thumbnailImage,mediaProperties.getTitle());this.m_thumbnailImage.className="img_thumb";this.container.md5=this.properties.mediahash;};ResultItem.prototype.dispose=function dispose(){if(this.metaDisplay)this.metaDisplay.dispose();if(this.shrinkDelayTimer)clearTimeout(this.shrinkDelayTimer);if(this.growDelayTimer)clearTimeout(this.growDelayTimer);if(this.m_growIntervalTimer)clearTimeout(this.m_growIntervalTimer);this.m_growCompleteCallback=null;MMUtil.removeListener(this.innerContainer,"focus",this.focusAction);MMUtil.removeListener(this.innerContainer,"focus",this.updateHref);MMUtil.removeListener(this.innerContainer,"mouseover",this.updateHref);while(this.imageListeners&&this.imageListeners.length){var l=this.imageListeners.pop();if(l.attached)MMUtil.removeListener(l.el,l.evt,l.method);}this.container=null;this.m_shadow=null;this.innerContainer=null;this.m_thumbnailImage=null;me=null;};ResultItem.prototype.createMetaDisplay=function createMetaDisplay(){this.metaDisplay=new ImageMetaDisplay("md");this.metaDisplay.initialize();};ResultItem.prototype.unsetMediaItem=function unsetMediaItem(){if(!this.properties)return;this.properties=null;if(this.m_thumbnailImage&&MMUtil.getParentElement(this.m_thumbnailImage)===this.m_shadow)this.innerContainer.removeChild(this.m_thumbnailImage);this.m_thumbnailImage=null;while(this.imageListeners&&this.imageListeners.length){var l=this.imageListeners.pop();if(l.attached)MMUtil.removeListener(l.el,l.evt,l.method);}if(this.metaDisplay)this.metaDisplay.hide();while(this.metaDisplayListeners&&this.metaDisplayListeners.length){var l=this.metaDisplayListeners.pop();if(l.attached)MMUtil.removeListener(l.el,l.evt,l.method);}this.container.style.display="none";};ResultItem.prototype.setHref=function setHref(fi){if(this.properties.mediahash&&this.properties.mediaurl){url=location.href;url=url.replace(/#.*/,"");url+="#focal="+this.properties.mediahash+"&furl="+this.properties.mediaurl+(fi?"&fi=true":"");this.innerContainer.href=url;}};ResultItem.prototype.updateHref=function updateHref(e){me.setHref(MMUtil.getState().fi=="true");return true;};ResultItem.prototype.addListener=function addImageListener(listener){if(this.properties.loaded){MMUtil.addListener(listener.el,listener.evt,listener.method,true);listener.attached=true;}else listener.attached=false;this.imageListeners.push(listener);};ResultItem.prototype.addImageListener=function addImageListener(evt,method){var listener={"el":this.innerContainer,"evt":evt,"method":method};this.addListener(listener);};ResultItem.prototype.addAnchorListener=function addContainerListener(evt,method){var listener={"el":this.innerContainer,"evt":evt,"method":method};this.addListener(listener);};ResultItem.prototype.attachImageListeners=function attachImageListeners(){for(var l=0;l<this.imageListeners.length;l++){var listener=this.imageListeners[l];if(!listener.attached){MMUtil.addListener(listener.el,listener.evt,listener.method,true);listener.attached=true;}}};ResultItem.prototype.addMetaDisplayListener=function addMetaDisplayListener(evt,method){var listener={"evt":evt,"method":method};if(this.metaDisplay){MMUtil.addListener(this.metaDisplay.container,evt,method,true);listener.el=this.metaDisplay.container;listener.attached=true;}else listener.attached=false;this.metaDisplayListeners.push(listener);};ResultItem.prototype.attachMetaDisplayListeners=function attachMetaDisplayListeners(){for(var l=0;l<this.metaDisplayListeners.length;l++){var listener=this.metaDisplayListeners[l];if(!listener.attached){listener.el=this.metaDisplay.container;MMUtil.addListener(listener.el,listener.evt,listener.method,true);listener.attached=true;}}};ResultItem.prototype.setPosition=function setPosition(newLeft,newTop){MMUtil.assert(typeof newLeft=="number"&&typeof newTop=="number","Invalid parameter to setPosition");if(newTop!=null){if(newTop!=this.m_containerTop){if(!this.m_containerPosUpdated)this.oldTop=this.m_containerTop;this.m_containerPosUpdated=true;}this.m_containerTop=newTop;}if(newLeft!=null){if(newLeft!=this.m_containerLeft)this.m_containerPosUpdated=true;this.m_containerLeft=newLeft;}};ResultItem.prototype.setContainerSize=function setContainerSize(newSize){if(newSize!=this.m_displaySize){this.m_containerSizeUpdated=true;this.m_displaySize=newSize;}};ResultItem.prototype.getThumbnailScale=function getThumbnailScale(){var scale=(this.m_displaySize-c_imageExtra-c_innerExtra)/this.properties.maxDimension;if(scale>1)scale=1;return scale;};ResultItem.prototype.getThumbnailWidth=function getThumbnailWidth(){var scale=this.getThumbnailScale();return Math.max(Math.floor(this.properties.thumbnailwidth*scale)-c_shadowWidth,1);};ResultItem.prototype.getThumbnailHeight=function getThumbnailHeight(){var scale=this.getThumbnailScale();return Math.max(Math.floor(this.properties.thumbnailheight*scale)-c_shadowWidth,1);};ResultItem.prototype.setThumbnailDimensions=function setThumbnailDimensions(newWidth,newHeight){if(this.m_shadow.parentNode==null){this.m_shadow=this.innerContainer.firstChild.firstChild;this.m_thumbnailImage=this.m_shadow.firstChild;}if(newWidth&&newHeight){this.m_thumbnailWidth=newWidth;this.m_thumbnailHeight=newHeight;}else{this.m_thumbnailHeight=this.getThumbnailHeight();this.m_thumbnailWidth=this.getThumbnailWidth();}if(this.m_thumbnailImage){this.m_thumbnailImage.style.height=this.m_thumbnailHeight+"px";this.m_thumbnailImage.style.width=this.m_thumbnailWidth+"px";}this.m_shadow.style.height=this.m_thumbnailHeight+"px";this.m_shadow.style.width=this.m_thumbnailWidth+"px";};ResultItem.prototype.getThumbnailXPos=function getThumbnailXPos(){this.m_innerContainerWidth=this.m_thumbnailWidth+c_imageExtra+c_innerExtra;return Math.floor((this.m_displaySize-this.m_innerContainerWidth)/2);};ResultItem.prototype.getThumbnailYPos=function getThumbnailYPos(){this.m_innerContainerHeight=this.m_thumbnailHeight+c_imageExtra+c_innerExtra;return Math.floor((this.m_displaySize-this.m_innerContainerHeight)/2);};ResultItem.prototype.centerThumbnail=function centerThumbnail(){this.innerContainer.style.left=this.getThumbnailXPos()+"px";this.innerContainer.style.top=this.getThumbnailYPos()+"px";};ResultItem.prototype.thumbLoadCallback=function thumbLoadCallback(){this.m_shadow.style.height="1px";this.m_shadow.style.width="1px";this.setThumbnailDimensions();this.m_shadow.appendChild(this.m_thumbnailImage);this.m_thumbnailImage.style.visibility="visible";this.attachImageListeners();this.display();};ResultItem.prototype.display=function display(force){if(this.m_containerPosUpdated||force){this.container.style.top=this.m_containerTop+"px";this.container.style.left=this.m_containerLeft+"px";this.m_containerPosUpdated=false;}if(this.m_containerSizeUpdated||force){this.container.style.width=this.m_displaySize+"px";this.container.style.height=this.m_displaySize+"px";this.setThumbnailDimensions();this.centerThumbnail();this.m_containerSizeUpdated=false;}};ResultItem.prototype.renderMeta=function renderMeta(maxRight,minTop,maxTop){MMUtil.assert(typeof maxRight=="number"&&typeof minTop=="number"&&typeof maxTop=="number","Invalid parameter to renderMeta");if(!this.metaDisplay){this.createMetaDisplay();this.attachMetaDisplayListeners();}if(!this.metaDisplay.rendered){this.metaDisplay.setMedia(this.properties);this.container.appendChild(this.metaDisplay.container);this.metaDisplay.render(this.properties,this.properties.thumbnailwidth+c_imageExtra+c_innerExtra,this.properties.thumbnailheight+c_imageExtra+c_innerExtra,true);}return this.adjustGrowBounds(maxRight,minTop,maxTop-5);};ResultItem.prototype.hide=function hide(){this.m_thumbnailImage.style.visibility="hidden";this.m_hidden=true;};ResultItem.prototype.getState=function getState(){return this.m_state;};ResultItem.prototype.setCursor=function setCursor(cursor){this.m_thumbnailImage.style.cursor=cursor;};ResultItem.prototype.getRank=function getRank(){return this.properties.rank;};ResultItem.prototype.focusAction=function focusAction(e){if(MMUtil.focusedItem&&MMUtil.focusedItem!=me){MMUtil.focusedItem.shrink();me.bulge();}MMUtil.focusedItem=me;};ResultItem.prototype.bulge=function bulge(){if(this.m_state!="shrunk"||MMUtil.scratchpad&&MMUtil.scratchpad.isDragging)return;this.setThumbnailDimensions(this.m_thumbnailWidth+c_shadowWidth,this.m_thumbnailHeight+c_shadowWidth);this.centerThumbnail();this.m_state="bulged";if(!this.metaDisplay){this.createMetaDisplay();this.attachMetaDisplayListeners();this.metaDisplay.setMedia(this.properties);}};ResultItem.prototype.shrink=function shrink(){if(this.m_state=="shrunk")return false;if(this.shrinkDelayTimer){clearTimeout(this.shrinkDelayTimer);this.shrinkDelayTimer=null;}if(this.growDelayTimer){clearTimeout(this.growDelayTimer);this.growDelayTimer=null;}if(this.m_growIntervalTimer){clearTimeout(this.m_growIntervalTimer);this.m_growIntervalTimer=null;}this.setThumbnailDimensions();this.container.style.zIndex=0;this.container.style.left=this.m_containerLeft+"px";this.container.style.top=this.m_containerTop+"px";this.centerThumbnail();if(this.metaDisplay&&this.metaDisplay.rendered){this.metaDisplay.container.parentNode.removeChild(this.metaDisplay.container);this.metaDisplay.hide();this.metaDisplay.rendered=false;}this.m_state="shrunk";return true;};ResultItem.prototype.initializeGrow=function initializeGrow(duration){this.m_growDuration=duration;this.m_growStartWidth=this.m_thumbnailWidth+c_shadowWidth;this.m_growStartHeight=this.m_thumbnailHeight+c_shadowWidth;this.m_growWidthPix=this.m_growHeightPix=0;var deltaHeight=this.properties.thumbnailheight-this.m_growStartHeight;var deltaWidth=this.properties.thumbnailwidth-this.m_growStartWidth;var dRat=deltaHeight/deltaWidth;var minDiff=Math.abs(1-dRat);var wPixBase=1;var hPixBase=1;if(minDiff!=0)for(var h=1;h<5;h++){for(var w=1;w<5;w++){var diff=Math.abs(h/w-dRat);if(diff<minDiff){minDiff=diff;wPixBase=w;hPixBase=h;}}}wPixBase*=2;hPixBase*=2;this.m_growBaseInterval=0;while(this.m_growBaseInterval<5){this.m_growWidthPix+=wPixBase;this.m_growHeightPix+=hPixBase;var nStepsOptimal=Math.min(Math.ceil(Math.abs(deltaHeight/this.m_growHeightPix)),Math.ceil(Math.abs(deltaWidth/this.m_growWidthPix)));this.m_growBaseInterval=Math.floor(this.m_growDuration/nStepsOptimal);}if(this.m_growBaseInterval>20)this.m_growBaseInterval=20;this.growDelayTimer=null;this.container.style.zIndex=100;this.innerContainer.style.zIndex=2;this.m_growStartTime=0;};ResultItem.prototype.adjustGrowBounds=function adjustGrowBounds(maxRight,minTop,maxTop){var metaHeight=this.metaDisplay.getHeight();if(metaHeight+160-this.properties.thumbnailheight>maxTop-minTop)return false;var naturalLeft=this.m_containerLeft-(c_metaContainerWidth-this.m_displaySize)/2;var naturalTop=this.m_containerTop-(c_maxContainerSize-this.m_displaySize)/2;this.m_growFinalLeft=0;this.m_growFinalTop=0;if(naturalLeft<c_metaContainerSpacing)this.m_growFinalLeft=c_metaContainerSpacing+1;else{if(naturalLeft+c_metaContainerWidth+c_metaContainerBorderWidth*2>maxRight)this.m_growFinalLeft=maxRight-c_metaContainerWidth-c_metaContainerBorderWidth*2-1;else this.m_growFinalLeft=naturalLeft;}var metaOffsetTop=Math.floor((c_maxContainerSize-this.properties.thumbnailheight)/2)-c_imageExtra-this.metaDisplay.getThumbnailTop();if(naturalTop+metaOffsetTop<minTop)this.m_growFinalTop=minTop-metaOffsetTop;else{if(naturalTop+metaOffsetTop+metaHeight>maxTop)this.m_growFinalTop=maxTop-metaHeight-metaOffsetTop;else this.m_growFinalTop=naturalTop;}var nSteps=Math.ceil(this.m_growDuration/this.m_growBaseInterval);this.m_growLeftDelta=naturalLeft-this.m_growFinalLeft;this.m_growShiftLeftPix=Math.ceil(this.m_growLeftDelta/nSteps);this.m_growTopDelta=naturalTop-this.m_growFinalTop;this.m_growShiftTopPix=Math.ceil(this.m_growTopDelta/nSteps);var metaLeft=this.m_growFinalLeft-this.m_containerLeft-c_metaContainerPadding*2;var metaTop=this.m_growFinalTop-this.m_containerTop+metaOffsetTop;this.metaDisplay.setPosition(metaLeft,metaTop,c_metaContainerWidth);return true;};ResultItem.prototype.growBegin=function growBegin(onGrowComplete){if(MMUtil.scratchpad&&MMUtil.scratchpad.isDragging)return;if(this.m_state!="bulged")this.bulge();this.m_state="growing";this.m_growCompleteCallback=onGrowComplete;var me=this;this.m_growIntervalTimer=setInterval(function(){me.growTick();},this.m_growBaseInterval);};ResultItem.prototype.growTick=function growTick(){var d=new Date();var t=d.getTime();if(this.m_growStartTime==0)this.m_growStartTime=t;var elapsed=t-this.m_growStartTime;var stepNum=Math.floor(elapsed/this.m_growBaseInterval)+1;var width=this.m_growStartWidth+stepNum*this.m_growWidthPix;var height=this.m_growStartHeight+stepNum*this.m_growHeightPix;if(width<this.properties.thumbnailwidth&&height<this.properties.thumbnailheight){this.setThumbnailDimensions(width,height);this.m_innerContainerHeight=this.m_thumbnailHeight+c_imageExtra+c_innerExtra;this.m_innerContainerWidth=this.m_thumbnailWidth+c_imageExtra+c_innerExtra;this.innerContainer.style.left=-this.m_growShiftLeftPix*stepNum+Math.floor((this.m_displaySize-this.m_innerContainerWidth)/2)+"px";this.innerContainer.style.top=-this.m_growShiftTopPix*stepNum+Math.floor((this.m_displaySize-this.m_innerContainerHeight)/2)+"px";}else{if(this.m_growIntervalTimer){clearInterval(this.m_growIntervalTimer);this.m_growIntervalTimer=null;}this.setGrowFinal();this.m_growCompleteCallback(this,"mouse");this.m_growCompleteCallback=null;}};ResultItem.prototype.setGrowFinal=function setGrowFinal(){this.setThumbnailDimensions(this.properties.thumbnailwidth,this.properties.thumbnailheight);this.m_innerContainerHeight=this.m_thumbnailHeight+c_imageExtra+c_innerExtra;this.m_innerContainerWidth=this.m_thumbnailWidth+c_imageExtra+c_innerExtra;this.innerContainer.style.left=-this.m_growLeftDelta+Math.floor((this.m_displaySize-this.m_innerContainerWidth)/2)+"px";this.innerContainer.style.top=-this.m_growTopDelta+Math.floor((this.m_displaySize-this.m_innerContainerHeight)/2)+"px";this.metaDisplay.show();this.m_state="grown";};ResultItem.prototype.getTopDelta=function getTopDelta(){return this.m_growTopDelta;};this.imageMouseDown=function imageMouseDown(e){if(MMUtil.scratchpad)MMUtil.scratchpad.imageMouseDown(me.properties,e);};};ResultImage=function(){ResultImage.baseConstructor.call(this);ResultImage.prototype.display=function display(force){ResultImage.parentClass.display.call(this,force);if(this.properties.loaded){if(this.properties.focal)this.innerContainer.className="result_a focal";else{if(this.properties.clicked)this.innerContainer.className="result_a clicked";}}};};LiveMM.extend(ResultImage,ResultItem);MediaMetaDisplay=function(name){var me=this;this.container=null;this.containerCover=null;this.content=null;this.title=null;this.spacer=null;this.properties=null;this.page=null;this.actionsDiv=null;this.feedbackLink=null;this.scratchpadLink=null;this.dimElement=null;this.sizeElement=null;this.feedbackLinkText=L_feedbackResult_Text;this.scratchpadLinkText=L_addToScratchpad_Text;this.adultMarkLinkText="mark as adult";this.rendered=false;this.mediaProperties;this.container=MMUtil.createElement(name,null,"div","md");this.container.tabIndex=-1;this.container.style.visibility="hidden";this.containerCover=MMUtil.createElement(name+"_cover",null,"iframe","md_cover");this.containerCover.style.visibility="hidden";MMUtil.setOpacity(this.containerCover,0);this.content=MMUtil.createElement(name+"_content",this.container,"div","md_content");this.content.tabIndex=-1;this.title=MMUtil.createElement(name+"_title",this.content,"div","md_title");this.spacer=MMUtil.createElement(name+"_space_div",this.content,"div","md_space_div");this.properties=MMUtil.createElement(name+"_properties",this.content,"div","md_properties");this.spacer.style.position="relative";this.page=MMUtil.createElement(name+"_page",this.content,"div","md_page");this.actionsDiv=MMUtil.createElement(name+"_actions",this.content,"div","md_actions");MediaMetaDisplay.prototype.initialize=function initialize(){this.rendered=false;this.setHref(MMUtil.getState().fi=="true");MMUtil.addListener(this.container,"focus",this.updateHref);MMUtil.addListener(this.container,"mouseover",this.updateHref);if(MMUtil.enableScratchpad){function scratchpadLinkClick(e){if(!MMUtil.scratchpad)MMUtil.getMMSearchInstance().setModuleStatus("scratchpad","enable","Hide Scratchpad");MMUtil.scratchpad.addImage(me.mediaProperties);cancelBubbleAndRecord(e,"add_to_scratchpad_link");if(e.preventDefault)e.preventDefault();return false;}this.scratchpadLink=MMUtil.createElement(name+"_scratchpad",this.actionsDiv,"a","md_action_link");MMUtil.setText(this.scratchpadLink,this.scratchpadLinkText);this.scratchpadLink.title=this.scratchpadLinkText;MMUtil.addListener(this.scratchpadLink,"click",scratchpadLinkClick);}this.feedbackLink=MMUtil.createElement(name+"_feedback",this.actionsDiv,"a","md_action_link");MMUtil.setText(this.feedbackLink,this.feedbackLinkText);this.feedbackLink.href=MMUtil.singleFeedbackUrl;this.feedbackLink.title=this.feedbackLinkText;this.feedbackLink.target="_blank";if(MMUtil.adultMarkHost){function adultClick(e){if(!e)e=window.event;e.cancelBubble=true;if(e.preventDefault)e.preventDefault();MMUtil.m_adultDialog.display(me.mediaProperties.mediaurl,me.mediaProperties.displayurl,me.mediaProperties.thumbnailurl,me.mediaProperties.mediahash);return false;}this.adultMarkLink=MMUtil.createElement(name+"_adult",this.actionsDiv,"a",name+"_adult_mark_link");MMUtil.setText(this.adultMarkLink,this.adultMarkLinkText);this.adultMarkLink.title=this.adultMarkLinkText;MMUtil.addListener(this.adultMarkLink,"click",adultClick);}else this.adultMarkLink=null;this.dimElement=MMUtil.createElement(name+"_dim",this.properties,"div",name+"_dim");this.ccElement=MMUtil.createElement(name+"_cc",this.properties,"a",name+"_ccicon");this.ccElement.style.display="none";this.sizeElement=MMUtil.createElement(name+"_size",this.properties,"div",name+"_size");function cancelBubbleAndRecord(e,type){if(!e)e=window.event;e.cancelBubble=true;MMUtil.record("MetaDisplay",type,{"murl":me.mediaProperties.mediaurl});return false;}MMUtil.addListener(this.feedbackLink,"click",function(e){cancelBubbleAndRecord(e,"feedback_link");if(!MMUtil.isIE()){if(e.preventDefault)e.preventDefault();location.href=me.feedbackLink.href;return false;}});MMUtil.addListener(this.ccElement,"click",function(e){cancelBubbleAndRecord(e,"cc_link");});};MediaMetaDisplay.prototype.dispose=function dispose(){MMUtil.removeListener(this.container,"focus",this.updateHref);MMUtil.removeListener(this.container,"mouseover",this.updateHref);for(prop in this){delete this[prop];}};MediaMetaDisplay.prototype.setHref=function setHref(fi){if(this.mediaProperties&&this.mediaProperties.mediahash&&this.mediaProperties.mediaurl){url=location.href;url=url.replace(/#.*/,"");url+="#focal="+this.mediaProperties.mediahash+"&furl="+this.mediaProperties.mediaurl+(fi?"&fi=true":"");this.container.href=url;this.content.href=url;}};MediaMetaDisplay.prototype.updateHref=function updateHref(e){me.setHref(MMUtil.getState().fi=="true");return true;};MediaMetaDisplay.prototype.setMedia=function setMedia(properties){this.mediaProperties=properties;this.feedbackLink.href=MMUtil.getImageFeedbackUrl(properties.mediaurl);if(properties.cclicensetype&&properties.cclicenseurl)this.ccElement.style.display="block";else this.ccElement.style.display="none";this.updateHref();};MediaMetaDisplay.prototype.getHeight=function getHeight(){return this.container.offsetHeight;};MediaMetaDisplay.prototype.getThumbnailTop=function getThumbnailTop(){return this.spacer.offsetTop+c_imageSpacing;};MediaMetaDisplay.prototype.setPosition=function setPosition(left,top,width){MMUtil.assert(typeof left=="number"&&typeof top=="number"&&typeof width=="number","Invalid parameter to show");this.container.style.width=width+"px";this.container.style.top=top+"px";this.container.style.left=left+"px";this.containerCover.style.height=this.container.offsetHeight+this.container.style.borderWidth+"px";this.containerCover.style.width=this.container.offsetWidth+this.container.style.borderWidth+"px";this.containerCover.style.top=this.container.offsetTop-this.container.style.borderWidth+"px";this.containerCover.style.left=this.container.offsetLeft-this.container.style.borderWidth+"px";};MediaMetaDisplay.prototype.show=function show(){this.container.style.visibility="visible";this.containerCover.style.visibility="visible";};MediaMetaDisplay.prototype.hide=function hide(){this.container.style.visibility="hidden";this.containerCover.style.visibility="hidden";};MediaMetaDisplay.prototype.render=function render(properties,spaceWidth,spaceHeight,showScratchpad){MMUtil.assert(typeof spaceWidth=="number"&&typeof spaceHeight=="number","Invalid parameter to render");if(properties){MMUtil.setText(this.title,properties.getTitle());this.title.title=properties.getTitle();var dimString=L_dimensions_Text.replace(/%dimensions%/,"");dimString+=" "+properties.getResolutionString();var sizeString=L_filesize_Text.replace(/%filesize%/,"");sizeString+=" "+properties.getFileSizeString();MMUtil.setText(this.dimElement,dimString);this.dimElement.title=dimString;MMUtil.setText(this.sizeElement,sizeString);this.sizeElement.title=sizeString;if(this.ccElement){var ccImg=MMUtil.createElement("cc_img",this.ccElement,"img");ccImg.src="s/live/cc.gif";this.ccElement.target="_blank";if(properties.cclicenseurl)this.ccElement.href=properties.cclicenseurl;else this.ccElement.href="http://www.creativecommons.org";}var url;try{url=decodeURIComponent(properties.displayurl);}catch(e){url=unescape(properties.displayurl);}var i=url.indexOf("http://");if(i!=-1)url=url.substring(i+7);url=url.replace(/</,"&lt;");url=url.replace(/>/,"&gt;");MMUtil.setText(this.page,url);}if(this.scratchpadLink){if(MMUtil.enableScratchpad&&showScratchpad)this.scratchpadLink.style.display="block";else this.scratchpadLink.style.display="none";}if(this.adultMarkLink&&!MMUtil.adultMarkHost)this.adultMarkLink.style.display="none";this.spacer.style.width=spaceWidth+c_imageSpacing+"px";this.spacer.style.height=spaceHeight+c_imageSpacing+"px";this.rendered=true;};};ImageMetaDisplay=function(fullMedia){ImageMetaDisplay.baseConstructor.call(this,fullMedia);this.feedbackLinkText=L_feedbackImage_Text;};LiveMM.extend(ImageMetaDisplay,MediaMetaDisplay);ResultsPanel=function(m_el,m_message){var me=this;var m_context=null;var m_contextSafeSearch=null;var m_contextSafeSearchLink=null;var m_bullet;var m_scrollPanelContainer=m_el;var m_scrollPanelElement=null;var m_thumbLoadingElement=null;var m_contextBar=null;var m_contextControlsDiv=null;var m_sizerDiv=null;var m_options=null;var m_scratchpad=null;var m_spacer=null;var m_messageDiv=m_message;var m_sizer=null;var m_scrollPanel=null;var m_imageEventControl=null;var m_imageSizeControl=null;this.closeFullImageCallback=null;this.setLoadingCallback=null;var m_currentFocal=null;var m_currentPivot=null;var m_pruneDelay=null;var m_scrollCompleteDelay=null;var m_fullPositionTimeout=null;var c_loadingResultsMessage=MMUtil.scope=="video"?L_loadingVideos_Message:L_loadingImages_Message;function setLoadingCallback(loading){MMUtil.getState()._loading=loading;if(loading)m_thumbLoadingElement.style.display="block";else{if(!loading)m_thumbLoadingElement.style.display="none";}}function optionsClick(){var qs="";if(MMUtil.query&&MMUtil.query.parameters)qs=MMUtil.query.parameters.getParameter("queryString");var url=MMUtil.getHTMLUrl(qs,MMUtil.getState().imagesize,"IR");m_options.href="/settings.aspx?ru="+encodeURIComponent(url);}this.initialize=function initialize(closeFullImageCallback,imageClickCallback){m_contextBar=document.getElementById("context_bar_div");m_context=MMUtil.createPageElement("context",m_contextBar);m_contextSafeSearchLink=null;if(!MMUtil.isAdultStaticSettingMarket){m_bullet=MMUtil.createPageElement("context_bullet",m_contextBar,"span");m_bullet.innerHTML="<b>&#0183;</b>";m_contextSafeSearch=MMUtil.createPageElement("context_safesearch",m_contextBar,"span");if(MMUtil.getAdultPreference().toLowerCase()=="off")m_contextSafeSearch.innerHTML="<a href='/settings.aspx' id='context_safesearch_link' class='context_safesearch'>"+L_safeCurrStatusOff_Message+"</a>";else{if(MMUtil.getAdultPreference().toLowerCase()=="demote")m_contextSafeSearch.innerHTML="<a href='/settings.aspx' id='context_safesearch_link' class='context_safesearch'>"+L_safeCurrStatusMod_Message+"</a>";else{if(MMUtil.getAdultPreference().toLowerCase()=="strict")m_contextSafeSearch.innerHTML="<a href='/settings.aspx' id='context_safesearch_link' class='context_safesearch'>"+L_safeCurrStatusOn_Message+"</a>";}}m_contextSafeSearchLink=document.getElementById("context_safesearch_link");this.setContextSafeSearchUrl();}m_contextControlsDiv=MMUtil.createElement("context_controls",m_contextBar);var controlsHole=document.getElementById("sc_rslth1f");if(controlsHole)controlsHole.appendChild(m_contextControlsDiv);m_sizerDiv=MMUtil.createPageElement("sizer_slider",m_contextControlsDiv,"div");m_sizer=new SizerScroller(m_sizerDiv);m_sizer.initialize("sizer",this.setLevelOfDetail);m_imageSizeControl=new ImageSizeControl();m_imageSizeControl.initialize(m_contextControlsDiv);if(MMUtil.enableScratchpad){m_scratchpad=MMUtil.createElement("scratchpad_toggle",m_contextControlsDiv,"a");m_scratchpad.href="#";m_scratchpad.title=L_scratchpadTitle_Text;m_spacer=MMUtil.createPageElement("context_spacer",m_contextControlsDiv,"span");m_spacer.innerHTML="|";}m_options=MMUtil.createElement("options",m_contextControlsDiv,"a");m_options.href="/settings.aspx";m_options.title=L_optionsLink_Text;MMUtil.setText(m_options,L_optionsLink_Text);m_scrollPanelElement=MMUtil.createElement("scroll_panel",m_scrollPanelContainer);m_scrollPanel=new ScrollPanel(m_scrollPanelElement);m_scrollPanel.initialize();m_thumbLoadingElement=MMUtil.createElement("thumb_loading",m_scrollPanelContainer);m_thumbLoadingElement.style.display="none";m_thumbLoadingElement.innerHTML="<img src='img/loading.gif' style='vertical-align:top;margin-right:2px;'><span id='thumb_loading_text'>"+c_loadingResultsMessage+"</span>";MMUtil.setOpacity(m_thumbLoadingElement,70);this.closeFullImageCallback=closeFullImageCallback;this.setLoadingCallback=setLoadingCallback;m_imageEventControl=new ImageEventControl(m_scrollPanel,this);m_imageEventControl.initialize(imageClickCallback);if(MMUtil.isIE())MMUtil.addListener(document.body,"keydown",this.onKeyPress);else MMUtil.addListener(document,"keydown",this.onKeyPress);MMUtil.addListener(m_scrollPanelContainer,"scroll",this.onScroll);MMUtil.addListener(m_options,"click",optionsClick);MMUtil.addListener(m_options,"mouseover",optionsClick);if(m_contextSafeSearchLink){MMUtil.addListener(m_contextSafeSearchLink,"mouseover",this.setContextSafeSearchUrl);MMUtil.addListener(m_contextSafeSearchLink,"click",this.setContextSafeSearchUrl);}m_sizer.setValue(MMUtil.getPreference("lod"),true);};this.setContextSafeSearchUrl=function setContextSafeSearchUrl(){if(m_contextSafeSearchLink)m_contextSafeSearchLink.href="/settings.aspx?ru="+encodeURIComponent(location.href);};this.dispose=function dispose(){if(m_imageSizeControl)m_imageSizeControl.dispose();if(m_imageEventControl)m_imageEventControl.dispose();if(m_sizer)m_sizer.dispose();if(m_scrollPanel)m_scrollPanel.dispose();if(MMUtil.isIE())MMUtil.removeListener(document.body,"keydown",this.onKeyPress);else MMUtil.removeListener(document,"keydown",this.onKeyPress);MMUtil.removeListener(m_scrollPanelContainer,"scroll",this.onScroll);MMUtil.removeListener(m_options,"click",optionsClick);MMUtil.removeListener(m_options,"mouseover",optionsClick);if(m_contextSafeSearchLink){MMUtil.removeListener(m_contextSafeSearchLink,"mouseover",this.setContextSafeSearchUrl);MMUtil.removeListener(m_contextSafeSearchLink,"click",this.setContextSafeSearchUrl);}me=m_el=m_message=m_context=m_scrollPanelContainer=m_scrollPanelElement=null;m_thumbLoadingElement=m_contextBar=m_contextControlsDiv=m_sizerDiv=m_options=null;m_bullet=m_scratchpad=m_spacer=m_messageDiv=m_fullPositionTimeout=null;};this.setContext=function setContext(){if(MMUtil.getState()._page=="loading"||MMUtil.getState()._page=="viewloading"||!MMUtil.query)return;var first=m_scrollPanel.getFirstDisplayedRank();var last=Math.min(MMUtil.query.maxAssignedRank+1,m_scrollPanel.getLastDisplayedRank());var total=MMUtil.query.totalResults;if(first==me.lastFirst&&last==me.lastLast&&total==me.lastTotal)return;me.lastFirst=first;me.lastLast=last;me.lastTotal=total;var totalString=total+"";var sTotal=total+"";if(total){var index=sTotal.length%3;totalString=sTotal.substring(0,index);while(index<sTotal.length){if(index)totalString+=MMUtil.thousandsSeparator;totalString+=sTotal.substring(index,index+3);index+=3;}}var context=L_contextImage_Text;context=context.replace(/%first%/,first+1);context=context.replace(/%last%/,last);context=context.replace(/%total%/,totalString);while(m_context.firstChild){m_context.removeChild(m_context.firstChild);}contextQuerySpan=MMUtil.createElement("",m_context,"span","context_div_query");MMUtil.setText(contextQuerySpan,MMUtil.query.parameters.getDisplayQuery());contextRangeSpan=MMUtil.createElement("",m_context,"span","context_div_range");MMUtil.setText(contextRangeSpan,context);var newLookAndFeelContext=document.getElementById("count");if(newLookAndFeelContext)MMUtil.setText(newLookAndFeelContext,context);};this.setContextMessage=function setContextMessage(message){MMUtil.setText(m_context,"");while(m_context.firstChild){m_context.removeChild(m_context.firstChild);}if(message){m_context.appendChild(message);if(m_contextSafeSearch)m_contextSafeSearch.style.display="inline";if(m_bullet)m_bullet.style.display="inline";}else{if(m_contextSafeSearch)m_contextSafeSearch.style.display="none";if(m_bullet)m_bullet.style.display="none";}};this.positionImages=function positionImages(frugal){if(!MMUtil.query)return;m_scrollPanel.position(false);var lastAction=MMUtil.getState()._lastAction;if(lastAction!="scroll"&&MMUtil.getState().furl)this.centerFocalResultItem(true);else this.jumpToPivot();this.setContext();};this.setLevelOfDetail=function setLevelOfDetail(value,positionall){if(m_scrollPanel.levelOfDetail==value&&!positionall)return;MMUtil.setPreference("lod",value);m_scrollPanel.setLevelOfDetail(value);me.positionElements(true);me.positionImages(false);me.loadResults();};this.redraw=function redraw(){this.positionImages(true);clearTimeout(m_fullPositionTimeout);m_fullPositionTimeout=setTimeout(function(){me.positionImages(false);},100);m_imageSizeControl.setDisplayText();};this.setHeight=function setHeight(height){var newHeight=Math.max(22,height-m_scrollPanelContainer.offsetTop);m_scrollPanelContainer.style.height=newHeight+"px";m_scrollPanel.panelHeight=newHeight-10;};this.setHrefs=function setHrefs(){m_imageSizeControl.setHrefs();};this.positionElements=function positionElements(){m_scrollPanel.calculateLayoutValues();if(MMUtil.getState()._page=="view"){var width=m_scrollPanel.containerWidth*m_scrollPanel.numberOfColumnsToDisplay;m_scrollPanel.setPanelWidth(width);m_scrollPanelContainer.style.width=width+30+"px";m_scrollPanelElement.style.width=width+"px";m_thumbLoadingElement.style.width=width+12+"px";m_scrollPanelContainer.style.marginRight="6px";}else{m_scrollPanelContainer.style.width="auto";m_scrollPanelContainer.style.marginRight="0px";var width=Math.max(1,MMUtil.appWidth-46);if(!width)return;if(MMUtil.sidepanelShowing){var sidePanelWidth=MMUtil.getMMSearchInstance().getSidePanel().getWidth();if(MMUtil.isIE()&&!MMUtil.isIE7())sidePanelWidth+=3;width-=sidePanelWidth;m_messageDiv.style.marginRight=sidePanelWidth+"px";}else m_messageDiv.style.marginRight="0px";width=Math.max(1,width);m_scrollPanel.setPanelWidth(width);m_thumbLoadingElement.style.width=width+"px";}m_scrollPanel.calculateLayoutValues();};this.setFocalResultItem=function setFocalResultItem(resultItem){me.unsetFocalResultItem();m_currentFocal=resultItem.properties.mediahash;resultItem.properties.clicked=true;resultItem.properties.focal=true;resultItem.display();};this.unsetFocalResultItem=function unsetFocalResultItem(){if(m_currentFocal==null)return;var resultItem=MMUtil.query.getImageFromHash(m_currentFocal);if(resultItem){resultItem.properties.focal=false;resultItem.display();}m_currentFocal=null;};this.createResultItem=function createResultItem(mediaProperties){var resultItem=m_scrollPanel.createResultItem(mediaProperties);me.attachResultItemHandlers(resultItem);me.setContext();};this.processResultItem=function processResultItem(mediaProperties,query){if(!MMUtil.query||query!=MMUtil.query){mediaProperties.dispose();return;}var resultItem=query.getImage(mediaProperties.rank);resultItem.attachImageListeners();resultItem.display();};this.loadResults=function loadResults(){if(!MMUtil.query)return;var first=m_scrollPanel.getFirstDisplayedRank();var last=m_scrollPanel.getLastDisplayedRank();var count=Math.min(MMFEXParams.batchSize,m_scrollPanel.getNumberOfImagesToDisplay());MMUtil.query.loadImages(first,last,count);};this.centerFocalResultItem=function centerFocalResultItem(){var resultItem=MMUtil.query.getImageFromHash(MMUtil.getState().focal);if(!resultItem)return;var height=m_scrollPanel.panelHeight;var csize=m_scrollPanel.getContainerOffsetHeight();var imageTop=resultItem.m_containerTop;var offset=imageTop-(height-csize)/2;this.jumpToOffset(offset);};this.jumpToPivot=function jumpToPivot(){var offset=0;var resultItem=MMUtil.query.getImageFromHash(MMUtil.getState()._pivotHash);if(resultItem)offset=resultItem.m_containerTop;if(MMUtil.getState()._page=="view"){var height=m_scrollPanel.panelHeight;offset-=height/2;}this.jumpToOffset(offset);};this.jumpToOffset=function jumpToOffset(offset){m_el.scrollTop=offset;this.onScroll();};this.delayedPrune=function delayedPrune(){if(!MMUtil.isIE())return;if(m_pruneDelay)clearTimeout(m_pruneDelay);m_pruneDelay=setTimeout(function(){m_scrollPanel.pruneResults();m_pruneDelay=null;},2000);};this.setPivot=function setPivot(){if(m_currentPivot==m_scrollPanel.getFirstDisplayedRank())return;m_currentPivot=m_scrollPanel.getFirstDisplayedRank();var resultItem=MMUtil.query.getImage(m_currentPivot);if(resultItem)MMUtil.getState()._pivotHash=resultItem.properties.mediahash;else MMUtil.getState()._pivotHash=null;};this.onScroll=function onScroll(e){m_imageEventControl.cancelMeta();if(m_pruneDelay)clearTimeout(m_pruneDelay);MMUtil.getState()._scrolling=true;MMUtil.getState()._noboxes=false;me.delayedPrune();m_scrollPanel.onScroll(m_el.scrollTop);me.loadResults();me.setContext();me.setPivot();if(m_scrollCompleteDelay)clearTimeout(m_scrollCompleteDelay);m_scrollCompleteDelay=setTimeout(function(){me.onScrollComplete();},200);};this.onScrollComplete=function onScrollComplete(){m_scrollCompleteDelay=null;MMUtil.setAction("donescroll");MMUtil.getState()._scrolling=false;};this.doScroll=function(action){if(action=="home")m_el.scrollTop=0;else{if(action=="end")m_el.scrollTop=m_el.scrollHeight;else{if(action=="pageUp")m_el.scrollTop-=m_el.clientHeight;else{if(action=="pageDown")m_el.scrollTop+=m_el.clientHeight;else{if(action=="up")m_el.scrollTop-=20;else{if(action=="down")m_el.scrollTop+=20;}}}}}this.onScroll();};this.attachResultItemHandlers=function attachResultItemHandlers(resultItem){resultItem.addImageListener("mouseover",m_imageEventControl.imageFocus);resultItem.addImageListener("mouseout",m_imageEventControl.imageOut);resultItem.addAnchorListener("click",m_imageEventControl.imageClick);resultItem.addAnchorListener("focus",me.imageSelect);resultItem.addMetaDisplayListener("mouseover",m_imageEventControl.imageFocus);resultItem.addMetaDisplayListener("mouseout",m_imageEventControl.metaOut);resultItem.addMetaDisplayListener("click",m_imageEventControl.imageClick);resultItem.addImageListener("mousedown",resultItem.imageMouseDown);};this.imageSelect=function imageSelect(e){var mediaItem=m_imageEventControl.getImageFromEvent(e);if(m_imageEventControl.keyMetaMode&&mediaItem)me.jumpToOffset(mediaItem.m_containerTop,null);};this.onKeyPress=function onKeyPress(e){if(!e)e=window.event;var key=MMUtil.getKey(e);var srcElement=MMUtil.getSrcElement(e);var isQ=srcElement.id=="q";switch(key){case 9:m_imageEventControl.startKeyMetaMode();break;case 13:case 16:break;case 27:if(isQ)return;if(m_imageEventControl.targetImage){var image=m_imageEventControl.targetImage;m_imageEventControl.shrink(image);image.display();image.bulge();m_imageEventControl.endKeyMetaMode();}else{if(MMUtil.getState().fi=="true")me.closeFullImageCallback();else{if(MMUtil.query)MMUtil.query.paused=true;}}e.cancelBubble=true;break;case 33:me.doScroll("pageUp");break;case 34:me.doScroll("pageDown");break;case 38:me.doScroll("up");break;case 40:me.doScroll("down");break;case 35:if(!isQ){me.doScroll("end");if(e&&e.preventDefault)e.preventDefault();return false;}break;case 36:if(!isQ){me.doScroll("home");if(e&&e.preventDefault)e.preventDefault();return false;}break;default:if(m_imageEventControl.targetImage){var image=m_imageEventControl.targetImage;m_imageEventControl.shrink(image);m_imageEventControl.endKeyMetaMode();image.display();}break;}};};ImageSizeControl=function ImageSizeControl(){var me=this;var m_imageSizeComboBox=null;var m_sizeControl=null;var m_imagesize_all=null;var m_imagesize_small=null;var m_imagesize_medium=null;var m_imagesize_large=null;var m_imagesize_desktop=null;this.initialize=function initialize(parentElement){m_sizeControl=MMUtil.createElement("imagesize",parentElement,"div");m_imageSizeComboBox=new ComboBox(m_sizeControl);m_imageSizeComboBox.initialize();m_imagesize_all=m_imageSizeComboBox.createOption("all",L_allImageSizes_Text,true);m_imagesize_small=m_imageSizeComboBox.createOption("small",L_smallImages_Text,true);m_imagesize_medium=m_imageSizeComboBox.createOption("medium",L_mediumImages_Text,true);m_imagesize_large=m_imageSizeComboBox.createOption("large",L_largeImages_Text,true);if(MMUtil.isLiveMarket)m_imagesize_desktop=m_imageSizeComboBox.createOption("desktop",L_myDesktopSize_Text,true);if(MMUtil.getState()&&MMUtil.getState().imagesize)m_imageSizeComboBox.selectItemByName(MMUtil.getState().imagesize);else m_imageSizeComboBox.selectItemByName("all");};this.setDisplayText=function setDisplayText(){var option=MMUtil.query&&MMUtil.query.parameters.getParameter("imagesize")?MMUtil.query.parameters.getParameter("imagesize"):"all";m_imageSizeComboBox.setText(option);};this.setHrefs=function setHrefs(){if(MMUtil.query){var qs=MMUtil.query.parameters.getParameter("queryString");m_imagesize_all.setHref(MMUtil.getHTMLUrl(qs,"all","SZ"));m_imagesize_small.setHref(MMUtil.getHTMLUrl(qs,"small","SZ"));m_imagesize_medium.setHref(MMUtil.getHTMLUrl(qs,"medium","SZ"));m_imagesize_large.setHref(MMUtil.getHTMLUrl(qs,"large","SZ"));if(m_imagesize_desktop)m_imagesize_desktop.setHref(MMUtil.getHTMLUrl(qs,"desktop","SZ"));}};this.dispose=function dispose(){if(m_imageSizeComboBox)m_imageSizeComboBox.dispose();me=m_sizeControl=null;};};ImageEventControl=function(scrollPanel,resultsPanel){var me=this;this.targetImage=null;this.keyMetaMode=false;this.imageClickCallback=null;this.initialize=function initialize(imageClickCallback){this.imageClickCallback=imageClickCallback;};this.dispose=function dispose(){for(prop in me){delete me[prop];}scrollPanel=resultsPanel=null;me=null;};this.getImageFromEvent=function getImageFromEvent(e){if(!e)e=window.event;var srcElement=MMUtil.getSrcElement(e);return this.getImageFromElement(srcElement);};this.getImageFromElement=function getImageFromElement(el){while(el&&el.md5==null){el=el.parentNode;}if(el==null)return null;return MMUtil.query.getImageFromHash(el.md5);};this.imageClick=function imageClick(e){var image=me.getImageFromEvent(e);if(image.getState()=="bulged"&&MMUtil.getState()._page!="view"&&me.keyMetaMode==true){var srcElement=MMUtil.getSrcElement(e);if(!me.instantGrow(image,srcElement,null)){me.shrink(image);image.display();me.imageClickCallback(image);}}else{if(MMUtil.scratchpad&&MMUtil.scratchpad.isDragging)return false;me.shrink(image);image.display();me.imageClickCallback(image);}if(e.preventDefault)e.preventDefault();return false;};this.cancelMeta=function cancelMeta(){if(this.targetImage)this.shrink(this.targetImage);this.targetImage=null;};this.startKeyMetaMode=function startKeyMetaMode(){me.keyMetaMode=true;me.mouseX=null;me.mouseY=null;MMUtil.addListener(document,"mousemove",me.endKeyMetaMode);};this.endKeyMetaMode=function endKeyMetaMode(e){if(!e)e=window.event;if(me.mouseY==null||me.mouseX==null){me.mouseX=e.clientX;me.mouseY=e.clientY;}if(Math.abs(me.mouseX-e.clientX)<5&&Math.abs(me.mouseY-e.clientY)<5)return;me.cancelMeta();me.keyMetaMode=false;MMUtil.removeListener(document,"mousemove",me.endKeyMetaMode);};this.instantGrow=function instantGrow(image,control,nav){if(!image||image.hidden)return;this.startKeyMetaMode();if(this.targetImage)this.shrink(this.targetImage);me.targetImage=image;if(MMUtil.getState()._page!="results")return;image.initializeGrow(100);if(!image.renderMeta(scrollPanel.getPanelWidth(),scrollPanel.getPanelOffset(),scrollPanel.getPanelOffset()+scrollPanel.panelHeight))return false;if(nav&&image.getTopDelta()){resultsPanel.jumpToOffset(scrollPanel.getPanelOffset()+image.getTopDelta());image.adjustGrowBounds(scrollPanel.getPanelWidth(),scrollPanel.getPanelOffset(),scrollPanel.getPanelOffset()+scrollPanel.panelHeight);}image.setGrowFinal();var params={"murl":image.properties.mediaurl,"control":control};MMUtil.record("MediaItem","instant grow",params);return true;};this.imageFocus=function imageFocus(e){if(me.keyMetaMode)return;var mediaItem=me.getImageFromEvent(e);if(!mediaItem)return;MMUtil.log("grow","Got imageFocus from "+MMUtil.getSrcElement(e).className+" for "+mediaItem.properties.toString());mediaItem.setCursor("pointer");if(me.targetImage&&me.targetImage!=mediaItem)me.shrink(me.targetImage);me.targetImage=mediaItem;if(mediaItem.shrinkDelayTimer){clearTimeout(mediaItem.shrinkDelayTimer);mediaItem.shrinkDelayTimer=null;}if(mediaItem.getState()=="grown"||mediaItem.getState()=="growing")return;if(mediaItem.getState()!="bulged")mediaItem.bulge();if(MMUtil.getState()._page=="view")return;MMUtil.stealFocus();mediaItem.growDelayTimer=setTimeout(function(){me.grow(mediaItem);},200);};this.imageOut=function imageOut(e){var mediaItem=me.getImageFromEvent(e);MMUtil.log("grow","Got imageOut from "+MMUtil.getSrcElement(e).className+" for "+mediaItem.properties.toString());if(mediaItem.getState()!="grown")me.imageBlur(mediaItem);};this.metaOut=function metaOut(e){var mediaItem=me.getImageFromEvent(e);MMUtil.log("grow","Got metaOut from "+MMUtil.getSrcElement(e).className+" for "+mediaItem.properties.toString());me.imageBlur(mediaItem);};this.imageBlur=function imageBlur(mediaItem){if(me.keyMetaMode)return;if(!mediaItem)return;mediaItem.setCursor("default");me.targetImage=mediaItem;if(mediaItem.growDelayTimer){clearTimeout(mediaItem.growDelayTimer);mediaItem.growDelayTimer=null;}if(mediaItem.shrinkDelayTimer){clearTimeout(mediaItem.shrinkDelayTimer);mediaItem.shrinkDelayTimer=null;}mediaItem.shrinkDelayTimer=setTimeout(function(){me.shrink(mediaItem);},100);};this.grow=function grow(image){image.initializeGrow(100);if(!image.renderMeta(scrollPanel.getPanelWidth(),scrollPanel.getPanelOffset(),scrollPanel.getPanelOffset()+scrollPanel.panelHeight))return;image.growBegin(me.completeGrow);};this.shrink=function shrink(image){image.shrink();me.targetImage=null;};this.completeGrow=function completeGrow(image,control){if(!image)return;me.targetImage=image;var params={"murl":image.properties.mediaurl,"control":control};MMUtil.record("MediaItem","hover",params);};};FullImageDisplay=function(outer){var panel;var me=this;this.panel=panel;this.imageDisplay=null;this.closeButtonAnchor=null;this.closeButton=null;this.loading=null;this.failureDiv=null;this.emailLink=null;this.openImageLink=null;this.naturalHeight=200;this.naturalWidth=200;this.request=null;this.info=null;FullImageDisplay.prototype.initialize=function(){this.imageDisplay=new ImageMetaDisplay("fi");this.imageDisplay.initialize();this.imageDisplay.container.className="md full_image";this.closeButtonAnchor=document.createElement("a");this.imageDisplay.container.appendChild(this.closeButtonAnchor);this.closeButtonAnchor.className="fi_close_a";this.closeButtonAnchor.href="#";this.closeButton=document.createElement("img");this.closeButton.src="img/kill.gif";this.closeButton.className="fi_close";MMUtil.setAlt(this.closeButton,L_closeFullImage_Text);this.closeButtonAnchor.appendChild(this.closeButton);this.loading=document.createElement("img");this.loading.src="img/loading.gif";this.loading.style.position="relative";this.imageDisplay.title.style.width="80%";this.imageDisplay.spacer.style.left="5px";this.failureDiv=document.createElement("div");this.failureDiv.style.textAlign="center";this.failureDiv.style.position="relative";this.failureDiv.style.color="black";MMUtil.setText(this.failureDiv,L_imageUnavailable_Message);this.emailLink=document.createElement("a");this.emailLink.className="meta_display_action_link";this.emailLink.id="email_link";MMUtil.setText(this.emailLink,L_emailResult_Text);this.emailLink.title=L_emailResult_Text;MMUtil.addListener(me.emailLink,"click",me.emailLinkAction);this.openImageLink=document.createElement("a");this.openImageLink.className="meta_display_action_link";this.openImageLink.id="open_image_link";MMUtil.setText(this.openImageLink,L_openImage_Text);this.openImageLink.title=L_openImage_Text;this.openImageLink.target="_blank";MMUtil.addListener(me.openImageLink,"click",me.openImageLinkAction);if(MMUtil.lang.match(/en-/))this.imageDisplay.actionsDiv.appendChild(this.emailLink);this.imageDisplay.actionsDiv.appendChild(this.openImageLink);MMUtil.addListener(me.imageDisplay.spacer,"contextmenu",me.imageContext);};FullImageDisplay.prototype.dispose=function dispose(){MMUtil.removeListener(me.emailLink,"click",me.emailLinkAction);MMUtil.removeListener(me.openImageLink,"click",me.openImageLinkAction);MMUtil.removeListener(me.imageDisplay.spacer,"contextmenu",me.imageContext);this.imageDisplay.dispose();if(this.request)this.request.dispose();for(prop in me){delete me[prop];}outer=null;me=null;};FullImageDisplay.prototype.openImageLinkAction=function openImageLinkAction(e){MMUtil.record("FullImageDisplay","email link",{"murl":me.info?me.info.mediaurl:null});};FullImageDisplay.prototype.emailLinkAction=function emalLinkAction(e){MMUtil.record("FullImageDisplay","email link",{"murl":me.info?me.info.mediaurl:null});};FullImageDisplay.prototype.imageContext=function imageContext(e){if(!e)e=window.event;e.cancelBubble=true;if(e.preventDefault)e.preventDefault();return false;};FullImageDisplay.prototype.receiveImage=function receiveImage(r,success){if(r!=me.request)return;if(me.imageDisplay.spacer.firstChild)me.imageDisplay.spacer.removeChild(me.imageDisplay.spacer.firstChild);if(success){r.image.style.position="relative";me.imageDisplay.spacer.appendChild(r.image);me.naturalHeight=r.image.height;me.naturalWidth=r.image.width;}else{if(r.fullRetry)me.info.imageUnavailable=true;else{me.request.fullRetry=true;me.request.fetch();}}me.onReceive();};FullImageDisplay.prototype.clear=function clear(){if(this.request)this.request.dispose();this.request=null;};FullImageDisplay.prototype.setImage=function setImage(info,setInner){this.clear();this.info=info;this.onReceive=setInner;me.imageDisplay.setMedia(info);if(me.imageDisplay.spacer.firstChild)me.imageDisplay.spacer.removeChild(me.imageDisplay.spacer.firstChild);var mediaUrl=me.info.mediaurl;var pageUrl=me.info.displayurl;var emailSubject;if(MMUtil.getState().q)emailSubject=L_emailSubject_Text.replace(/%query%/,escape("\""+MMUtil.getState().q+"\""));else emailSubject=L_emailSubject_Text.replace(/%query%/,escape("\""+MMUtil.getState().q+"\""));var emailLinkResult=L_emailLinkResult_Text.replace(/%link%/,"")+escape(window.location.href.replace(/&FORM=[^&#]*/,"")+"&FORM=IMGEML");var emailLinkImage=L_emailLinkImage_Text.replace(/%link%/,"")+escape(mediaUrl);var emailLinkSource=L_emailSourcePage_Text.replace(/%link%/,"")+escape(pageUrl);this.emailLink.href="mailto:?subject="+emailSubject+"&"+"body="+emailLinkResult+escape("\n")+emailLinkImage+escape("\n")+emailLinkSource;this.openImageLink.href=mediaUrl;this.imageDisplay.spacer.appendChild(this.loading);this.naturalHeight=this.info.height;this.naturalWidth=this.info.width;};FullImageDisplay.prototype.fetchImage=function fetchImage(){if(this.request)return;this.request=this.info.clone();this.request.setFullImage();MMUtil.setAlt(this.request.image,this.info.getTitle());this.request.setCallback(this.receiveImage);this.request.fetch();};FullImageDisplay.prototype.position=function position(){this.width=this.naturalWidth;this.height=this.naturalHeight;var padding=40;var minSize=160;var minWidth=Math.min(minSize,this.naturalWidth);var minHeight=Math.min(minSize,this.naturalHeight);var horizontalSpace=56;var verticalSpace=180;if(outer.offsetWidth-this.width-horizontalSpace-padding<=0)this.width=Math.max(outer.offsetWidth-padding-horizontalSpace,minWidth);if(outer.offsetHeight-this.height-verticalSpace-padding<=0)this.height=Math.max(outer.offsetHeight-padding-verticalSpace,minHeight);if(this.width/this.naturalWidth<this.height/this.naturalHeight)this.height=this.width*this.naturalHeight/this.naturalWidth;else this.width=this.height*this.naturalWidth/this.naturalHeight;this.left=20+Math.max(0,Math.floor((outer.offsetWidth-Math.max(minSize,this.width)-padding-horizontalSpace)/2));this.top=20+Math.max(0,Math.floor((outer.offsetHeight-Math.max(minSize,this.height)-padding-verticalSpace)/4));var scratchpadLink=MMUtil.getState()._page=="view"?true:false;if(this.request&&this.request.loaded){this.request.image.style.visibility="";this.request.image.style.height=this.height+"px";this.request.image.style.width=this.width+"px";this.request.image.style.top=5+Math.max(0,(minSize-this.height)/2)+"px";this.request.image.style.left=10+Math.max(0,(minSize-this.width)/2)+"px";this.imageDisplay.render(this.info,Math.max(minSize,this.width),Math.max(minSize,this.height),scratchpadLink);}else{this.loading.style.left=Math.max(0,(300-this.width)/2)+this.width/2+"px";this.loading.style.top=Math.max(this.height/3,100)+"px";this.imageDisplay.render(null,Math.max(minSize,this.width),Math.max(minSize,this.height),scratchpadLink);}this.imageDisplay.setPosition(this.left,this.top,Math.max(minSize,this.width)+padding);this.imageDisplay.show();};};ResultViewPanel=function(m_el){var me=this;this.resultViewOuterContainer=m_el;this.properties=null;this.barDiv=null;this.pageInfo=null;this.closeButton=null;this.closeButtonAnchor=null;this.content=null;this.loading=null;this.buttonsDiv=null;this.backToResultsDiv=null;this.frameMessageElement=null;this.pageUnavailableElement=null;this.mediaUnavailableElement=null;this.fullImage=null;this.frameMessage=null;this.frameExpr=/(parent.location.replace)|(parent.location(.href)?\s*=)|(top.location.replace)|(top.location(.href)?\s*=)|(wikibits.js)|(e107.js)/;this.statusExpr=/[45]\d\d/;ResultViewPanel.prototype.c_mediaUrl=L_imageUrl_Text;ResultViewPanel.prototype.c_frameMessageText=L_frameImageA_Message+" "+L_frameB_Message;ResultViewPanel.prototype.c_pageUnavailableText=L_pageUnavailableA_Message+" "+L_pageUnavailableB_Message;ResultViewPanel.prototype.c_mediaUnavailableText=L_mediaUnavailableImageA_Message+" "+L_mediaUnavailableB_Message;ResultViewPanel.prototype.initialize=function initialize(onClose){this.frame=null;this.loaded=false;this.barDiv=MMUtil.createElement("view_bar_div",this.resultViewOuterContainer);this.closeButtonAnchor=MMUtil.createElement("close_button_anchor",this.barDiv,"a");this.closeButtonAnchor.href="#";this.closeButtonAnchor.className="results_panel_close_button_anchor";this.closeButton=MMUtil.createElement("close_button",this.closeButtonAnchor,"img");this.closeButton.src="img/kill.gif";this.closeButton.className="results_panel_close_button";MMUtil.setAlt(this.closeButton,L_closeResultView_Text);this.pageInfo=MMUtil.createElement("page_info",this.resultViewOuterContainer);this.mediaUrlDiv=MMUtil.createElement("media_url_div",this.pageInfo);this.pageUrlDiv=MMUtil.createElement("page_url_div",this.pageInfo);this.content=document.createElement("div");this.content.id="view_frame_content_div";this.content.style.position="relative";this.resultViewOuterContainer.appendChild(this.content);this.frameCover=document.createElement("div");this.frameCover.className="view_frame_cover";MMUtil.setOpacity(this.frameCover,0);this.content.appendChild(this.frameCover);this.loading=document.createElement("img");this.loading.src="img/loading.gif";this.loading.style.position="absolute";this.loading.style.visibility="hidden";this.resultViewOuterContainer.appendChild(this.loading);this.frameMessageElement=document.createElement("div");this.frameMessage=new WarningMessage(this.frameMessageElement,this.c_frameMessageText,[L_openNewWindow_Text,L_openHere_Text]);this.resultViewOuterContainer.appendChild(this.frameMessageElement);this.pageUnavailableElement=document.createElement("div");this.pageUnavailable=new WarningMessage(this.pageUnavailableElement,this.c_pageUnavailableText,[L_retryNewWindow_Text]);this.resultViewOuterContainer.appendChild(this.pageUnavailableElement);this.mediaUnavailableElement=document.createElement("div");this.mediaUnavailable=new WarningMessage(this.mediaUnavailableElement,this.c_mediaUnavailableText,[L_retryNewWindow_Text]);var noImageClose=document.createElement("img");noImageClose.src="img/kill.gif";var noImageCloseAnchor=document.createElement("a");noImageCloseAnchor.href="#";noImageCloseAnchor.appendChild(noImageClose);noImageCloseAnchor.className="warning_div_close_button_anchor";this.mediaUnavailableElement.insertBefore(noImageCloseAnchor,this.mediaUnavailableElement.firstChild);this.resultViewOuterContainer.appendChild(this.mediaUnavailableElement);MMUtil.addListener(this.closeButtonAnchor,"click",function(e){onClose("closebutton");if(e.preventDefault)e.preventDefault();return false;});MMUtil.addListener(noImageCloseAnchor,"click",function(e){me.closeFullImage("closebutton");if(e.preventDefault)e.preventDefault();return false;});this.setHrefs();};ResultViewPanel.prototype.dispose=function dispose(){this.clear();for(prop in me){delete me[prop];}me=m_el=null;};ResultViewPanel.prototype.clear=function clear(){if(this.pageReqest)pageRequest.abort();this.pageRequest=null;this.loaded=false;if(this.frame){this.frame.onreadystatechange=null;delete this.frame;}var i=0;while(this.content&&i<this.content.childNodes.length){if(this.content.childNodes[i].id=="viewFrame")this.content.removeChild(this.content.childNodes[i]);else i++;}};ResultViewPanel.prototype.createFrame=function createFrame(){this.frame=document.createElement("iframe");this.frame.id="viewFrame";this.frame.name="viewFrame";this.frame.vspace=0;this.frame.hspace=0;this.frame.frameBorder=0;if(MMUtil.getState().fi=="true")MMUtil.setOpacity(this.frame,40);this.content.insertBefore(this.frame,this.content.firstChild);this.position();};ResultViewPanel.prototype.openInNewPage=function openInNewPage(){window.open(me.properties.url);if(MMUtil.getState().fi=="true")me.hideInner();};ResultViewPanel.prototype.openInThisPage=function openInThisPage(){me.properties.framebreaker=0;me.showPage();};ResultViewPanel.prototype.openImage=function openImage(){window.open(me.properties.mediaurl);if(MMUtil.getState().fi=="true")me.hideInner();};ResultViewPanel.prototype.showInner=function showInner(){me.hideInner();if(me.properties.framebreaker==1){me.frameMessage.links[0].onclick=openInNewPage;me.frameMessage.links[1].onclick=openInThisPage;me.currentMessageElement=me.frameMessageElement;}else{if(me.properties.pageUnavailable){me.pageUnavailable.links[0].onclick=openInNewPage;me.currentMessageElement=me.pageUnavailableElement;}else{if(!me.loaded)me.currentMessageElement=me.loading;else return;}}me.positionInner();me.currentMessageElement.style.visibility="visible";};ResultViewPanel.prototype.hideInner=function hideInner(){if(this.currentMessageElement){if(this.currentMessageElement==me.fullImage.imageDisplay.container)me.fullImage.imageDisplay.hide();else this.currentMessageElement.style.visibility="hidden";}this.currentMessageElement=null;};ResultViewPanel.prototype.positionInner=function positionInner(){if(!this.currentMessageElement)return;var height=this.resultViewOuterContainer.clientHeight-this.content.offsetTop;var top=Math.max(40,(height-this.currentMessageElement.offsetHeight)/4);this.currentMessageElement.style.top=top+"px";var width=this.resultViewOuterContainer.clientWidth;var left=Math.max(40,(width-this.currentMessageElement.offsetWidth)/2);this.currentMessageElement.style.left=left+"px";};ResultViewPanel.prototype.showPage=function showPage(){if(MMUtil.isIE()){me.showInner();me.frame.onreadystatechange=function(){if(!me)return;me.loaded=true;me.showInner();};}else{me.loaded=true;me.showInner();}me.frame.src=me.properties.url;};ResultViewPanel.prototype.setImage=function setImage(mediaInfo){this.properties=mediaInfo;var pageUrl_Text=L_pageUrl_Text.replace(/%url%/,"");var mediaUrl_Text=this.c_mediaUrl.replace(/%url%/,"");MMUtil.setText(this.pageUrlDiv,pageUrl_Text);var purlAnchor=document.getElementById("result_view_panel_purl_anchor");if(!purlAnchor){purlAnchor=document.createElement("a");purlAnchor.id="result_view_panel_purl_anchor";this.pageUrlDiv.appendChild(purlAnchor);}purlAnchor.href=mediaInfo.url;purlAnchor.title=mediaInfo.displayurl;purlAnchor.target="_blank";MMUtil.setText(purlAnchor,mediaInfo.displayurl);MMUtil.setText(this.mediaUrlDiv,mediaUrl_Text);var murlAnchor=document.getElementById("result_view_panel_murl_anchor");if(!murlAnchor){murlAnchor=document.createElement("a");murlAnchor.id="result_view_panel_murl_anchor";this.mediaUrlDiv.appendChild(murlAnchor);}murlAnchor.href=mediaInfo.mediaurl;murlAnchor.title=mediaInfo.mediaurl;murlAnchor.target="_blank";MMUtil.setText(murlAnchor,mediaInfo.mediaurl);if(!this.frame||this.frame.src!=mediaInfo.url){this.clear();if(mediaInfo.framebreaker==1)this.showInner();else{this.createFrame();this.showPage();}}};ResultViewPanel.prototype.position=function position(){var newHeight=this.resultViewOuterContainer.clientHeight-this.content.offsetTop;if(this.frame&&newHeight>0)this.frame.style.height=newHeight+"px";if(this.frameCover&&newHeight>0)this.frameCover.style.height=newHeight+"px";this.positionInner();};ResultViewPanel.prototype.cover=function cover(){this.frameCover.style.display="block";};ResultViewPanel.prototype.uncover=function uncover(){this.frameCover.style.display="none";};this.setHrefs=function setHrefs(){this.closeButtonAnchor.href=location.href.replace(/#.*/,"");};};ImageResultViewPanel=function(m_el){ImageResultViewPanel.baseConstructor.call(this,m_el);var me=this;this.fullImageDiv=null;ImageResultViewPanel.prototype.c_mediaUrl=L_imageUrl_Text;ImageResultViewPanel.prototype.c_frameMessageText=L_frameImageA_Message+" "+L_frameB_Message;ImageResultViewPanel.prototype.c_pageUnavailableText=L_pageUnavailableA_Message+" "+L_pageUnavailableB_Message;ImageResultViewPanel.prototype.c_mediaUnavailableText=L_mediaUnavailableImageA_Message+" "+L_mediaUnavailableB_Message;this.initialize=function initialize(onClose){ImageResultViewPanel.parentClass.initialize.call(this,onClose);this.fullImageDiv=document.createElement("a");this.fullImageDiv.href="#";this.fullImageDiv.className="button_div";if(MMUtil.getState().fi=="true"){this.setHref(false);this.hideFullImageMessage();}else{this.setHref(true);this.showFullImageMessage();}this.barDiv.insertBefore(this.fullImageDiv,this.barDiv.firstChild);this.fullImage=new FullImageDisplay(this.content);this.fullImage.initialize();this.content.appendChild(this.fullImage.imageDisplay.containerCover);this.content.appendChild(this.fullImage.imageDisplay.container);this.currentMessageElement=this.fullImage.imageDisplay.container;MMUtil.addListener(this.fullImageDiv,"click",this.clickFullImage);MMUtil.addListener(this.fullImage.closeButtonAnchor,"click",function(e){me.closeFullImage("closebutton");if(e.preventDefault)e.preventDefault();return false;});};this.dispose=function dispose(){this.fullImage.dispose();ImageResultViewPanel.parentClass.dispose.call(this);for(prop in me){delete me[prop];}me=m_el=null;};this.positionInner=function positionInner(){if(!this.currentMessageElement)return;if(this.currentMessageElement==this.fullImage.imageDisplay.container){this.fullImage.position();return;}ImageResultViewPanel.parentClass.positionInner.call(this);};this.showInner=function showInner(){if(MMUtil.getState().fi=="true"){me.hideInner();if(me.fullImage.info.imageUnavailable){me.mediaUnavailable.links[0].onclick=me.openImage;me.currentMessageElement=me.mediaUnavailableElement;}else{me.currentMessageElement=me.fullImage.imageDisplay.container;me.fullImage.imageDisplay.containerCover.visibility="visible";}me.positionInner();me.currentMessageElement.style.visibility="visible";}else ImageResultViewPanel.parentClass.showInner.call(me);};this.showFullImageMessage=function showFullImageMessage(){this.fullImageDiv.title=L_showImage_Text;this.fullImageDiv.innerHTML="<span class='button_span'><img src='img/show_full.gif' id='full_image_button'/><span class='button_text'>"+L_showImage_Text+"</span></span>";};this.hideFullImageMessage=function hideFullImageMessage(){this.fullImageDiv.title=L_hideImage_Text;this.fullImageDiv.innerHTML="<span class='button_span'><img src='img/show_full.gif' id='full_image_button'/><span class='button_text'>"+L_hideImage_Text+"</span></span>";};this.showFullImage=function showFullImage(control){MMUtil.commitState();MMUtil.getState().fi="true";var newloc=location.href.replace(/#fi=[^&#]*&?/,"#");newloc=newloc.replace(/&fi=[^&#]*/,"");if(newloc.match(/#/))newloc=newloc+"&fi=true";else newloc=newloc+"#fi=true";location.href=newloc;MMUtil.storeState();if(me.frame)MMUtil.setOpacity(me.frame,40);me.fullImage.fetchImage();me.setHref(false);me.hideFullImageMessage();me.showInner();var params={"murl":me.properties.mediaurl,"control":control};MMUtil.record("ResultView","show full image",params);};this.closeFullImage=function closeFullImage(control){MMUtil.commitState();MMUtil.getState().fi="";var newloc=location.href.replace(/#fi=[^&#]*&?/,"#");location.href=newloc.replace(/&fi=[^&#]*/,"");MMUtil.storeState();if(me.frame)MMUtil.setOpacity(me.frame,100);me.setHref(true);me.showFullImageMessage();me.showInner();var params={"murl":me.properties.mediaurl,"control":control};MMUtil.record("ResultView","close full image",params);};this.clickFullImage=function clickFullImage(e){if(MMUtil.getState().fi=="true")me.closeFullImage("fullImageButton");else me.showFullImage("fullImageButton");if(e.preventDefault)e.preventDefault();return false;};this.setImage=function setImage(mediaInfo){me.properties=mediaInfo;me.fullImage.setImage(mediaInfo,me.showInner);if(MMUtil.getState().fi=="true"){me.hideFullImageMessage();me.fullImage.fetchImage();}else me.showFullImageMessage();me.showInner();me.setHref(MMUtil.getState().fi!="true");ImageResultViewPanel.parentClass.setImage.call(me,mediaInfo);};this.setHref=function setHref(fi){var url=location.href;url=url.replace(/[#&]fi=[^&#]*/,"")+(fi?"&fi=true":"");this.fullImageDiv.href=url;};};LiveMM.extend(ImageResultViewPanel,ResultViewPanel);ScrollPanel=function(element){var me=this;this.element=element;var m_panelOffset=0;this.panelHeight=0;var m_panelWidth=0;this.containerHeight=0;this.containerWidth=0;var m_containerOffsetHeight=0;var m_containerOffsetWidth=0;var m_verticalSpacing=0;var m_horizontalSpacing=0;this.numberOfColumnsToDisplay=0;this.numberOfRowsToDisplay=0;this.minPreviewPaneWidth=900;var m_sizes=[100,120,140,160,180,200];this.levelOfDetail=null;this.initialize=function initialize(){this.offset=0;this.setLevelOfDetail(MMUtil.getPreference("lod"));};this.dispose=function dispose(){for(prop in me){delete me[prop];}me=element=null;};this.createResultItem=function createResultItem(mediaProperties){var resultItem=new ResultImage();MMUtil.resultItems[mediaProperties.imageIndex]=resultItem;var pos=mediaProperties.rank;resultItem.initialize(element,mediaProperties,me.containerWidth,this.getResultXPos(pos),this.getResultYPos(pos));return resultItem;};this.onScroll=function onScroll(scrollTop){m_panelOffset=scrollTop;};this.getFirstDisplayedRank=function getFirstDisplayedRank(){if(!MMUtil.query)return null;var row=Math.floor(m_panelOffset/m_containerOffsetHeight);var first=row*this.numberOfColumnsToDisplay;return first;};this.getLastDisplayedRank=function getLastDisplayedRank(){if(!MMUtil.query)return null;var row=Math.ceil((m_panelOffset+this.panelHeight)/m_containerOffsetHeight);var last=row*this.numberOfColumnsToDisplay;return last;};this.pruneResults=function pruneResults(){if(!MMUtil.query)return;var resultsPerPage=this.getLastDisplayedRank()-this.getFirstDisplayedRank();var first=this.getFirstDisplayedRank()-2*resultsPerPage;var second=this.getFirstDisplayedRank()+3*resultsPerPage;for(var rank=0;rank<=MMUtil.query.maxAssignedRank;rank++){var resultItem=MMUtil.query.getImage(rank);var prune=false;if(rank<first){if(Math.random()<Math.min(0.8,(first-rank)/(resultsPerPage*4)))prune=true;}else{if(rank>=second){if(Math.random()<Math.min(0.8,(rank-second)/(resultsPerPage*4)))prune=true;}}if(prune&&resultItem.properties.loaded){resultItem.hide();MMUtil.query.unloadImage(resultItem.properties);}}};this.setLevelOfDetail=function setLevelOfDetail(value){this.levelofdetail=value;this.containerWidth=m_sizes[value];this.containerHeight=m_sizes[value];m_containerOffsetHeight=this.containerHeight+m_verticalSpacing;m_containerOffsetWidth=this.containerWidth+m_horizontalSpacing;};this.calculateLayoutValues=function calculateLayoutValues(){var page=MMUtil.getState()._page;if(page=="view"||page=="viewloading")this.numberOfColumnsToDisplay=MMFEXParams.multicolumnresults?Math.max(1,Math.floor((MMUtil.appWidth-this.minPreviewPaneWidth)/this.containerWidth)):1;else this.numberOfColumnsToDisplay=Math.max(1,Math.floor(m_panelWidth/this.containerWidth));if(this.numberOfColumnsToDisplay>1){m_horizontalSpacing=(m_panelWidth-this.containerWidth*this.numberOfColumnsToDisplay)/(this.numberOfColumnsToDisplay-1);m_containerOffsetWidth=this.containerWidth+m_horizontalSpacing;}};this.getNumberOfImagesToDisplay=function getNumberOfImagesToDisplay(){return Math.ceil(this.panelHeight/m_containerOffsetHeight)*this.numberOfColumnsToDisplay;};this.getResultYPos=function getResultYPos(rank){var yPos=Math.floor(rank/this.numberOfColumnsToDisplay);return Math.floor(yPos*m_containerOffsetHeight);};this.getResultXPos=function getResultXPos(rank){var xPos=rank%this.numberOfColumnsToDisplay;return xPos*m_containerOffsetWidth;};this.setResultItemPosition=function setResultItemPosition(resultItem){if(!resultItem)return;var rank=resultItem.getRank();resultItem.setPosition(this.getResultXPos(rank),this.getResultYPos(rank));};this.position=function position(frugal){if(!MMUtil.query||MMUtil.query.maxAssignedRank==null)return;var firstDisplayedRank=this.getFirstDisplayedRank();var lastDisplayedRank=this.getLastDisplayedRank();var minOffset=m_panelOffset-160;var maxOffset=m_panelOffset+this.panelHeight;for(var rank=0;rank<=lastDisplayedRank&&rank<=MMUtil.query.maxAssignedRank;rank++){var resultItem=MMUtil.query.getImage(rank);this.setResultItemPosition(resultItem);resultItem.setContainerSize(this.containerWidth);resultItem.display();}for(var rank=0;rank<=MMUtil.query.maxAssignedRank;rank++){var resultItem=MMUtil.query.getImage(rank);var resultItemTop=resultItem.m_containerTop;if(!frugal||resultItemTop>=minOffset&&resultItemTop<maxOffset){this.setResultItemPosition(resultItem);resultItem.setContainerSize(this.containerWidth);resultItem.display();}}};this.setPanelWidth=function setPanelWidth(width){element.style.width=width+"px";m_panelWidth=element.clientWidth-10;};this.getPanelWidth=function getPanelWidth(){return m_panelWidth;};this.getPanelOffset=function getPanelOffset(){return m_panelOffset;};this.getContainerOffsetHeight=function getContainerOffsetHeight(){return m_containerOffsetHeight;};};function SizerScroller(m_container){var me=this;var m_callback=null;var m_name=null;var m_min=0;var m_max=5;var m_rail=null;var m_incrementButtonA=null;var m_incrementButtonImg=null;var m_decrementButtonA=null;var m_decrementButtonImg=null;var m_handleA=null;var m_handleImg=null;var m_value=3;var m_dragging=false;var m_startDragPos=0;var m_handleWidth=10;var m_railLength=76;var c_handleImgPath="img/slider_button";var c_decrementImgPath="s/live/lod_first";var c_incrementImgPath="s/live/lod_second";var c_restSuffix="_rest.gif";var c_hoverSuffix="_hover.gif";var c_pressedSuffix="_pressed.gif";var c_restSuffixA=".gif";var c_hoverSuffixA=".gif";var c_pressedSuffixA=".gif";SizerScroller.prototype.initialize=function initialize(name,callback){m_name=name;m_callback=callback;m_rail=MMUtil.createElement(name+"_rail",m_container,"div");m_decrementButtonA=MMUtil.createElement(name+"_first_button",m_container,"a");m_decrementButtonA.href="#";MMUtil.setAlt(m_decrementButtonA,L_decreaseLOD_Text);m_decrementButtonImg=MMUtil.createElement(name+"_first_button_img",m_decrementButtonA,"img");m_decrementButtonImg.src=c_decrementImgPath+c_restSuffixA;m_handleA=MMUtil.createElement(name+"_handle_div",m_rail,"a");MMUtil.setAlt(m_handleA,L_changeLOD_Text);m_handleImg=MMUtil.createElement(name+"_handle_img",m_handleA,"img");m_handleImg.src=c_handleImgPath+c_restSuffix;m_incrementButtonA=MMUtil.createElement(name+"_second_button",m_container,"a");m_incrementButtonA.href="#";MMUtil.setAlt(m_incrementButtonA,L_increaseLOD_Text);m_incrementButtonImg=MMUtil.createElement(name+"_second_button_img",m_incrementButtonA,"img");m_incrementButtonImg.src=c_incrementImgPath+c_restSuffixA;MMUtil.addListener(m_decrementButtonA,"mouseover",this.hover);MMUtil.addListener(m_decrementButtonA,"focus",this.hover);MMUtil.addListener(m_decrementButtonA,"mouseout",this.unhover);MMUtil.addListener(m_decrementButtonA,"blur",this.unhover);MMUtil.addListener(m_decrementButtonA,"click",decrementButtonClick);MMUtil.addListener(m_handleA,"mouseover",this.hover);MMUtil.addListener(m_handleA,"focus",this.hover);MMUtil.addListener(m_handleA,"mousedown",this.handleDown);MMUtil.addListener(m_handleA,"mousemove",this.handleMove);MMUtil.addListener(m_handleA,"mouseup",this.handleUp);MMUtil.addListener(m_handleA,"mouseout",this.unhover);MMUtil.addListener(m_handleA,"blur",this.unhover);MMUtil.addListener(m_incrementButtonA,"mouseover",this.hover);MMUtil.addListener(m_incrementButtonA,"focus",this.hover);MMUtil.addListener(m_incrementButtonA,"mouseout",this.unhover);MMUtil.addListener(m_incrementButtonA,"blur",this.unhover);MMUtil.addListener(m_incrementButtonA,"click",incrementButtonClick);MMUtil.addListener(m_rail,"click",this.railClick);};SizerScroller.prototype.dispose=function dispose(){MMUtil.removeListener(m_decrementButtonA,"mouseover",this.hover);MMUtil.removeListener(m_decrementButtonA,"focus",this.hover);MMUtil.removeListener(m_decrementButtonA,"mouseout",this.unhover);MMUtil.removeListener(m_decrementButtonA,"blur",this.unhover);MMUtil.removeListener(m_decrementButtonA,"click",decrementButtonClick);MMUtil.removeListener(m_handleA,"mouseover",this.hover);MMUtil.removeListener(m_handleA,"focus",this.hover);MMUtil.removeListener(m_handleA,"mousedown",this.handleDown);MMUtil.removeListener(m_handleA,"mousemove",this.handleMove);MMUtil.removeListener(m_handleA,"mouseup",this.handleUp);MMUtil.removeListener(m_handleA,"mouseout",this.unhover);MMUtil.removeListener(m_handleA,"blur",this.unhover);MMUtil.removeListener(m_incrementButtonA,"mouseover",this.hover);MMUtil.removeListener(m_incrementButtonA,"focus",this.hover);MMUtil.removeListener(m_incrementButtonA,"mouseout",this.unhover);MMUtil.removeListener(m_incrementButtonA,"blur",this.unhover);MMUtil.removeListener(m_incrementButtonA,"click",incrementButtonClick);me=m_container=m_rail=m_incrementButtonA=m_incrementButtonImg=m_decrementButtonA=null;m_decrementButtonImg=m_handleA=m_handleImg=null;};SizerScroller.prototype.hover=function hover(e){if(m_dragging)return;src=MMUtil.getSrcElement(e);if(src.tagName.toLowerCase()=="img")src=src.parentNode;if(src.id.match(/first_button/))m_decrementButtonImg.src=c_decrementImgPath+c_hoverSuffixA;else{if(src.id.match(/second_button/))m_incrementButtonImg.src=c_incrementImgPath+c_hoverSuffixA;else{if(src.id.match(/handle/)||src.id.match(/rail/))m_handleImg.src=c_handleImgPath+c_hoverSuffix;}}};SizerScroller.prototype.unhover=function unhover(e){if(m_dragging)return;src=MMUtil.getSrcElement(e);if(src.tagName.toLowerCase()=="img")src=src.parentNode;if(src.id.match(/first_button/))m_decrementButtonImg.src=c_decrementImgPath+c_restSuffixA;else{if(src.id.match(/second_button/))m_incrementButtonImg.src=c_incrementImgPath+c_restSuffixA;else{if(src.id.match(/handle/)||src.id.match(/rail/))m_handleImg.src=c_handleImgPath+c_restSuffix;}}};function incrementButtonClick(e){if(e.preventDefault)e.preventDefault();me.increment();return false;}function decrementButtonClick(e){if(e.preventDefault)e.preventDefault();me.decrement();return false;}SizerScroller.prototype.increment=function increment(){if(m_value<m_max)me.setValue(m_value+1);};SizerScroller.prototype.decrement=function decrement(){if(m_value>m_min)me.setValue(m_value-1);};SizerScroller.prototype.handleDown=function handleDown(e){if(e.preventDefault)e.preventDefault();m_dragging=true;m_startDragPos=e.clientX;m_startDragHandleOffset=m_handleA.offsetLeft;if(m_handleA.setCapture)m_handleA.setCapture();else{MMUtil.addListener(document,"mousemove",me.handleMove);MMUtil.addListener(document,"mouseup",me.handleUp);}m_handleImg.src=c_handleImgPath+c_pressedSuffix;return false;};SizerScroller.prototype.handleUp=function handleUp(e){if(e.preventDefault)e.preventDefault();m_handleImg.src=c_handleImgPath+c_hoverSuffix;if(m_handleA.releaseCapture)m_handleA.releaseCapture();else{MMUtil.removeListener(document,"mousemove",me.handleMove);MMUtil.removeListener(document,"mouseup",me.handleUp);}m_dragging=false;m_callback(m_value,true);return false;};SizerScroller.prototype.handleMove=function handleMove(e){if(e.preventDefault)e.preventDefault();if(m_dragging){var delta=e.clientX-m_startDragPos;var newOffset=m_startDragHandleOffset+m_handleWidth/2+delta;newOffset=newOffset<m_min?m_min:newOffset;newOffset=newOffset>m_railLength?m_railLength:newOffset;me.setToOffset(newOffset);}return false;};SizerScroller.prototype.railClick=function railClick(e){if(MMUtil.getSrcElement(e)!=m_rail)return;me.setToOffset(e.offsetX);};SizerScroller.prototype.setToOffset=function setToOffset(offset){me.setValue(Math.round(offset/(m_railLength/(m_max-m_min))));};SizerScroller.prototype.setValue=function setValue(value,force){iValue=parseInt(value,10);if(force||m_value!=iValue&&iValue>=m_min&&iValue<=m_max){m_value=iValue;m_handleA.style.left=Math.floor(m_value*m_railLength/(m_max-m_min)-m_handleWidth/2)+"px";m_callback(m_value,!m_dragging);MMUtil.setAlt(m_handleA,L_currLOD_Text.replace(/%level%/,m_value));}};}MediaProperties=function(){var me=null;this._callback=null;this._initialized=false;this.rank=null;this.fetching=false;this.loaded=false;this.cached=false;this.qa=[];this.image=null;this.imageIndex=null;this.fetchurl="";this.mediahash=null;this.thumbnailurl=null;this.thumbnailwidth=160;this.thumbnailheight=120;this.maxDimension=160;this.mediaurl=null;this.filename=null;this.mediafilesize=null;this.width=null;this.height=null;this.duration=null;this.gping="";var m_durationString=null;var m_resolutionString=null;var m_fileSizeString=null;var c_picsearchThumbUrl="picsearch.com/is?";MediaProperties.prototype.initialize=function initialize(propertiesArray,callback){me=this;this.image=new Image();for(prop in propertiesArray){switch(prop){case "thumbnailurl":this.thumbnailurl=propertiesArray[prop];var idPos=propertiesArray[prop].indexOf(c_picsearchThumbUrl);if(idPos>0)this.mediahash=propertiesArray[prop].slice(idPos+c_picsearchThumbUrl.length);break;case "url":this.url=propertiesArray[prop];break;case "displayurl":this.displayurl=propertiesArray[prop];break;case "mediahash":case "imagehash":case "id":this.mediahash=propertiesArray[prop];break;case "mediaurl":case "imageurl":case "videourl":this.mediaurl=propertiesArray[prop];break;case "mediaformat":case "formats":this.mediaformat=propertiesArray[prop];break;case "mediafilesize":case "imagefilesize":case "filesize":this.rawfilesize=propertiesArray[prop];break;case "duration":case "runtime":this.duration=parseDurationString(propertiesArray[prop]);break;case "width":case "height":case "thumbnailwidth":case "thumbnailheight":case "motionthumbnailwidth":case "motionthumbnailheight":case "motionthumbfilesize":case "framebreaker":this[prop]=parseInt(propertiesArray[prop]);break;case "motionthumbnailurl":case "cclicensetype":case "cclicenseversion":case "cclicenseurl":case "dccreator":this[prop]=propertiesArray[prop];break;case "mmgping":case "gping":this.gping=propertiesArray[prop];break;case "title":break;default:}}if(!this.title){try{this.title=decodeURIComponent(this.mediaurl);}catch(e){this.title=unescape(this.mediaurl);}var i=this.title.lastIndexOf("/");if(i>=0)this.title=this.title.substr(i+1,this.title.length);}this.maxDimension=Math.max(this.thumbnailheight,this.thumbnailwidth);this._callback=callback;this._initialized=true;this.fetchurl=this.thumbnailurl;};this.bootstrapFromDOM=function bootstrapFromDOM(el,callback){this.mediahash=el.attributes["md5"].value;if(el.firstChild&&el.firstChild.firstChild&&el.firstChild.firstChild.firstChild)this.image=el.firstChild.firstChild.firstChild;if(!this.image)this.image=el.getElementsByTagName("img")[0];if(!this.image)return false;this.thumbnailurl=this.image.src;this.title=this.image.alt;this.url=el.attributes["purl"].value;this.displayurl=el.attributes["purl"].value;this.mediaurl=el.attributes["murl"].value;this.mediafilesize=el.attributes["fs"].value;this.width=parseInt(el.attributes["w"].value);this.height=parseInt(el.attributes["h"].value);this.thumbnailwidth=parseInt(el.attributes["tw"].value);this.thumbnailheight=parseInt(el.attributes["th"].value);this.gping=el.firstChild.attributes["mmgping"].value;this.fetching=false;this.loaded=true;this.cached=true;this.fetchurl=this.thumbnailurl;this._callback=callback;this._initialized=true;this.fetch();return true;};this.clone=function clone(){var clone=new MediaProperties();for(var i in this){clone[i]=this[i];}clone.image=new Image();clone.fetching=false;clone.loaded=false;clone.cached=false;return clone;};this.setFullImage=function setFullImage(val){if(val==false)this.fetchurl=this.thumbnailurl;else this.fetchurl=this.mediaurl;};MediaProperties.prototype.dispose=function dispose(){this.unload();this.image=null;this._callback=null;this._initialized=false;me=null;};MediaProperties.prototype.toString=function toString(){return "idx: "+this.imageIndex+", rnk: "+this.rank+", hash: "+this.mediahash+", title: "+this.title;};MediaProperties.prototype.restore=function restore(){this.image=new Image();};MediaProperties.prototype.getTitle=function getTitle(){if(!this.title){this.title=unescape(this.mediaurl);var i=this.title.lastIndexOf("/");if(i>=0)this.title=this.title.substr(i+1,this.title.length);}return this.title;};function parseFilesizeString(filesize){var str=filesize.match(/\d+/);var size=str[0];var str=filesize.match(/\D+/);if(!str)return size;else{if(str[0].search(/kb/i))size*=1000;else{if(str[0].search(/mb/i))size*=1000000;else{if(str[0].search(/gb/i))size*=1000000000;}}}return parseInt(size);}function parseDurationString(duration){var str=duration.match(/\d+/g);var dur=0;for(var i=0;i<str.length;i++){dur*=60;dur+=str[i];}return parseInt(dur);}this.getFileSizeString=function getFileSizeString(){if(!this.mediafilesize)this.mediafilesize=parseFilesizeString(this.rawfilesize);if(!m_fileSizeString){if(this.mediafilesize){var filesize=this.mediafilesize;if(filesize>1024){filesize=Math.floor(filesize/1024);if(filesize>1024){filesize=Math.floor(filesize/102.4)/10;m_fileSizeString=filesize+"MB";}else m_fileSizeString=filesize+"kB";}else m_fileSizeString=filesize+"kB";}else m_fileSizeString="n/a";}return m_fileSizeString;};this.getResolutionString=function getResolutionString(){if(!m_resolutionString){if(this.width&&this.height)m_resolutionString=this.width+"x"+this.height;else m_resolutionString="n/a";}return m_resolutionString;};this.getDurationString=function getDurationString(){if(!m_durationString){if(this.duration){var hh=Math.floor(this.duration/3600);var mm=Math.floor(this.duration%3600/60);var ss=this.duration%60;if(hh>0&&hh<10)hh="0"+hh;if(mm<10)mm="0"+mm;if(ss<10)ss="0"+ss;if(hh)m_durationString=hh+":"+mm+":"+ss;else m_durationString=mm+":"+ss;}else m_durationString="n/a";}return m_durationString;};this.setCallback=function setCallback(callback){this._callback=callback;};this.fetch=function fetch(){if(this.fetching||this.loaded)return;me=this;this.fetching=true;if(this.image){this.image.onload=function(e){if(!me)return;me.loaded=true;me.fetching=false;me._callback(me,true);};this.image.onerror=this.image.onabort=function(e){if(!me)return;if(me.loaded)return;me.fetching=false;me._callback(me,false);};this.image.src=this.fetchurl;}else{if(me)me.fetching=false;}};MediaProperties.prototype.unload=function unload(){if(this.loaded)this.cached=true;if(this.fetching||this.loaded){if(this.image)this.image.onload=this.image.onerror=this.image.onabort=null;this.loaded=false;this.fetching=false;}};};QueryParameters=function(){var me=this;var m_parameters=Array();this.dispose=function dispose(){for(var p in m_parameters){delete m_parameters[p];}m_parameters=null;for(var prop in me){delete me[prop];}me=null;};this.getParameter=function getParameter(name){return m_parameters[name];};this.setParameter=function setParameter(name,value){m_parameters[name]=value;};this.populateFromState=function populateFromState(state){m_parameters["queryString"]=MMUtil.truncateQuery(state.q);m_parameters["imagesize"]=state.imagesize;m_parameters["market"]=MMUtil.market;m_parameters["adlt"]=state.adlt;};this.equals=function equals(queryParameters){for(var prop in m_parameters){if(queryParameters.getParameter(prop)!=me.getParameter(prop))return false;}return true;};this.getFullQueryString=function getFullQueryString(){return m_parameters["queryString"];};this.getSizeFilter=function getSizeFilter(){return m_parameters.imagesize;};this.getDisplayQuery=function getDisplayQuery(annotate){var displayQuery=me.getParameter("queryString");if(annotate){if(m_parameters.imagesize&&m_parameters.imagesize!="all"){displayQuery+=" (";if(m_parameters.imagesize=="desktop")displayQuery+=screen.width+"x"+screen.height;else switch(m_parameters.imagesize){case "small":displayQuery+=L_smallImages_Text;break;case "medium":displayQuery+=L_mediumImages_Text;break;case "large":displayQuery+=L_largeImages_Text;break;default:displayQuery+=m_parameters.imagesize;break;}displayQuery+=")";}}return displayQuery;};};XMLRequest=function(){var xmlHttp;this.execute=function execute(url,callback,context){if(window.XMLHttpRequest)xmlHttp=new XMLHttpRequest();else{if(window.ActiveXObject)xmlHttp=new ActiveXObject("Microsoft.XMLHTTP");else xmlHttp=null;}if(xmlHttp){function readyStateChange(){if(xmlHttp.readyState==4){if(xmlHttp.responseText!=""&&xmlHttp.responseXML.childNodes.length==0){var xmldom=new ActiveXObject("Microsoft.XMLDOM");xmldom.async="false";xmldom.loadXML(xmlHttp.responseText);callback({"responseXML":xmldom},context);}else callback(xmlHttp,context);}}xmlHttp.onreadystatechange=readyStateChange;try{xmlHttp.open("GET",url,true);}catch(e){throw e;}xmlHttp.send(null);}};this.abort=function abort(){if(xmlHttp)xmlHttp.abort();};this.dispose=function dispose(){this.abort();xmlHttp=null;};};function MultimediaQuery(queryParameters){var me=this;this.queryRequest=null;this.parameters=queryParameters;this.results=[];this.rankMapping=null;this.hashMapping=new Object();var m_fetchInterval=null;this.nThumbsFetching=0;var c_maxFetching=10;var c_maxXmlRetries=3;this.xmlRetriesRemaining=c_maxXmlRetries;var c_maxResults=1000;this.moreResults=true;this.available=1000;this.totalResults=0;this.deactivated=0;this.nUsedContainers=0;this.maxAssignedRank=null;this.resultsRequested=0;var m_firstResultNeeded=0;var m_lastResultNeeded=0;this.resultsReceived=0;var m_bufferSize=30;var m_paused=false;this.fetchInterval=null;var m_batchSize=MMFEXParams.batchSize;if(!MMUtil.isLiveMarket)m_batchSize=20;var m_currentBatchSize=0;this.initialize=function initialize(xmlCallback,imageCallback,containerCallback){this.xmlCallback=xmlCallback;this.imageCallback=imageCallback;this.containerCallback=containerCallback;this.rankMapping=new Object();this.clearStagingArea();};this.dispose=function dispose(){this.parameters.dispose();if(this.fetchInterval)clearInterval(this.fetchInterval);this.fetchInterval=null;if(this.queryRequest)this.queryRequest.dispose();this.queryRequest=null;while(this.results.length){this.results.shift().dispose();}this.xmlCallback=null;this.imageCallback=null;this.containerCallback=null;me=null;};this.clearStagingArea=function clearStagingArea(){var rp=document.getElementById("relatedPeople_list");MMUtil.names=[];if(rp)for(var i=0;i<rp.childNodes.length;i++){MMUtil.names.push(rp.childNodes[i].id);}var stagingArea=document.getElementById("staging");if(!stagingArea||!stagingArea.firstChild)return;this.resultsRequested=m_batchSize;this.totalResults=stagingArea.attributes["total"].value;while(stagingArea.firstChild){var properties=new MediaProperties();if(!properties.bootstrapFromDOM(stagingArea.firstChild,this.receiveImage)){stagingArea.removeChild(stagingArea.firstChild);properties.unload();continue;}this.resultsReceived++;this.hashMapping[properties.mediahash]=this.results.length;properties.index=this.results.length;this.results.push(properties);this.createResultItem(properties);}};this.receiveImage=function receiveImage(info,success){me.nThumbsFetching--;if(!success)me.processInvalid(info);else me.getImage(info.rank).thumbLoadCallback();me.fetch();};this.getImage=function getImage(rank){var info=this.results[this.rankMapping[rank]];if(info!=null)return MMUtil.resultItems[info.imageIndex];else return null;};this.getImageFromHash=function getImageFromHash(hash){var infoIndex=this.hashMapping[hash];if(infoIndex==null)return null;var properties=this.results[infoIndex];if(!properties)return null;return this.getImage(properties.rank);};this.updateTotalResults=function updateTotalResults(totalResults,avialable){if(totalResults>this.totalResults)this.totalResults=totalResults;if(this.totalResults<this.available)this.available=this.totalResults;if(!this.moreResults)this.available=this.results.length-this.deactivated;};this.deactivateImage=function deactivateImage(properties){if(properties.deactivated==true)return;MMUtil.resultItems[properties.imageIndex].unsetMediaItem();properties.dispose();properties.deactivated=true;this.deactivated++;var index=properties.index;var rank=properties.rank;properties.rank=null;while(this.results[index+1]){index++;var fix=this.results[index];if(fix.rank==null)continue;fix.rank=rank;this.rankMapping[fix.rank]=fix.index;this.imageCallback(fix,this);rank++;}this.maxAssignedRank=rank-1;this.updateTotalResults();};this.processInvalid=function processInvalid(properties){if(!properties.retry){properties.retry=true;this.unloadImage(properties);}else this.deactivateImage(properties);};this.createResultItem=function createResultItem(properties){if(this.maxAssignedRank==null)properties.rank=0;else properties.rank=this.maxAssignedRank+1;this.maxAssignedRank=properties.rank;properties.imageIndex=this.nUsedContainers;this.nUsedContainers++;this.rankMapping[properties.rank]=properties.index;this.containerCallback(properties,this);};this.unloadImage=function unloadImage(properties){properties.unload();};this.fetchSingleImage=function fetchSingleImage(properties){if(properties&&properties._initialized){this.nThumbsFetching++;properties.fetch();}};this.fetch=function fetch(){if(m_paused||m_fetchInterval!=null)return;function fetchCallback(){if(m_paused){clearInterval(m_fetchInterval);m_fetchInterval=null;return;}if(MMUtil.getState()._scrolling==true){if(!me.queryRequest&&me.moreResults&&me.resultsRequested<m_lastResultNeeded+m_bufferSize){me.requestResultsXML();return;}}if(me.nThumbsFetching>=c_maxFetching){clearInterval(m_fetchInterval);m_fetchInterval=null;return;}var unloaded=[];var unloadedCount=0;var result=null;for(var rank=m_firstResultNeeded;rank<m_lastResultNeeded&&rank<me.resultsReceived;rank++){result=me.results[rank];if(result&&!result.loaded&&!result.fetching){unloaded.push(rank);unloadedCount++;}}if(unloadedCount>0){var index=Math.round(Math.random()*(unloadedCount-1));var rank=unloaded[index];me.fetchSingleImage(me.results[rank]);return;}if(!me.queryRequest&&me.moreResults&&me.resultsRequested<m_lastResultNeeded+m_bufferSize){me.requestResultsXML();return;}var start=m_firstResultNeeded-m_bufferSize;start=start<0?0:start;var end=m_lastResultNeeded+m_bufferSize;end=end>=me.resultsReceived?me.resultsReceived-1:end;for(var rank=start;rank<end;rank++){result=me.results[rank];if(result&&!result.loaded&&!result.fetching){unloaded.push(rank);unloadedCount++;}}if(unloadedCount>0&&me.nThumbsFetching<c_maxFetching){var index=Math.round(Math.random()*(unloadedCount-1));var rank=unloaded[index];me.fetchSingleImage(me.results[rank]);return;}clearInterval(m_fetchInterval);m_fetchInterval=null;}m_fetchInterval=setInterval(fetchCallback,5);};this.loadImages=function loadImages(first,last,buffer){m_paused=false;if(buffer)m_bufferSize=buffer;m_firstResultNeeded=first;m_lastResultNeeded=last;this.fetch();};function receiveXml(xml,query){var firstRequest=query.resultsReceived==0?true:false;query.processResultXML(xml);query.fetch();if(firstRequest)query.xmlCallback(query);query.queryRequest.dispose();query.queryRequest=null;}this.injectResult=function injectResult(properties){this.hashMapping[properties.mediahash]=this.results.length;properties.index=this.results.length;this.results.push(properties);this.createResultItem(properties);this.fetch();};this.createRequest=function createRequest(props){var properties=new MediaProperties();properties.initialize(props,this.receiveImage);this.hashMapping[properties.mediahash]=this.results.length;properties.index=this.results.length;this.results.push(properties);this.createResultItem(properties);return properties;};this.requestResultsXML=function requestResultsXML(){if(this.moreResults&&!this.queryRequest){this.queryRequest=new XMLRequest();try{m_currentBatchSize=m_batchSize;if(this.resultsRequested+m_batchSize>=c_maxResults&&!MMUtil.isLiveMarket){m_currentBatchSize=c_maxResults-this.resultsRequested-1;this.moreResults=false;}var url=MMUtil.getXMLUrl(this.parameters.getFullQueryString(),this.parameters.getSizeFilter(),this.resultsRequested+1,m_currentBatchSize,this.parameters.getParameter("adlt"));url+="&retries="+this.xmlRetriesRemaining;this.resultsRequested+=m_currentBatchSize;this.queryRequest.execute(url,receiveXml,this);}catch(e){this.error=true;this.xmlCallback(this);if(this.queryRequest)this.queryRequest.dispose();this.queryRequest=null;}}};this.processResultXML=function processResultXML(xml){var parsed=MultimediaQuery.parseXML(xml);if(parsed.error){this.error=parsed.error;if(parsed.error=="AdultBlock"||parsed.error=="InvalidQuery"){this.moreResults=false;this.updateTotalResults(parsed.total,parsed.retrievable);return;}else{if(parsed.error=="Federator"){if(this.xmlRetriesRemaining<=0)this.moreResults=false;else{this.resultsRequested-=m_currentBatchSize;this.xmlRetriesRemaining--;}return;}}}this.xmlRetriesRemaining=this.c_maxXmlRetries;this.spellSuggestion=parsed.spellSuggestion;imageSearch.setSpellSuggestion();imageSearch.updatePage();var oldCount=this.results.length;this.resultsReceived+=parsed.length;while(parsed.length){var props=parsed.shift();if(this.hashMapping[props.imagehash]!=null)continue;var mediaProperties=this.createRequest(props);}if(this.results.length==oldCount)this.moreResults=false;if(!MMUtil.names)MMUtil.names=parsed.names;this.updateTotalResults(parsed.total,parsed.retrievable);};}MultimediaQuery.parseLiveXML=function parseLiveXML(x,ver){var results=[];var errors=x.getElementsByTagName("error");if(errors.length)throw MMUtil.getXMLNodeText(errors[0]);var queries=x.getElementsByTagName("query");if(!queries.length)throw "Federator";var fed;var feds=x.getElementsByTagName("documentset");for(var f=0;f<feds.length;f++){fed=feds[f];if(fed.getAttribute("source")=="FEDERATOR_MULTIMEDIA")break;}if(!fed||fed.getAttribute("source")!="FEDERATOR_MULTIMEDIA")for(var f=0;f<feds.length;f++){fed=feds[f];if(fed.getAttribute("source")=="FEDERATOR_MONARCH")break;}if(!fed||fed.getAttribute("source")!="FEDERATOR_MULTIMEDIA"&&fed.getAttribute("source")!="FEDERATOR_MONARCH")for(var f=0;f<feds.length;f++){fed=feds[f];if(fed.getAttribute("source")=="FEDERATOR_PICSEARCH")break;}if(!fed||fed.getAttribute("source")!="FEDERATOR_MONARCH"&&fed.getAttribute("source")!="FEDERATOR_MULTIMEDIA"&&fed.getAttribute("source")!="FEDERATOR_PICSEARCH"){if(MMUtil.getXMLNodeText(queries[0])=="")throw "InvalidQuery";else throw "Federator";}results.total=fed.getAttribute("total");results.retrievable=fed.getAttribute("retrievable");if(results.retrievable=="")results.retrievable=0;var documents=fed.getElementsByTagName("document");if(ver=="1.0")for(var i=0;i<documents.length;i++){var props={};var children=documents[i].childNodes;var nChildren=children.length;for(var a=0;a<nChildren;a++){var child=children[a];props[child.nodeName]=MMUtil.getXMLNodeText(child);}results.push(props);}else for(var i=0;i<documents.length;i++){var props={};var children=documents[i].childNodes;var nChildren=children.length;for(var a=0;a<nChildren;a++){var child=children[a];if(child.nodeName=="thumbnail"){if(child.getElementsByTagName("format")[0].childNodes[0].nodeValue=="image/jpeg"&&props["thumbnailurl"]==null){var nThumbChildren=child.childNodes.length;for(var b=0;b<nThumbChildren;b++){var thumbChild=child.childNodes[b];props["thumbnail"+thumbChild.nodeName]=MMUtil.getXMLNodeText(thumbChild);}}else{if(child.getElementsByTagName("format")[0].childNodes[0].nodeValue=="video/x-ms-wmv"&&props["motionthumbnailurl"]==null){var nThumbChildren=child.childNodes.length;for(var b=0;b<nThumbChildren;b++){var thumbChild=child.childNodes[b];props["motionthumbnail"+thumbChild.nodeName]=MMUtil.getXMLNodeText(thumbChild);}}}}else props[child.nodeName]=MMUtil.getXMLNodeText(child);}results.push(props);}results.names=[];var namesSection=x.getElementsByTagName("relatednames");if(namesSection[0]){var names=namesSection[0].getElementsByTagName("name");for(var i=0;i<names.length;i++){results.names.push(MMUtil.getXMLNodeText(names[i]));}}var spell=x.getElementsByTagName("speller");if(!spell.length)spell=x.getElementsByTagName("PinYin");if(spell.length)results.spellSuggestion=MMUtil.getXMLNodeText(spell[0].firstChild);return results;};MultimediaQuery.parseXML=function parseXML(xml){var x=xml.responseXML;var results=null;var formatIdentified=false;try{if(!x.lastChild)throw "Federator";for(var node=0;node<x.childNodes.length;node++){if(x.childNodes[node].nodeName=="searchresult"){results=MultimediaQuery.parseLiveXML(x,x.childNodes[node].getAttribute("version"));formatIdentified=true;break;}}if(!formatIdentified)results=MultimediaQuery.parseLiveXML(x,"1.0");}catch(e){results=[];MMUtil.record("MultimediaQuery","xmlerror",e);results.error=e;results.retrieveable=0;results.total=0;}return results;};

// Static content
var L_imagePageTitle_Text = "Live Search Images";       // Page title for image search page 
var L_videoPageTitle_Text = "Live Search Vidéo";       // Page title for video search page

// Status messages
var L_loadingResults_Message = "Chargement des résultats en cours pour la requête %querystring%.";      // %querystring% is placeholder for the user-entered query. This message is displayed while the results are being fetched.
var L_noResults_Message = "Aucun résultat pour %querystring%.";      // %querystring% is placeholder for the user-entered query. This message is displayed if there are no results for the query
var L_adultBlock1_Message = "Ces résultats de recherche peuvent correspondre à du contenu pour adultes. "; // This message is displayed if the query is blocked by adult filtering part1
var L_adultBlock2_Message = "Pour afficher ces images, désactivez la %startlink%recherche sécurisée%endlink%."; // This message is displayed if the query is blocked by adult filtering part2
var L_adultBlockStrict_Message = "Les résultats obtenus pour %querystring% ont été bloqués par le filtre de recherche sécurisée. Pour continuer, modifiez votre requête."; // Adult block message for strict markets
var L_siteUnavailable_Message = "Le site est temporairement indisponible. Réessayez plus tard."; // Displayed if the UI cannot access the server
var L_queryTooLong_Message = "La requête que vous avez entrée est trop longue. Essayez avec une requête plus courte.";
var L_welcomeImage_Message = "Bienvenue dans Live Search Images !";          // Message displayed when user opens image search page with no query string
var L_welcomeVideo_Message = "Bienvenue dans Live Search Vidéo !";          // Message displayed when user opens video search page with no query string
var L_spellingSuggestion_Message = "Recherchiez-vous %string% ?";           // Message suggests alternate spelling of query terms

// Media Player messages
var L_wmpLoading_Message = "Chargement en cours";                          // Displayed while the windows media player control is loading

// Context
var L_loadingImages_Message = "Chargement des images...";                // Displayed when more image results are being fetched from the server
var L_loadingVideos_Message = "Chargement des vidéos...";                // Displayed when more video results are being fetched from the server
var L_contextImage_Text = "%first%-%last% sur %total%"; // Reports which image search results are currently visible in the browser window
var L_contextVideo_Text = "%first%-%last% sur %total%"; // Reports which video search results are currently visible in the browser window
var L_safeCurrStatusOn_Message = "Recherche sécurisée - Strict";      // Shows that the current state of adult fitering is strict
var L_safeCurrStatusMod_Message = "Recherche sécurisée en mode Modéré";   // Shows that the current state of adult fitering is moderate
var L_safeCurrStatusOff_Message = "Recherche sécurisée désactivée";        // Shows that the current state of adult fitering is off

// Result View
var L_frameImageA_Message = "Si vous affichez cette page, vous risquez d'être obligé de quitter Live Search Images."; // Displayed if the contents of the source page frame will replace the contents of the parent frame (first part of message)
var L_frameVideoA_Message = "Si vous affichez cette page, vous risquez d'être obligé de quitter Live Search Vidéo."; // Displayed if the contents of the source page frame will replace the contents of the parent frame (first part of message)
var L_frameB_Message = "Pour éviter cela, ouvrez la page dans une nouvelle fenêtre.";          // Displayed if the contents of the source page frame will replace the contents of the parent frame (second part of message)
var L_pageUnavailableA_Message = "Impossible de charger cette page.";                 // Displayed if the browser cannot load the source page (first part of message)
var L_pageUnavailableB_Message = "Son indisponibilité peut être temporaire ou permanente.";  // Displayed if the browser cannot load the source page (second part of message)
var L_mediaUnavailableImageA_Message = "Impossible de charger cette image.";          // Displayed if the browser cannot load the full image (first part of message)
var L_mediaUnavailableVideoA_Message = "Impossible de charger cette vidéo.";          // Displayed if the browser cannot load the video (first part of message)
var L_mediaUnavailableB_Message = "Son indisponibilité peut être temporaire ou permanente."; // Displayed if the browser cannot load the media (second part of message)
var L_pageUrl_Text = "Accéder à la page :";                   // Shows the URL of the page that the media came from
var L_imageUrl_Text = "URL de l'image :";                   // Shows the URL of the image file
var L_videoUrl_Text = "URL de la vidéo :";                   // Shows the URL of the video file
var L_showImage_Text = "Afficher l'image";                  // Button label to show the full-size image
var L_hideImage_Text = "Masquer l'image";                  // Button label to hide the full-size image
var L_backToResults_Text = "Retour aux résultats";         // Button label to return to search results
var L_openNewWindow_Text = "Afficher dans une nouvelle fenêtre";    // Button label to open the current result in a new browser window
var L_openHere_Text = "Afficher ici";                    // Button label to open the current result in the current browser window
var L_retryNewWindow_Text = "Réessayer dans une nouvelle fenêtre";  // Button label to open the current result in new browser window
var L_closeResultView_Text = "fermer";                 // Button label to close the result view and return to search results
var L_copyright_Text = "Les images sont réduites et peuvent être protégées par copyright"; // Copyright disclaimer for image search

// Full image
var L_emailResult_Text = "envoyer ce résultat par courrier électronique";         // Button label to email a single result
var L_openImage_Text = "ouvrir l'image";                  // Button label to open the image in the current browser window
var L_imageUnavailable_Message = "Cette image est actuellement indisponible."; // Shown if the brower cannot download the full image
var L_closeFullImage_Text = "fermer";                  // Button lable to close the full image display

// Email this result
var L_emailSubject_Text = "Résultat Live Search Images pour la requête %query%"; // Subject line of the email
var L_emailSubjectFilename_Text = "Résultat Live Search Images pour le fichier %query%"; // Subject line of the email
var L_emailLinkResult_Text = "lien vers le résultat :";                         // Permalink to the result in image search
var L_emailLinkImage_Text = "lien vers l'image :";                           // Link to the source media
var L_emailSourcePage_Text = "lien vers la page source :";                    // Link to the page containing the media

// Meta-display
var L_feedbackResult_Text = "commentaires sur ce résultat"; // Button label to send feedback about a search result
var L_feedbackImage_Text = "commentaires sur cette image";  // Button label to send feedback about an image search result
var L_feedbackVideo_Text = "commentaires sur cette vidéo";  // Button label to send feedback about a video search result
var L_openResult_Text = "ouvrir ce résultat";           // Button label to open a result in the current window
var L_addToScratchpad_Text = "ajouter au Bloc-notes";     // Button label to add a search result to the scratchpad
var L_duration_Text = "durée :";                    // Shows the duration of a video clip
var L_dimensions_Text = "dimensions :";                // Shows the dimensions/resolution of an image or video (in pixels)
var L_filesize_Text = "taille du fichier :";                   // Shows the size of the image or video file

// Slider
var L_increaseLOD_Text = "zoom avant";                   // Button label to increase the level of detail
var L_decreaseLOD_Text = "zoom arrière";                  // Button label to decrease the level of detail
var L_changeLOD_Text = "niveau de zoom";                  // Label for level of detail
var L_currLOD_Text = "niveau de zoom %level%";            // Report current level of detail
var L_scrollUp_Text = "défilement vers le haut";                    // Label for scroll bar up button
var L_scrollDown_Text = "défilement vers le bas";                // Label for scroll bar down button
var L_scroll_Text = "défilement";                         // Label for scroll bar handle

// Image size
var L_allImageSizes_Text = "Toutes les tailles d'images";         // Label for all images in size filtering
var L_myDesktopSize_Text = "La taille de mon écran";         // Label for my desktop size in size filtering
var L_smallImages_Text = "Petites";                     // Label for small images in size filtering
var L_mediumImages_Text = "Moyennes";                   // Label for mediuam images in size filtering
var L_largeImages_Text = "Grandes";                     // Label for large images in size filtering
var L_showingDesktopSize_Text = "Seules les images de la taille de votre écran sont affichées.";  // Message when desktop size filter is in use
var L_showingSmallImages_Text = "Seules les petites images sont affichées.";                 // Message when small size filter is in use
var L_showingMediumImages_Text = "Seules les images moyennes sont affichées.";         // Message when medium size filter is in use
var L_showingLargeImages_Text = "Seules les grandes images sont affichées.";                 // Message when large size filter is in use
var L_showingCustomSizeImages_Text = "Seules les images de %resolution% sont affichées.";     // Message when specific resolution filter is in use (eg. 800x600)
var L_noDesktopSizeResults_Message = "Nous n'avons trouvé aucune image de la taille de votre écran pour %querystring%."; // No results message
var L_noSmallImageResults_Message = "Nous n'avons trouvé aucune petite image pour %querystring%.";                 // No results message
var L_noMediumImageResults_Message = "Nous n'avons trouvé aucune image moyenne pour %querystring%.";         // No results message
var L_noLargeImageResults_Message = "Nous n'avons trouvé aucune grande image pour %querystring%.";                 // No results message
var L_noCustomSizeImageResults_Message = "Nous n'avons trouvé aucune image de %resolution% pour %querystring%.";     // No results message for specific resolution (eg. 800x600)
var L_showAllSizes_Text = "Afficher les images %startlink%de toute taille%endlink%";     // Link to show all image sizes

// Scratchpad
var L_scratchpadTitle_Text = "Bloc-notes";                                            // Title for scratchpad UI element
var L_scratchpadShow_Text = "Bloc-notes";                                             // Button that shows the scratchpad
var L_scratchpadHide_Text = "Masquer le Bloc-notes";                                        // Button that hides the scratchpad
var L_scratchpadNewCollectionButton_Text = "Nouvelle collection";                          // Button that adds a collection to the scratchpad
var L_tooManyItems_Message = "Votre Bloc-notes peut contenir %count% images. Supprimez une image avant d'en ajouter une autre.";          // Message when the scrathpad is full of images
var L_tooManyItemsMultiCollection_Message = "Votre Bloc-notes peut contenir %count% images. Supprimez une image ou une collection existante.";        // Message when the scrathpad is full of images
var L_tooManyCollections_Message = "Votre Bloc-notes peut contenir %count% collections. Supprimez une collection avant d'en ajouter une autre."; // Message when scrathpad is full of collections
var L_defaultCollection_Text = "Ma collection";                                       // Name for default scratchpad collection
var L_scratchpadHelp_Text = "Glissez-déplacez des éléments ici pour créer une nouvelle collection Bloc-notes."; // Text to explain how to add to empty scratchpad
var L_scratchpadCollectionHelp_Text = "Glissez-déplacez des éléments ici pour les ajouter à cette collection.";   // Text to explain how to add to empty collection
var L_rename_Text = "renommer";                                                         // Link to rename a collection

// Related People
var L_relatedPeopleTitle_Text = "Personnes";                                     // Title for scratchpad Related People element

// Adult UI
var L_AdultMSInternal_Text = "À usage interne Microsoft";                                            // Adult MS Internal Message
var L_AdultMSInternalExplanation_Text = "Cette boîte de dialogue permet aux employés de Microsoft de fournir des commentaires confidentiels sur le contenu pour adultes trouvé sur Live Search Images. Pour désactiver cette fonctionnalité, cliquez"; // Adult UI explanation message
var L_AdultClickHere_Text = "ici";                                                           // Button text saying click here
var L_AdultReenableMessage_Text = ". Vous pouvez réactiver cette fonctionnalité en supprimant votre cookie."; // Reenable UI directions
var L_AdultMarkButton_Text = "marquer";                                                          // Mark text
var L_AdultAsAdult_Text = "pour adulte";                                                         // As Adult text
var L_AdultMurlCheckImage_Text = "image";                                                     // Image checkbox text
var L_AdultMurlCheckPage_Text = "page";                                                       // Page checkbox text
var L_AdultMurlCheckDomain_Text = "domaine";                                                   // Domain checkbox text

var L_optionsLink_Text = "Options";                   // Link text to search wide settings page

var searchDiv = document.getElementById ("imageSearch");
var imageSearch = new ImageSearch (searchDiv);
imageSearch.initialize();

